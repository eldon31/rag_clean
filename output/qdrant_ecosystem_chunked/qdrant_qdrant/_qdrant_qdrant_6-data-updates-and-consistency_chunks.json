[
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:0",
    "content": "Data Updates and Consistency | qdrant/qdrant | DeepWiki\n\n[Index your code with Devin](private-repo.md)\n\n[DeepWiki](https://deepwiki.com)\n\n[DeepWiki](.md)\n\n[qdrant/qdrant](https://github.com/qdrant/qdrant \"Open repository\")\n\n[Index your code with](private-repo.md)\n\n[Devin](private-repo.md)\n\nShare\n\nLast indexed: 4 October 2025 ([48203e](https://github.com/qdrant/qdrant/commits/48203e41))\n\n- [Introduction to Qdrant](qdrant/qdrant/1-introduction-to-qdrant.md)\n- [Key Concepts and Terminology](qdrant/qdrant/1.1-key-concepts-and-terminology.md)\n- [System Architecture](qdrant/qdrant/2-system-architecture.md)\n- [Application Initialization and Runtime](qdrant/qdrant/2.1-application-initialization-and-runtime.md)\n- [Collections and Table of Content](qdrant/qdrant/2.2-collections-and-table-of-content.md)\n- [Shards and Replica Sets](qdrant/qdrant/2.3-shards-and-replica-sets.md)\n- [Local Shard Architecture](qdrant/qdrant/2.4-local-shard-architecture.md)\n- [Segment Lifecycle and Construction](qdrant/qdrant/2.",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 0,
      "token_count": 314,
      "char_count": 1009,
      "start_char": 0,
      "end_char": 1009
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:1",
    "content": "rant/qdrant/2.4-local-shard-architecture.md)\n- [Segment Lifecycle and Construction](qdrant/qdrant/2.5-segment-lifecycle-and-construction.md)\n- [Vector Storage and Indexing](qdrant/qdrant/3-vector-storage-and-indexing.md)\n- [Vector Storage Formats](qdrant/qdrant/3.1-vector-storage-formats.md)\n- [HNSW Index Implementation](qdrant/qdrant/3.2-hnsw-index-implementation.md)\n- [Vector Quantization](qdrant/qdrant/3.3-vector-quantization.md)\n- [Sparse Vector Indexing](qdrant/qdrant/3.4-sparse-vector-indexing.md)\n- [Payload Indexing and Filtering](qdrant/qdrant/4-payload-indexing-and-filtering.md)\n- [Field Index Types](qdrant/qdrant/4.1-field-index-types.md)\n- [Index Selection and Storage Backends](qdrant/qdrant/4.2-index-selection-and-storage-backends.md)\n- [Search and Query Processing](qdrant/qdrant/5-search-and-query-processing.md)\n- [Query Request Flow](qdrant/qdrant/5.1-query-request-flow.md)\n- [Filtering and Scoring](qdrant/qdrant/5.2-filtering-and-scoring.md)",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 1,
      "token_count": 298,
      "char_count": 970,
      "start_char": 909,
      "end_char": 1880
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:2",
    "content": "nt/5.1-query-request-flow.md)\n- [Filtering and Scoring](qdrant/qdrant/5.2-filtering-and-scoring.md)\n- [Data Updates and Consistency](qdrant/qdrant/6-data-updates-and-consistency.md)\n- [Update Processing Pipeline](qdrant/qdrant/6.1-update-processing-pipeline.md)\n- [Write Consistency and Replication](qdrant/qdrant/6.2-write-consistency-and-replication.md)\n- [Distributed System Features](qdrant/qdrant/7-distributed-system-features.md)\n- [Raft Consensus Protocol](qdrant/qdrant/7.1-raft-consensus-protocol.md)\n- [Shard Transfers and Resharding](qdrant/qdrant/7.2-shard-transfers-and-resharding.md)\n- [Snapshots and Recovery](qdrant/qdrant/8-snapshots-and-recovery.md)\n- [API Reference](qdrant/qdrant/9-api-reference.md)\n- [REST API Endpoints](qdrant/qdrant/9.1-rest-api-endpoints.md)\n- [gRPC API Services](qdrant/qdrant/9.2-grpc-api-services.md)\n- [Data Types and Conversions](qdrant/qdrant/9.3-data-types-and-conversions.md)\n- [Configuration and Deployment](qdrant/qdrant/10-configuration-and-deployment.md)",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 2,
      "token_count": 321,
      "char_count": 1008,
      "start_char": 1780,
      "end_char": 2789
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:3",
    "content": "-conversions.md)\n- [Configuration and Deployment](qdrant/qdrant/10-configuration-and-deployment.md)\n- [Configuration System](qdrant/qdrant/10.1-configuration-system.md)\n- [Docker Deployment](qdrant/qdrant/10.2-docker-deployment.md)\n- [Building and CI/CD](qdrant/qdrant/10.3-building-and-cicd.md)\n- [Development Guide](qdrant/qdrant/11-development-guide.md)\n\nMenu\n\n# Data Updates and Consistency\n\nRelevant source files\n\n- [lib/collection/src/collection/collection\\_ops.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/collection/collection_ops.rs)\n- [lib/collection/src/collection/mod.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/collection/mod.rs)\n- [lib/collection/src/collection/shard\\_transfer.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/collection/shard_transfer.rs)\n- [lib/collection/src/collection/sharding\\_keys.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/collection/sharding_keys.rs)",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 3,
      "token_count": 303,
      "char_count": 989,
      "start_char": 2689,
      "end_char": 3679
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:4",
    "content": ".rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/collection/sharding_keys.rs)\n- [lib/collection/src/collection\\_manager/collection\\_updater.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/collection_manager/collection_updater.rs)\n- [lib/collection/src/shards/local\\_shard/mod.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/local_shard/mod.rs)\n- [lib/collection/src/shards/local\\_shard/scroll.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/local_shard/scroll.rs)\n- [lib/collection/src/shards/local\\_shard/snapshot.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/local_shard/snapshot.rs)\n- [lib/collection/src/shards/local\\_shard/snapshot\\_tests.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/local_shard/snapshot_tests.rs)\n- [lib/collection/src/shards/replica\\_set/mod.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/replica_set/mod.",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 4,
      "token_count": 328,
      "char_count": 1024,
      "start_char": 3579,
      "end_char": 4603
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:5",
    "content": "et/mod.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/replica_set/mod.rs)\n- [lib/collection/src/shards/replica\\_set/update.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/replica_set/update.rs)\n- [lib/collection/src/update\\_handler.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/update_handler.rs)\n- [lib/storage/src/content\\_manager/toc/collection\\_meta\\_ops.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/storage/src/content_manager/toc/collection_meta_ops.rs)\n\nThis page describes how Qdrant handles data updates and maintains consistency across replicas. It covers the write path architecture, durability guarantees through Write-Ahead Logs, logical clock-based consistency mechanisms, and the interaction between update handlers, segments, and replicas.\n\nFor detailed information about the update processing pipeline (WAL persistence, segment updates, optimization triggers), see [Update Processing Pipeline](qdrant/qdrant/6.",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 5,
      "token_count": 259,
      "char_count": 1020,
      "start_char": 4503,
      "end_char": 5523
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:6",
    "content": "sistence, segment updates, optimization triggers), see [Update Processing Pipeline](qdrant/qdrant/6.1-update-processing-pipeline.md). For write consistency levels, replica coordination, and failure handling mechanisms, see [Write Consistency and Replication](qdrant/qdrant/6.2-write-consistency-and-replication.md).\n\nFor information about the search and query flow, see [Search and Query Processing](qdrant/qdrant/5-search-and-query-processing.md).\n\n---\n\n## Write Path Overview\n\nWhen a client submits an update operation (upsert, delete, set payload, etc.), it flows through multiple layers of the system before being persisted to disk. The system provides configurable consistency guarantees and handles replica coordination, failure detection, and automatic recovery.\n\n### High-Level Write Flow\n\n```\n```\n\n**Sources:** [lib/collection/src/shards/replica\\_set/update.rs24-251](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/replica_set/update.",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 6,
      "token_count": 224,
      "char_count": 969,
      "start_char": 5423,
      "end_char": 6392
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:7",
    "content": "24-251](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/replica_set/update.rs#L24-L251) [lib/collection/src/shards/local\\_shard/mod.rs84-124](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/local_shard/mod.rs#L84-L124)\n\n---\n\n## Write-Ahead Log (WAL)\n\nThe Write-Ahead Log ensures durability and enables crash recovery. All update operations are written to the WAL before being applied to in-memory segments, guaranteeing that no acknowledged writes are lost.\n\n### WAL Architecture\n\nThe `RecoverableWal` wrapper extends the basic WAL with clock tracking for consistency:\n\n```\n```\n\n**Key Components:**\n\n| Component       | Type                                          | Purpose                                 |\n| --------------- | --------------------------------------------- | --------------------------------------- |\n| `wal`           | `Arc<Mutex<SerdeWal<OperationWithClockTag>>>` | Underlying WAL implementation           |",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 7,
      "token_count": 233,
      "char_count": 979,
      "start_char": 6292,
      "end_char": 7272
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:8",
    "content": "| `Arc<Mutex<SerdeWal<OperationWithClockTag>>>` | Underlying WAL implementation           |\n| `newest_clocks` | `Arc<Mutex<ClockMap>>`                        | Highest clock values seen for each peer |\n| `oldest_clocks` | `Arc<Mutex<ClockMap>>`                        | Cutoff clocks for recovery              |\n\n**Sources:** [lib/collection/src/wal\\_delta.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/wal_delta.rs) (referenced), [lib/collection/src/shards/local\\_shard/mod.rs95](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/local_shard/mod.rs#L95-L95)\n\n### WAL Recovery\n\nOn shard startup, the WAL is replayed to restore the state:\n\n```\n```\n\n**Sources:** [lib/collection/src/shards/local\\_shard/mod.rs618-736](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/local_shard/mod.rs#L618-L736)\n\n---\n\n## Logical Clocks and Consistency\n\nQdrant uses logical clocks (Lamport-style) to establish a partial ordering of operations across replicas.",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 8,
      "token_count": 296,
      "char_count": 1012,
      "start_char": 7172,
      "end_char": 8192
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:9",
    "content": "t uses logical clocks (Lamport-style) to establish a partial ordering of operations across replicas. This enables detection of stale operations and ensures convergence without requiring synchronized physical clocks.\n\n### Clock Tag Structure\n\nEvery update operation is tagged with a `ClockTag`:\n\n| Field        | Type     | Description                                    |\n| ------------ | -------- | ---------------------------------------------- |\n| `peer_id`    | `PeerId` | ID of the peer that created this clock tick    |\n| `clock_id`   | `u32`    | Identifies the specific clock instance         |\n| `clock_tick` | `u64`    | Monotonically increasing counter               |\n| `force`      | `bool`   | If true, bypass clock rejection (for recovery) |\n\n**Sources:** [lib/collection/src/operations/types.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/operations/types.rs) (referenced in update.rs)\n\n### ClockSet and Clock Assignment",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 9,
      "token_count": 213,
      "char_count": 959,
      "start_char": 8092,
      "end_char": 9053
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:10",
    "content": "b/collection/src/operations/types.rs) (referenced in update.rs)\n\n### ClockSet and Clock Assignment\n\nThe `ShardReplicaSet` maintains a `ClockSet` that assigns clock tags to new operations:\n\n```\n```\n\n**Sources:** [lib/collection/src/shards/replica\\_set/update.rs195-251](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/replica_set/update.rs#L195-L251) [lib/collection/src/shards/replica\\_set/clock\\_set.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/replica_set/clock_set.rs) (referenced)\n\n### Clock-Based Rejection\n\nReplicas track the highest clock tick seen from each peer in their `ClockMap`. Operations with older ticks are rejected to prevent applying stale updates:\n\n- **Operation tick > newest tick**: Operation is applied, `newest_clocks` is updated\n- **Operation tick <= newest tick**: Operation is rejected with `UpdateStatus::ClockRejected`\n- **Operation has `force=true`**: Clock check is bypassed (used during recovery)",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 10,
      "token_count": 267,
      "char_count": 985,
      "start_char": 8953,
      "end_char": 9940
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:11",
    "content": "s::ClockRejected`\n- **Operation has `force=true`**: Clock check is bypassed (used during recovery)\n\nWhen an operation is rejected, the replica set retries with a new clock tick up to `UPDATE_MAX_CLOCK_REJECTED_RETRIES` (3) times.\n\n**Sources:** [lib/collection/src/shards/replica\\_set/update.rs16-20](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/replica_set/update.rs#L16-L20) [lib/collection/src/shards/replica\\_set/update.rs212-244](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/replica_set/update.rs#L212-L244)\n\n---\n\n## Update Handler Architecture\n\nThe `UpdateHandler` manages three types of background workers that process updates, optimize segments, and periodically flush data to disk.\n\n### Worker Types\n\n```\n```\n\n**Sources:** [lib/collection/src/update\\_handler.rs92-144](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/update_handler.rs#L92-L144) [lib/collection/src/update\\_handler.rs193-252](https://github.",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 11,
      "token_count": 297,
      "char_count": 989,
      "start_char": 9840,
      "end_char": 10829
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:12",
    "content": "ction/src/update_handler.rs#L92-L144) [lib/collection/src/update\\_handler.rs193-252](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/update_handler.rs#L193-L252)\n\n### Update Signal Types\n\n| Signal                         | Purpose                                               |\n| ------------------------------ | ----------------------------------------------------- |\n| `Operation(OperationData)`     | Contains the update operation to apply                |\n| `Stop`                         | Gracefully stops all workers                          |\n| `Nop`                          | Trigger signal to wake optimizers                     |\n| `Plunger(oneshot::Sender<()>)` | Ensures previous updates are applied before notifying |\n\n**Sources:** [lib/collection/src/update\\_handler.rs66-78](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/update_handler.rs#L66-L78)\n\n---\n\n## Update Processing Pipeline",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 12,
      "token_count": 213,
      "char_count": 939,
      "start_char": 10729,
      "end_char": 11670
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:13",
    "content": "nt/blob/48203e41/lib/collection/src/update_handler.rs#L66-L78)\n\n---\n\n## Update Processing Pipeline\n\nWhen an update operation arrives at a `LocalShard`, it goes through a multi-stage pipeline:\n\n### Pipeline Stages\n\n```\n```\n\n**Sources:** [lib/collection/src/shards/shard\\_trait.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/shard_trait.rs) (referenced), [lib/collection/src/shards/local\\_shard/shard\\_ops.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/local_shard/shard_ops.rs) (referenced)\n\n### CollectionUpdater\n\nThe `CollectionUpdater` applies operations to segments:\n\n```\n```\n\n**Sources:** [lib/collection/src/collection\\_manager/collection\\_updater.rs42-78](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/collection_manager/collection_updater.rs#L42-L78)\n\n---\n\n## Write Consistency Models\n\nQdrant provides three write ordering levels that control consistency vs. availability tradeoffs.\n\n### WriteOrdering Levels\n\n```\n```",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 13,
      "token_count": 283,
      "char_count": 1004,
      "start_char": 11570,
      "end_char": 12576
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:14",
    "content": "ing levels that control consistency vs. availability tradeoffs.\n\n### WriteOrdering Levels\n\n```\n```\n\n**Sources:** [lib/collection/src/shards/replica\\_set/update.rs168-175](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/replica_set/update.rs#L168-L175)\n\n### Leader Selection\n\nThe leader for an update is determined by the `WriteOrdering`:\n\n| Ordering | Leader Selection                                     | Lock Required               |\n| -------- | ---------------------------------------------------- | --------------------------- |\n| `Weak`   | Always local peer                                    | No                          |\n| `Medium` | Highest peer ID that is alive (Active or Resharding) | Yes (`write_ordering_lock`) |\n| `Strong` | Highest peer ID (even if dead)                       | Yes (`write_ordering_lock`) |\n\nIf the local peer is not the leader, the update is forwarded to the designated leader via internal gRPC.\n\n**Sources:** [lib/collection/src/shards/replica\\_set/update.",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 14,
      "token_count": 230,
      "char_count": 1021,
      "start_char": 12476,
      "end_char": 13497
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:15",
    "content": "e designated leader via internal gRPC.\n\n**Sources:** [lib/collection/src/shards/replica\\_set/update.rs136-165](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/replica_set/update.rs#L136-L165)\n\n### Write Consistency Factor\n\nAfter applying an update to replicas, the `ShardReplicaSet` checks if enough replicas succeeded:\n\n```\n```\n\n**Sources:** [lib/collection/src/shards/replica\\_set/update.rs355-542](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/replica_set/update.rs#L355-L542)\n\n### Replica Failure Handling\n\nWhen a replica fails to apply an update:\n\n1. **Transient errors** (network issues, timeouts): Replica is marked as locally disabled\n2. **Non-transient errors** (validation failures): Only deactivated if there are full-completed updates\n3. **Locally disabled replicas**: Not considered for read or write operations\n4. **Consensus notification**: After timeout (30s default), failures are reported to consensus\n5.",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 15,
      "token_count": 267,
      "char_count": 974,
      "start_char": 13397,
      "end_char": 14371
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:16",
    "content": "ns\n4. **Consensus notification**: After timeout (30s default), failures are reported to consensus\n5. **Automatic recovery**: Failed replicas eventually recover via shard transfer\n\n**Sources:** [lib/collection/src/shards/replica\\_set/update.rs409-542](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/replica_set/update.rs#L409-L542) [lib/collection/src/shards/replica\\_set/mod.rs94-98](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/replica_set/mod.rs#L94-L98)\n\n---\n\n## Key Data Structures\n\n### LocalShard\n\nThe `LocalShard` is the core data-holding component on each peer:\n\n| Field                   | Type                            | Purpose                                     |\n| ----------------------- | ------------------------------- | ------------------------------------------- |\n| `segments`              | `LockedSegmentHolder`           | Holds all segment data                      |",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 16,
      "token_count": 231,
      "char_count": 947,
      "start_char": 14271,
      "end_char": 15219
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:17",
    "content": "nts`              | `LockedSegmentHolder`           | Holds all segment data                      |\n| `wal`                   | `RecoverableWal`                | Write-ahead log for durability              |\n| `update_handler`        | `Arc<Mutex<UpdateHandler>>`     | Manages update processing workers           |\n| `update_sender`         | `ArcSwap<Sender<UpdateSignal>>` | Channel to send updates to workers          |\n| `update_tracker`        | `UpdateTracker`                 | Tracks ongoing updates                      |\n| `update_operation_lock` | `Arc<RwLock<()>>`               | Prevents updates during critical operations |\n| `optimizers`            | `Arc<Vec<Arc<Optimizer>>>`      | Segment optimization strategies             |\n\n**Sources:** [lib/collection/src/shards/local\\_shard/mod.rs84-124](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/local_shard/mod.rs#L84-L124)\n\n### ShardReplicaSet\n\nThe `ShardReplicaSet` coordinates replicas of a single shard:",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 17,
      "token_count": 239,
      "char_count": 1001,
      "start_char": 15119,
      "end_char": 16122
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:18",
    "content": "d.rs#L84-L124)\n\n### ShardReplicaSet\n\nThe `ShardReplicaSet` coordinates replicas of a single shard:\n\n| Field                    | Type                               | Purpose                                      |\n| ------------------------ | ---------------------------------- | -------------------------------------------- |\n| `local`                  | `RwLock<Option<Shard>>`            | Local shard instance if present              |\n| `remotes`                | `RwLock<Vec<RemoteShard>>`         | Remote shard proxies                         |\n| `replica_state`          | `Arc<SaveOnDisk<ReplicaSetState>>` | Persisted replica states                     |\n| `locally_disabled_peers` | `RwLock<Registry>`                 | Peers marked as failed locally               |\n| `write_ordering_lock`    | `Mutex<()>`                        | Serializes writes for Medium/Strong ordering |\n| `clock_set`              | `Mutex<ClockSet>`                  | Assigns logical clocks                       |",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 18,
      "token_count": 201,
      "char_count": 1003,
      "start_char": 16022,
      "end_char": 17027
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:19",
    "content": "| `Mutex<ClockSet>`                  | Assigns logical clocks                       |\n\n**Sources:** [lib/collection/src/shards/replica\\_set/mod.rs90-119](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/replica_set/mod.rs#L90-L119)\n\n### UpdateHandler\n\nManages background workers for updates, optimization, and flushing:\n\n| Field                  | Type                                         | Purpose                         |\n| ---------------------- | -------------------------------------------- | ------------------------------- |\n| `segments`             | `LockedSegmentHolder`                        | Reference to segments           |\n| `wal`                  | `LockedWal`                                  | Reference to WAL                |\n| `optimizers`           | `Arc<Vec<Arc<Optimizer>>>`                   | List of optimization strategies |\n| `update_worker`        | `Option<JoinHandle<()>>`                     | Update processing worker        |",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 19,
      "token_count": 198,
      "char_count": 992,
      "start_char": 16927,
      "end_char": 17933
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:20",
    "content": "e_worker`        | `Option<JoinHandle<()>>`                     | Update processing worker        |\n| `optimizer_worker`     | `Option<JoinHandle<()>>`                     | Optimization worker             |\n| `flush_worker`         | `Option<JoinHandle<()>>`                     | Periodic flush worker           |\n| `optimization_handles` | `Arc<Mutex<Vec<StoppableTaskHandle<bool>>>>` | Active optimization tasks       |\n\n**Sources:** [lib/collection/src/update\\_handler.rs92-144](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/update_handler.rs#L92-L144)\n\n---\n\n## Update Operation Lock\n\nThe `update_operation_lock` is a `RwLock` that prevents data races between updates and certain read operations:\n\n**Write lock held during:**\n\n- Update operations (point upsert/delete, vector updates, payload operations)\n\n**Read lock held during:**\n\n- Scroll operations (ensuring consistent iteration)\n- Snapshot creation (preventing segment changes)",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 20,
      "token_count": 225,
      "char_count": 959,
      "start_char": 17833,
      "end_char": 18794
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:21",
    "content": "Scroll operations (ensuring consistent iteration)\n- Snapshot creation (preventing segment changes)\n\nThis lock ensures that scroll operations see a consistent view of the data and that snapshots capture a coherent state.\n\n**Sources:** [lib/collection/src/shards/local\\_shard/mod.rs108-123](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/local_shard/mod.rs#L108-L123) [lib/collection/src/shards/local\\_shard/scroll.rs156-157](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/local_shard/scroll.rs#L156-L157) [lib/collection/src/shards/local\\_shard/snapshot.rs93-106](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/local_shard/snapshot.rs#L93-L106)\n\nDismiss\n\nRefresh this wiki\n\nEnter email to refresh\n\n### On this page\n\n- [Data Updates and Consistency](#data-updates-and-consistency.md)\n- [Write Path Overview](#write-path-overview.md)\n- [High-Level Write Flow](#high-level-write-flow.md)\n- [Write-Ahead Log (WAL)](#write-ahead-log-wal.md)",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 21,
      "token_count": 307,
      "char_count": 1012,
      "start_char": 18694,
      "end_char": 19707
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:22",
    "content": "igh-Level Write Flow](#high-level-write-flow.md)\n- [Write-Ahead Log (WAL)](#write-ahead-log-wal.md)\n- [WAL Architecture](#wal-architecture.md)\n- [WAL Recovery](#wal-recovery.md)\n- [Logical Clocks and Consistency](#logical-clocks-and-consistency.md)\n- [Clock Tag Structure](#clock-tag-structure.md)\n- [ClockSet and Clock Assignment](#clockset-and-clock-assignment.md)\n- [Clock-Based Rejection](#clock-based-rejection.md)\n- [Update Handler Architecture](#update-handler-architecture.md)\n- [Worker Types](#worker-types.md)\n- [Update Signal Types](#update-signal-types.md)\n- [Update Processing Pipeline](#update-processing-pipeline.md)\n- [Pipeline Stages](#pipeline-stages.md)\n- [CollectionUpdater](#collectionupdater.md)\n- [Write Consistency Models](#write-consistency-models.md)\n- [WriteOrdering Levels](#writeordering-levels.md)\n- [Leader Selection](#leader-selection.md)\n- [Write Consistency Factor](#write-consistency-factor.md)\n- [Replica Failure Handling](#replica-failure-handling.md)",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 22,
      "token_count": 257,
      "char_count": 988,
      "start_char": 19607,
      "end_char": 20596
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md:chunk:23",
    "content": "cy Factor](#write-consistency-factor.md)\n- [Replica Failure Handling](#replica-failure-handling.md)\n- [Key Data Structures](#key-data-structures.md)\n- [LocalShard](#localshard.md)\n- [ShardReplicaSet](#shardreplicaset.md)\n- [UpdateHandler](#updatehandler.md)\n- [Update Operation Lock](#update-operation-lock.md)",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_6-data-updates-and-consistency.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_6-data-updates-and-consistency.md",
      "file_extension": ".md",
      "chunk_index": 23,
      "token_count": 89,
      "char_count": 310,
      "start_char": 20496,
      "end_char": 21520
    }
  }
]