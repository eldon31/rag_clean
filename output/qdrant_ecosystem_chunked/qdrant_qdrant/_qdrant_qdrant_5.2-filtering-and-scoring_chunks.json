[
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:0",
    "content": "Filtering and Scoring | qdrant/qdrant | DeepWiki\n\n[Index your code with Devin](private-repo.md)\n\n[DeepWiki](https://deepwiki.com)\n\n[DeepWiki](.md)\n\n[qdrant/qdrant](https://github.com/qdrant/qdrant \"Open repository\")\n\n[Index your code with](private-repo.md)\n\n[Devin](private-repo.md)\n\nShare\n\nLast indexed: 4 October 2025 ([48203e](https://github.com/qdrant/qdrant/commits/48203e41))\n\n- [Introduction to Qdrant](qdrant/qdrant/1-introduction-to-qdrant.md)\n- [Key Concepts and Terminology](qdrant/qdrant/1.1-key-concepts-and-terminology.md)\n- [System Architecture](qdrant/qdrant/2-system-architecture.md)\n- [Application Initialization and Runtime](qdrant/qdrant/2.1-application-initialization-and-runtime.md)\n- [Collections and Table of Content](qdrant/qdrant/2.2-collections-and-table-of-content.md)\n- [Shards and Replica Sets](qdrant/qdrant/2.3-shards-and-replica-sets.md)\n- [Local Shard Architecture](qdrant/qdrant/2.4-local-shard-architecture.md)\n- [Segment Lifecycle and Construction](qdrant/qdrant/2.",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 0,
      "token_count": 314,
      "char_count": 1002,
      "start_char": 0,
      "end_char": 1002
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:1",
    "content": "rant/qdrant/2.4-local-shard-architecture.md)\n- [Segment Lifecycle and Construction](qdrant/qdrant/2.5-segment-lifecycle-and-construction.md)\n- [Vector Storage and Indexing](qdrant/qdrant/3-vector-storage-and-indexing.md)\n- [Vector Storage Formats](qdrant/qdrant/3.1-vector-storage-formats.md)\n- [HNSW Index Implementation](qdrant/qdrant/3.2-hnsw-index-implementation.md)\n- [Vector Quantization](qdrant/qdrant/3.3-vector-quantization.md)\n- [Sparse Vector Indexing](qdrant/qdrant/3.4-sparse-vector-indexing.md)\n- [Payload Indexing and Filtering](qdrant/qdrant/4-payload-indexing-and-filtering.md)\n- [Field Index Types](qdrant/qdrant/4.1-field-index-types.md)\n- [Index Selection and Storage Backends](qdrant/qdrant/4.2-index-selection-and-storage-backends.md)\n- [Search and Query Processing](qdrant/qdrant/5-search-and-query-processing.md)\n- [Query Request Flow](qdrant/qdrant/5.1-query-request-flow.md)\n- [Filtering and Scoring](qdrant/qdrant/5.2-filtering-and-scoring.md)",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 1,
      "token_count": 298,
      "char_count": 970,
      "start_char": 902,
      "end_char": 1873
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:2",
    "content": "nt/5.1-query-request-flow.md)\n- [Filtering and Scoring](qdrant/qdrant/5.2-filtering-and-scoring.md)\n- [Data Updates and Consistency](qdrant/qdrant/6-data-updates-and-consistency.md)\n- [Update Processing Pipeline](qdrant/qdrant/6.1-update-processing-pipeline.md)\n- [Write Consistency and Replication](qdrant/qdrant/6.2-write-consistency-and-replication.md)\n- [Distributed System Features](qdrant/qdrant/7-distributed-system-features.md)\n- [Raft Consensus Protocol](qdrant/qdrant/7.1-raft-consensus-protocol.md)\n- [Shard Transfers and Resharding](qdrant/qdrant/7.2-shard-transfers-and-resharding.md)\n- [Snapshots and Recovery](qdrant/qdrant/8-snapshots-and-recovery.md)\n- [API Reference](qdrant/qdrant/9-api-reference.md)\n- [REST API Endpoints](qdrant/qdrant/9.1-rest-api-endpoints.md)\n- [gRPC API Services](qdrant/qdrant/9.2-grpc-api-services.md)\n- [Data Types and Conversions](qdrant/qdrant/9.3-data-types-and-conversions.md)\n- [Configuration and Deployment](qdrant/qdrant/10-configuration-and-deployment.md)",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 2,
      "token_count": 321,
      "char_count": 1008,
      "start_char": 1773,
      "end_char": 2782
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:3",
    "content": "-conversions.md)\n- [Configuration and Deployment](qdrant/qdrant/10-configuration-and-deployment.md)\n- [Configuration System](qdrant/qdrant/10.1-configuration-system.md)\n- [Docker Deployment](qdrant/qdrant/10.2-docker-deployment.md)\n- [Building and CI/CD](qdrant/qdrant/10.3-building-and-cicd.md)\n- [Development Guide](qdrant/qdrant/11-development-guide.md)\n\nMenu\n\n# Filtering and Scoring\n\nRelevant source files\n\n- [lib/common/io/src/file\\_operations.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/common/io/src/file_operations.rs)\n- [lib/segment/benches/hnsw\\_build\\_asymptotic.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/benches/hnsw_build_asymptotic.rs)\n- [lib/segment/benches/hnsw\\_build\\_graph.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/benches/hnsw_build_graph.rs)\n- [lib/segment/benches/hnsw\\_search\\_graph.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/benches/hnsw_search_graph.rs)\n- [lib/segment/src/index/field\\_index/field\\_index\\_base.",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 3,
      "token_count": 340,
      "char_count": 1010,
      "start_char": 2682,
      "end_char": 3692
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:4",
    "content": "/lib/segment/benches/hnsw_search_graph.rs)\n- [lib/segment/src/index/field\\_index/field\\_index\\_base.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/field_index/field_index_base.rs)\n- [lib/segment/src/index/field\\_index/full\\_text\\_index/text\\_index.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/field_index/full_text_index/text_index.rs)\n- [lib/segment/src/index/field\\_index/index\\_selector.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/field_index/index_selector.rs)\n- [lib/segment/src/index/hnsw\\_index/graph\\_layers.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/hnsw_index/graph_layers.rs)\n- [lib/segment/src/index/hnsw\\_index/graph\\_layers\\_builder.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/hnsw_index/graph_layers_builder.rs)\n- [lib/segment/src/index/hnsw\\_index/graph\\_links.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/hnsw_index/graph_links.rs)",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 4,
      "token_count": 323,
      "char_count": 1018,
      "start_char": 3592,
      "end_char": 4611
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:5",
    "content": "rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/hnsw_index/graph_links.rs)\n- [lib/segment/src/index/hnsw\\_index/graph\\_links/header.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/hnsw_index/graph_links/header.rs)\n- [lib/segment/src/index/hnsw\\_index/graph\\_links/serializer.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/hnsw_index/graph_links/serializer.rs)\n- [lib/segment/src/index/hnsw\\_index/graph\\_links/view.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/hnsw_index/graph_links/view.rs)\n- [lib/segment/src/index/hnsw\\_index/hnsw.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/hnsw_index/hnsw.rs)\n- [lib/segment/src/index/hnsw\\_index/tests/mod.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/hnsw_index/tests/mod.rs)\n- [lib/segment/src/index/hnsw\\_index/tests/test\\_compact\\_graph\\_layer.rs](https://github.",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 5,
      "token_count": 319,
      "char_count": 966,
      "start_char": 4511,
      "end_char": 5477
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:6",
    "content": "s/mod.rs)\n- [lib/segment/src/index/hnsw\\_index/tests/test\\_compact\\_graph\\_layer.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/hnsw_index/tests/test_compact_graph_layer.rs)\n- [lib/segment/src/index/plain\\_payload\\_index.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/plain_payload_index.rs)\n- [lib/segment/src/index/struct\\_payload\\_index.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.rs)\n- [lib/segment/src/index/vector\\_index\\_base.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/vector_index_base.rs)\n\n**Purpose**: This page explains how Qdrant evaluates filters and scores vectors during search operations. It covers cardinality estimation, filter evaluation strategies, the integration of filtering with vector scoring, and how search strategies are selected based on estimated filter selectivity.",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 6,
      "token_count": 247,
      "char_count": 928,
      "start_char": 5377,
      "end_char": 6307
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:7",
    "content": "with vector scoring, and how search strategies are selected based on estimated filter selectivity.\n\n**Scope**: This document focuses on the filtering and scoring mechanisms during query execution. For the overall query flow through Collection, ReplicaSet, and Segment layers, see [5.1 Query Request Flow](qdrant/qdrant/5.1-query-request-flow.md). For details on specific payload index implementations, see [4.1 Field Index Types](qdrant/qdrant/4.1-field-index-types.md).\n\n## Overview\n\nDuring vector search, Qdrant must efficiently combine two operations:\n\n1. **Filtering**: Selecting only points that satisfy payload conditions\n2. **Scoring**: Computing vector similarity between query and candidates\n\nThe system uses cardinality estimation to predict how many points will match a filter, then selects an appropriate search strategy. The `FilteredScorer` component integrates both filtering and scoring into a single interface used by the vector index.\n\n```\n```\n\n**Diagram: Filter Evaluation and Search Strategy Selection**",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 7,
      "token_count": 208,
      "char_count": 1023,
      "start_char": 6207,
      "end_char": 7232
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:8",
    "content": "e used by the vector index.\n\n```\n```\n\n**Diagram: Filter Evaluation and Search Strategy Selection**\n\nSources: [lib/segment/src/index/hnsw\\_index/hnsw.rs941-1165](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/hnsw_index/hnsw.rs#L941-L1165) [lib/segment/src/index/struct\\_payload\\_index.rs507-571](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.rs#L507-L571)\n\n---\n\n## Cardinality Estimation\n\nCardinality estimation predicts how many points will match a filter without actually evaluating it on all points. This estimate guides the selection of an efficient search strategy.\n\n### CardinalityEstimation Structure\n\nThe `CardinalityEstimation` struct contains:\n\n- **`min`**: Minimum possible matching points\n- **`exp`**: Expected (most likely) matching points\n- **`max`**: Maximum possible matching points\n- **`primary_clauses`**: Conditions that can be evaluated directly using indices\n\n```\n```\n\n**Diagram: CardinalityEstimation Structure**",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 8,
      "token_count": 272,
      "char_count": 1000,
      "start_char": 7132,
      "end_char": 8134
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:9",
    "content": "hat can be evaluated directly using indices\n\n```\n```\n\n**Diagram: CardinalityEstimation Structure**\n\nSources: [lib/segment/src/index/field\\_index/mod.rs36-43](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/field_index/mod.rs#L36-L43) [lib/segment/src/index/struct\\_payload\\_index.rs542-550](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.rs#L542-L550)\n\n### Estimation Process\n\nThe estimation process flows from top-level filters down to individual field conditions:\n\n| Level | Component            | Function                     | Purpose                                                      |\n| ----- | -------------------- | ---------------------------- | ------------------------------------------------------------ |\n| 1     | `StructPayloadIndex` | `estimate_cardinality()`     | Entry point, calls `estimate_filter()`                       |",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 9,
      "token_count": 209,
      "char_count": 911,
      "start_char": 8034,
      "end_char": 8946
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:10",
    "content": "ex` | `estimate_cardinality()`     | Entry point, calls `estimate_filter()`                       |\n| 2     | Query Estimator      | `estimate_filter()`          | Recursively processes filter clauses (must/should/must\\_not) |\n| 3     | `StructPayloadIndex` | `condition_cardinality()`    | Handles individual conditions                                |\n| 4     | `StructPayloadIndex` | `estimate_field_condition()` | Queries specific field index                                 |\n| 5     | `FieldIndex`         | `estimate_cardinality()`     | Returns actual cardinality from index                        |\n\n```\n```\n\n**Diagram: Cardinality Estimation Flow**\n\nSources: [lib/segment/src/index/struct\\_payload\\_index.rs507-571](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.rs#L507-L571) [lib/segment/src/index/query\\_estimator.rs1-150](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/query_estimator.rs#L1-L150)\n\n### Primary vs Secondary Conditions",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 10,
      "token_count": 258,
      "char_count": 1012,
      "start_char": 8846,
      "end_char": 9860
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:11",
    "content": "ob/48203e41/lib/segment/src/index/query_estimator.rs#L1-L150)\n\n### Primary vs Secondary Conditions\n\n**Primary Conditions** can be evaluated directly from an index, returning an iterator over matching point IDs:\n\n- Field conditions with indexed fields\n- `HasId` conditions (resolved to point offsets)\n- `HasVector` conditions (using vector storage availability)\n\n**Secondary Conditions** require checking the actual payload value:\n\n- Field conditions on non-indexed fields\n- Complex nested conditions\n- Conditions where index doesn't support the operation\n\nPrimary conditions enable significant optimization: if all conditions are primary, post-filtering can be skipped entirely.\n\n```\n```\n\n**Diagram: Primary vs Secondary Condition Handling**\n\nSources: [lib/segment/src/index/struct\\_payload\\_index.rs614-680](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.rs#L614-L680) [lib/segment/src/index/field\\_index/mod.rs23-35](https://github.",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 11,
      "token_count": 236,
      "char_count": 977,
      "start_char": 9760,
      "end_char": 10737
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:12",
    "content": "/struct_payload_index.rs#L614-L680) [lib/segment/src/index/field\\_index/mod.rs23-35](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/field_index/mod.rs#L23-L35)\n\n---\n\n## Filter Evaluation Strategies\n\nQdrant uses different strategies to evaluate filters depending on the estimated cardinality and available indices.\n\n### Index-Based Filtering\n\nWhen primary conditions exist and field indices are available, Qdrant uses `query_field()` to retrieve matching point IDs directly from the index:\n\n```\n```\n\n**Diagram: Field Index Filter Methods**\n\nEach field index type implements filtering appropriate to its data type:\n\n| Index Type      | Filter Operations                                     | Implementation                         |\n| --------------- | ----------------------------------------------------- | -------------------------------------- |\n| `NumericIndex`  | Range queries (`lt`, `gt`, `gte`, `lte`), exact match | Iterates over sorted histogram buckets |",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 12,
      "token_count": 207,
      "char_count": 986,
      "start_char": 10637,
      "end_char": 11624
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:13",
    "content": "| Range queries (`lt`, `gt`, `gte`, `lte`), exact match | Iterates over sorted histogram buckets |\n| `MapIndex`      | Exact match, `any_of`                                 | Hash map lookup                        |\n| `FullTextIndex` | Text match, phrase match                              | Inverted index query                   |\n| `GeoIndex`      | Radius, bounding box                                  | Geo-spatial index                      |\n| `BoolIndex`     | True/false                                            | Bitmap                                 |\n| `NullIndex`     | Is null, is not null                                  | Bitmap                                 |\n\nSources: [lib/segment/src/index/field\\_index/field\\_index\\_base.rs248-254](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/field_index/field_index_base.rs#L248-L254) [lib/segment/src/index/struct\\_payload\\_index.rs121-139](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 13,
      "token_count": 239,
      "char_count": 1019,
      "start_char": 11524,
      "end_char": 12544
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:14",
    "content": "s121-139](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.rs#L121-L139)\n\n### Full Scan Filtering\n\nWhen no indices are available or conditions are secondary, Qdrant falls back to full scan with `FilterContext`:\n\n```\n```\n\n**Diagram: Full Scan Filter Evaluation**\n\nTwo implementations of `FilterContext`:\n\n1. **`StructFilterContext`** ([lib/segment/src/index/struct\\_filter\\_context.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_filter_context.rs)): Uses optimized filter representation\n2. **`PlainFilterContext`** ([lib/segment/src/index/plain\\_payload\\_index.rs265-274](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/plain_payload_index.rs#L265-L274)): Simple condition checking\n\nSources: [lib/segment/src/index/struct\\_payload\\_index.rs490-505](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.rs#L490-L505) [lib/segment/src/payload\\_storage/mod.rs44-46](https://github.",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 14,
      "token_count": 313,
      "char_count": 1009,
      "start_char": 12444,
      "end_char": 13453
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:15",
    "content": "ex/struct_payload_index.rs#L490-L505) [lib/segment/src/payload\\_storage/mod.rs44-46](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/payload_storage/mod.rs#L44-L46)\n\n### Hybrid Strategy with Visited List\n\nWhen some conditions are primary and others are secondary, Qdrant uses a hybrid approach with a visited list to ensure uniqueness:\n\n```\n```\n\n**Diagram: Hybrid Filtering with Visited List**\n\nThe visited list ensures that points returned by multiple primary condition iterators are only checked once.\n\nSources: [lib/segment/src/index/struct\\_payload\\_index.rs614-680](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.rs#L614-L680)\n\n---\n\n## Scoring Integration\n\n### FilteredScorer\n\nThe `FilteredScorer` combines filtering and vector scoring into a single component used by the HNSW index during search:\n\n```\n```\n\n**Diagram: FilteredScorer Structure**\n\nThe scorer provides:\n\n1. **Vector scoring** via `RawScorer` (delegates to vector storage)\n2.",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 15,
      "token_count": 272,
      "char_count": 1002,
      "start_char": 13353,
      "end_char": 14355
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:16",
    "content": "ture**\n\nThe scorer provides:\n\n1. **Vector scoring** via `RawScorer` (delegates to vector storage)\n2. **Filter checking** via `ScorerFilters`\n3. **Deleted point filtering** via bitslice\n4. **Batch scoring** with integrated filtering\n\nSources: [lib/segment/src/index/hnsw\\_index/point\\_scorer.rs1-350](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/hnsw_index/point_scorer.rs#L1-L350)\n\n### Scoring in HNSW Search\n\nDuring HNSW graph traversal, `FilteredScorer` is called at each step:\n\n```\n```\n\n**Diagram: FilteredScorer Interaction During HNSW Search**\n\nPoints that don't pass the filter receive a score of `f32::MIN`, effectively excluding them from results.\n\nSources: [lib/segment/src/index/hnsw\\_index/point\\_scorer.rs150-250](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/hnsw_index/point_scorer.rs#L150-L250) [lib/segment/src/index/hnsw\\_index/graph\\_layers.rs63-97](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/hnsw_index/graph_layers.rs#L63-L97)\n\n---",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 16,
      "token_count": 329,
      "char_count": 1024,
      "start_char": 14255,
      "end_char": 15280
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:17",
    "content": "thub.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/hnsw_index/graph_layers.rs#L63-L97)\n\n---\n\n## Search Strategy Selection\n\nThe HNSW index selects a search strategy based on cardinality estimation and configuration:\n\n### Strategy Decision Tree\n\n```\n```\n\n**Diagram: HNSW Search Strategy Selection**\n\nSources: [lib/segment/src/index/hnsw\\_index/hnsw.rs941-1165](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/hnsw_index/hnsw.rs#L941-L1165)\n\n### Strategy Implementations\n\n#### 1. Exact Unfiltered Search\n\nBrute force scoring of all available vectors (used when `params.exact = true` and no filter):\n\n```\nfor each point in vector_storage:\n    score = scorer.score_point(point)\n    add to top-k heap\n```\n\n**Telemetry**: Tracked in `exact_unfiltered` aggregator\n\n#### 2. Exact Filtered Search\n\nBrute force scoring of filtered points (used when cardinality is small):\n\n```\nfiltered_points = payload_index.iter_filtered_points(filter)\nfor each point in filtered_points:\n    score = scorer.",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 17,
      "token_count": 275,
      "char_count": 1010,
      "start_char": 15180,
      "end_char": 16190
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:18",
    "content": "= payload_index.iter_filtered_points(filter)\nfor each point in filtered_points:\n    score = scorer.score_point(point)\n    add to top-k heap\n```\n\n**Telemetry**: Tracked in `exact_filtered` aggregator\n\n**Threshold**: `available_vector_count < full_scan_threshold`\n\n#### 3. Unfiltered HNSW Search\n\nStandard HNSW graph traversal without filters:\n\n```\nentry_point = get highest level point\nlevel_entry = search_entry(entry_point, top_level, 0)\nresults = search_on_level(level_entry, 0, ef)\n```\n\n**Telemetry**: Tracked in `unfiltered_hnsw` aggregator\n\n#### 4. Filtered HNSW - Small Cardinality\n\nSample estimation to decide between graph-based or plain filtering:\n\n```\nsample_size = min(cardinality.exp, SAMPLE_SIZE)\nsample_points = random sample from filtered points\nsample_matched = count points in HNSW graph\n\nif sample_matched / sample_size < SAMPLE_OPTIMISTIC_THRESHOLD:\n    use exact_filtered_search()\nelse:\n    use filtered_hnsw_search()\n```\n\n**Telemetry**: Tracked in `small_cardinality` aggregator\n\n**Constants**:",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 18,
      "token_count": 239,
      "char_count": 1015,
      "start_char": 16090,
      "end_char": 17108
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:19",
    "content": "ltered_hnsw_search()\n```\n\n**Telemetry**: Tracked in `small_cardinality` aggregator\n\n**Constants**:\n\n- `SAMPLE_SIZE = 20`\n- `SAMPLE_OPTIMISTIC_THRESHOLD = 0.2`\n\n#### 5. Filtered HNSW - Large Cardinality\n\nHNSW traversal with filter checks at each step:\n\n```\nentry_point = get filtered entry point\nlevel_entry = search_entry(entry_point, top_level, 0, filter)\nresults = search_on_level(level_entry, 0, ef, filter)\n```\n\n**Telemetry**: Tracked in `large_cardinality` aggregator\n\nSources: [lib/segment/src/index/hnsw\\_index/hnsw.rs1000-1165](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/hnsw_index/hnsw.rs#L1000-L1165) [lib/segment/src/index/sample\\_estimation.rs1-50](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/sample_estimation.rs#L1-L50)\n\n### Full Scan Threshold\n\nThe `full_scan_threshold` determines when to switch from graph-based to brute-force search:\n\n| Configuration      | Calculation                             |",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 19,
      "token_count": 285,
      "char_count": 968,
      "start_char": 17008,
      "end_char": 17977
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:20",
    "content": "raph-based to brute-force search:\n\n| Configuration      | Calculation                             |\n| ------------------ | --------------------------------------- |\n| HNSW Config        | `full_scan_threshold` (in KB)           |\n| Runtime Conversion | `threshold_kb * 1024 / avg_vector_size` |\n| Default            | `10000` (10KB)                          |\n\nThis threshold is computed during index construction and stored in `HnswGraphConfig`.\n\nSources: [lib/segment/src/index/hnsw\\_index/hnsw.rs140-165](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/hnsw_index/hnsw.rs#L140-L165) [lib/segment/src/index/hnsw\\_index/config.rs1-100](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/hnsw_index/config.rs#L1-L100)\n\n---\n\n## Telemetry and Performance Tracking\n\nSearch strategies are tracked separately for performance analysis:\n\n```\n```\n\n**Diagram: Search Strategy Telemetry Tracking**",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 20,
      "token_count": 249,
      "char_count": 926,
      "start_char": 17877,
      "end_char": 18805
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:21",
    "content": "ked separately for performance analysis:\n\n```\n```\n\n**Diagram: Search Strategy Telemetry Tracking**\n\nEach search path uses `ScopeDurationMeasurer` to automatically track its execution time, enabling analysis of which strategies are most commonly used and their performance characteristics.\n\nSources: [lib/segment/src/index/hnsw\\_index/hnsw.rs96-118](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/hnsw_index/hnsw.rs#L96-L118) [lib/segment/src/common/operation\\_time\\_statistics.rs1-100](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/common/operation_time_statistics.rs#L1-L100)\n\nDismiss\n\nRefresh this wiki\n\nEnter email to refresh\n\n### On this page\n\n- [Filtering and Scoring](#filtering-and-scoring.md)\n- [Overview](#overview.md)\n- [Cardinality Estimation](#cardinality-estimation.md)\n- [CardinalityEstimation Structure](#cardinalityestimation-structure.md)\n- [Estimation Process](#estimation-process.md)\n- [Primary vs Secondary Conditions](#primary-vs-secondary-conditions.md)",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 21,
      "token_count": 272,
      "char_count": 1014,
      "start_char": 18705,
      "end_char": 19720
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:22",
    "content": "s](#estimation-process.md)\n- [Primary vs Secondary Conditions](#primary-vs-secondary-conditions.md)\n- [Filter Evaluation Strategies](#filter-evaluation-strategies.md)\n- [Index-Based Filtering](#index-based-filtering.md)\n- [Full Scan Filtering](#full-scan-filtering.md)\n- [Hybrid Strategy with Visited List](#hybrid-strategy-with-visited-list.md)\n- [Scoring Integration](#scoring-integration.md)\n- [FilteredScorer](#filteredscorer.md)\n- [Scoring in HNSW Search](#scoring-in-hnsw-search.md)\n- [Search Strategy Selection](#search-strategy-selection.md)\n- [Strategy Decision Tree](#strategy-decision-tree.md)\n- [Strategy Implementations](#strategy-implementations.md)\n- [1. Exact Unfiltered Search](#1-exact-unfiltered-search.md)\n- [2. Exact Filtered Search](#2-exact-filtered-search.md)\n- [3. Unfiltered HNSW Search](#3-unfiltered-hnsw-search.md)\n- [4. Filtered HNSW - Small Cardinality](#4-filtered-hnsw---small-cardinality.md)\n- [5. Filtered HNSW - Large Cardinality](#5-filtered-hnsw---large-cardinality.md)",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 22,
      "token_count": 280,
      "char_count": 1007,
      "start_char": 19620,
      "end_char": 20628
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md:chunk:23",
    "content": "l-cardinality.md)\n- [5. Filtered HNSW - Large Cardinality](#5-filtered-hnsw---large-cardinality.md)\n- [Full Scan Threshold](#full-scan-threshold.md)\n- [Telemetry and Performance Tracking](#telemetry-and-performance-tracking.md)",
    "metadata": {
      "source_file": "qdrant_qdrant\\_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant",
      "filename": "_qdrant_qdrant_5.2-filtering-and-scoring.md",
      "file_extension": ".md",
      "chunk_index": 23,
      "token_count": 62,
      "char_count": 227,
      "start_char": 20528,
      "end_char": 21552
    }
  }
]