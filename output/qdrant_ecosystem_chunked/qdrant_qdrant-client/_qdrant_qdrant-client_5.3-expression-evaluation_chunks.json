[
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md:chunk:0",
    "content": "Expression Evaluation | qdrant/qdrant-client | DeepWiki\n\n[Index your code with Devin](private-repo.md)\n\n[DeepWiki](https://deepwiki.com)\n\n[DeepWiki](.md)\n\n[qdrant/qdrant-client](https://github.com/qdrant/qdrant-client \"Open repository\")\n\n[Index your code with](private-repo.md)\n\n[Devin](private-repo.md)\n\nShare\n\nLast indexed: 9 July 2025 ([ac6f6c](https://github.com/qdrant/qdrant-client/commits/ac6f6cd2))\n\n- [Overview](qdrant/qdrant-client/1-overview.md)\n- [Client Architecture](qdrant/qdrant-client/2-client-architecture.md)\n- [Client Interface](qdrant/qdrant-client/2.1-client-interface.md)\n- [Local Mode](qdrant/qdrant-client/2.2-local-mode.md)\n- [Remote Mode](qdrant/qdrant-client/2.3-remote-mode.md)\n- [Protocol Handling](qdrant/qdrant-client/2.4-protocol-handling.md)\n- [Core Operations](qdrant/qdrant-client/3-core-operations.md)\n- [Search Operations](qdrant/qdrant-client/3.1-search-operations.md)\n- [Collection Management](qdrant/qdrant-client/3.2-collection-management.md)",
    "metadata": {
      "source_file": "qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant-client",
      "filename": "_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "file_extension": ".md",
      "chunk_index": 0,
      "token_count": 304,
      "char_count": 984,
      "start_char": 0,
      "end_char": 985
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md:chunk:1",
    "content": "-search-operations.md)\n- [Collection Management](qdrant/qdrant-client/3.2-collection-management.md)\n- [Point Operations](qdrant/qdrant-client/3.3-point-operations.md)\n- [Advanced Features](qdrant/qdrant-client/4-advanced-features.md)\n- [FastEmbed Integration](qdrant/qdrant-client/4.1-fastembed-integration.md)\n- [Batch Operations](qdrant/qdrant-client/4.2-batch-operations.md)\n- [Hybrid Search](qdrant/qdrant-client/4.3-hybrid-search.md)\n- [Local Inference](qdrant/qdrant-client/4.4-local-inference.md)\n- [Implementation Details](qdrant/qdrant-client/5-implementation-details.md)\n- [Payload Filtering](qdrant/qdrant-client/5.1-payload-filtering.md)\n- [Type Inspector System](qdrant/qdrant-client/5.2-type-inspector-system.md)\n- [Expression Evaluation](qdrant/qdrant-client/5.3-expression-evaluation.md)\n- [Development & Testing](qdrant/qdrant-client/6-development-and-testing.md)\n- [Project Setup](qdrant/qdrant-client/6.1-project-setup.md)\n- [Testing Framework](qdrant/qdrant-client/6.2-testing-framework.md)",
    "metadata": {
      "source_file": "qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant-client",
      "filename": "_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "file_extension": ".md",
      "chunk_index": 1,
      "token_count": 300,
      "char_count": 1010,
      "start_char": 885,
      "end_char": 1896
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md:chunk:2",
    "content": "t-client/6.1-project-setup.md)\n- [Testing Framework](qdrant/qdrant-client/6.2-testing-framework.md)\n- [Documentation System](qdrant/qdrant-client/6.3-documentation-system.md)\n\nMenu\n\n# Expression Evaluation\n\nRelevant source files\n\n- [qdrant\\_client/embed/\\_inspection\\_cache.py](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/embed/_inspection_cache.py)\n- [qdrant\\_client/hybrid/formula.py](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py)\n- [tests/fixtures/expressions.py](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/tests/fixtures/expressions.py)\n\n## Purpose and Scope\n\nThis document covers the expression evaluation system used in Qdrant's hybrid search and formula queries. The system provides a comprehensive framework for evaluating complex mathematical, geographical, and conditional expressions that can reference point scores, payload values, and external variables.",
    "metadata": {
      "source_file": "qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant-client",
      "filename": "_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "file_extension": ".md",
      "chunk_index": 2,
      "token_count": 233,
      "char_count": 943,
      "start_char": 1796,
      "end_char": 2739
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md:chunk:3",
    "content": "and conditional expressions that can reference point scores, payload values, and external variables. This evaluation system is primarily used in hybrid search scenarios where custom scoring formulas need to be applied to search results.\n\nFor information about payload filtering conditions, see [Payload Filtering](qdrant/qdrant-client/5.1-payload-filtering.md). For details about the type inspection system that detects inference objects, see [Type Inspector System](qdrant/qdrant-client/5.2-type-inspector-system.md).\n\n## System Architecture\n\nThe expression evaluation system is built around a recursive evaluation engine that processes a tree of expression objects. Each expression type has specific evaluation logic that can reference point data, scores from multiple search stages, and external defaults.\n\n```\n```\n\nSources: [qdrant\\_client/hybrid/formula.py19-26](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L19-L26) [qdrant\\_client/hybrid/formula.py266-298](https://github.",
    "metadata": {
      "source_file": "qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant-client",
      "filename": "_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "file_extension": ".md",
      "chunk_index": 3,
      "token_count": 229,
      "char_count": 1020,
      "start_char": 2639,
      "end_char": 3659
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md:chunk:4",
    "content": "2/qdrant_client/hybrid/formula.py#L19-L26) [qdrant\\_client/hybrid/formula.py266-298](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L266-L298) [qdrant\\_client/hybrid/formula.py245-263](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L245-L263)\n\n## Core Expression Types\n\n### Mathematical Expressions\n\nThe system supports a comprehensive set of mathematical operations that can be combined recursively to create complex formulas.\n\n```\n```\n\nSources: [qdrant\\_client/hybrid/formula.py38-49](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L38-L49) [qdrant\\_client/hybrid/formula.py51-55](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L51-L55) [qdrant\\_client/hybrid/formula.py68-89](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L68-L89) [qdrant\\_client/hybrid/formula.py101-116](https://github.",
    "metadata": {
      "source_file": "qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant-client",
      "filename": "_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "file_extension": ".md",
      "chunk_index": 4,
      "token_count": 344,
      "char_count": 987,
      "start_char": 3559,
      "end_char": 4546
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md:chunk:5",
    "content": "2/qdrant_client/hybrid/formula.py#L68-L89) [qdrant\\_client/hybrid/formula.py101-116](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L101-L116) [qdrant\\_client/hybrid/formula.py118-150](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L118-L150)\n\n### Variable Resolution System\n\nVariables in expressions can reference two types of data: payload fields and search scores from different stages.\n\n| Variable Type   | Pattern                     | Example                     | Resolution                    |\n| --------------- | --------------------------- | --------------------------- | ----------------------------- |\n| Payload Field   | `\"field.name\"`              | `\"price\"`, `\"nested.value\"` | Extracted from point payload  |\n| Score Reference | `\"$score\"` or `\"$score[n]\"` | `\"$score\"`, `\"$score[1]\"`   | Retrieved from search results |\n\n```\n```\n\nSources: [qdrant\\_client/hybrid/formula.py301-331](https://github.",
    "metadata": {
      "source_file": "qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant-client",
      "filename": "_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "file_extension": ".md",
      "chunk_index": 5,
      "token_count": 272,
      "char_count": 993,
      "start_char": 4446,
      "end_char": 5439
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md:chunk:6",
    "content": "d from search results |\n\n```\n```\n\nSources: [qdrant\\_client/hybrid/formula.py301-331](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L301-L331) [qdrant\\_client/hybrid/formula.py266-298](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L266-L298) [qdrant\\_client/hybrid/formula.py245-263](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L245-L263)\n\n## Decay Functions\n\nDecay functions provide sophisticated scoring mechanisms that decrease based on distance from a target value. Three types are supported:\n\n### Linear Decay\n\n```\nscore = max(0, -λ * |x - target| + 1)\nwhere λ = (1 - midpoint) / scale\n```\n\n### Exponential Decay\n\n```\nscore = exp(λ * |x - target|)\nwhere λ = ln(midpoint) / scale\n```\n\n### Gaussian Decay\n\n```\nscore = exp(λ * (x - target)²)\nwhere λ = ln(midpoint) / scale²\n```\n\n```\n```\n\nSources: [qdrant\\_client/hybrid/formula.py186-211](https://github.",
    "metadata": {
      "source_file": "qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant-client",
      "filename": "_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "file_extension": ".md",
      "chunk_index": 6,
      "token_count": 333,
      "char_count": 977,
      "start_char": 5339,
      "end_char": 6316
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md:chunk:7",
    "content": "(midpoint) / scale²\n```\n\n```\n```\n\nSources: [qdrant\\_client/hybrid/formula.py186-211](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L186-L211) [qdrant\\_client/hybrid/formula.py216-242](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L216-L242) [qdrant\\_client/hybrid/formula.py13-16](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L13-L16)\n\n## Geographical and Datetime Expressions\n\n### Geographical Distance Calculation\n\nThe `GeoDistance` expression calculates the distance between two geographical points using the haversine formula.\n\n```\n```\n\nSources: [qdrant\\_client/hybrid/formula.py152-166](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L152-L166) [qdrant\\_client/local/geo.py](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/local/geo.py)\n\n### Datetime Expressions\n\nTwo types of datetime expressions are supported:",
    "metadata": {
      "source_file": "qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant-client",
      "filename": "_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "file_extension": ".md",
      "chunk_index": 7,
      "token_count": 328,
      "char_count": 997,
      "start_char": 6216,
      "end_char": 7215
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md:chunk:8",
    "content": "t_client/local/geo.py)\n\n### Datetime Expressions\n\nTwo types of datetime expressions are supported:\n\n| Type                    | Purpose                  | Example                                |\n| ----------------------- | ------------------------ | -------------------------------------- |\n| `DatetimeExpression`    | Literal datetime values  | `{\"datetime\": \"2023-01-01T00:00:00Z\"}` |\n| `DatetimeKeyExpression` | Payload field references | `{\"datetime_key\": \"created_at\"}`       |\n\nSources: [qdrant\\_client/hybrid/formula.py168-184](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L168-L184) [qdrant\\_client/local/datetime\\_utils.py](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/local/datetime_utils.py)\n\n## Error Handling and Validation\n\nThe expression evaluation system includes comprehensive error handling for mathematical edge cases and invalid inputs.\n\n### Mathematical Error Handling\n\n```\n```\n\nSources: [qdrant\\_client/hybrid/formula.",
    "metadata": {
      "source_file": "qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant-client",
      "filename": "_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "file_extension": ".md",
      "chunk_index": 8,
      "token_count": 247,
      "char_count": 1005,
      "start_char": 7115,
      "end_char": 8120
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md:chunk:9",
    "content": "invalid inputs.\n\n### Mathematical Error Handling\n\n```\n```\n\nSources: [qdrant\\_client/hybrid/formula.py80-89](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L80-L89) [qdrant\\_client/hybrid/formula.py96-99](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L96-L99) [qdrant\\_client/hybrid/formula.py133-139](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L133-L139) [qdrant\\_client/hybrid/formula.py334-335](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L334-L335)\n\n### Validation Functions\n\nThe system includes several validation functions to ensure data integrity:\n\n- `is_number()`: Validates that a value is a numeric type (excluding boolean)\n- `raise_non_finite_error()`: Provides consistent error reporting for mathematical errors\n- Domain validation for decay parameters (midpoint and scale ranges)\n\nSources: [qdrant\\_client/hybrid/formula.py338-339](https://github.",
    "metadata": {
      "source_file": "qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant-client",
      "filename": "_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "file_extension": ".md",
      "chunk_index": 9,
      "token_count": 318,
      "char_count": 1023,
      "start_char": 8020,
      "end_char": 9044
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md:chunk:10",
    "content": "ters (midpoint and scale ranges)\n\nSources: [qdrant\\_client/hybrid/formula.py338-339](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L338-L339) [qdrant\\_client/hybrid/formula.py235-240](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L235-L240)\n\n## Testing Infrastructure\n\nThe expression evaluation system includes comprehensive test fixtures for generating random expressions and validating functionality.\n\n```\n```\n\nSources: [tests/fixtures/expressions.py8-111](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/tests/fixtures/expressions.py#L8-L111) [qdrant\\_client/hybrid/formula.py342-370](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L342-L370)\n\n## Integration with Search System\n\nThe expression evaluation system is integrated with Qdrant's hybrid search capabilities, allowing complex scoring formulas to be applied to search results across multiple stages.\n\n```\n```",
    "metadata": {
      "source_file": "qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant-client",
      "filename": "_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "file_extension": ".md",
      "chunk_index": 10,
      "token_count": 288,
      "char_count": 994,
      "start_char": 8944,
      "end_char": 9940
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md:chunk:11",
    "content": "allowing complex scoring formulas to be applied to search results across multiple stages.\n\n```\n```\n\nSources: [qdrant\\_client/hybrid/formula.py19-26](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L19-L26) [qdrant\\_client/conversions/common\\_types.py](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/conversions/common_types.py)\n\nDismiss\n\nRefresh this wiki\n\nEnter email to refresh\n\n### On this page\n\n- [Expression Evaluation](#expression-evaluation.md)\n- [Purpose and Scope](#purpose-and-scope.md)\n- [System Architecture](#system-architecture.md)\n- [Core Expression Types](#core-expression-types.md)\n- [Mathematical Expressions](#mathematical-expressions.md)\n- [Variable Resolution System](#variable-resolution-system.md)\n- [Decay Functions](#decay-functions.md)\n- [Linear Decay](#linear-decay.md)\n- [Exponential Decay](#exponential-decay.md)\n- [Gaussian Decay](#gaussian-decay.md)\n- [Geographical and Datetime Expressions](#geographical-and-datetime-expressions.md)",
    "metadata": {
      "source_file": "qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant-client",
      "filename": "_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "file_extension": ".md",
      "chunk_index": 11,
      "token_count": 276,
      "char_count": 1024,
      "start_char": 9840,
      "end_char": 10865
    }
  },
  {
    "chunk_id": "qdrant_ecosystem:qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md:chunk:12",
    "content": "sian-decay.md)\n- [Geographical and Datetime Expressions](#geographical-and-datetime-expressions.md)\n- [Geographical Distance Calculation](#geographical-distance-calculation.md)\n- [Datetime Expressions](#datetime-expressions.md)\n- [Error Handling and Validation](#error-handling-and-validation.md)\n- [Mathematical Error Handling](#mathematical-error-handling.md)\n- [Validation Functions](#validation-functions.md)\n- [Testing Infrastructure](#testing-infrastructure.md)\n- [Integration with Search System](#integration-with-search-system.md)",
    "metadata": {
      "source_file": "qdrant_qdrant-client\\_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "source_collection": "qdrant_ecosystem",
      "subdirectory": "qdrant_qdrant-client",
      "filename": "_qdrant_qdrant-client_5.3-expression-evaluation.md",
      "file_extension": ".md",
      "chunk_index": 12,
      "token_count": 122,
      "char_count": 538,
      "start_char": 10765,
      "end_char": 11789
    }
  }
]