[
  {
    "text": "Update Processing Pipeline | qdrant/qdrant | DeepWiki\n\n[Index your code with Devin](private-repo.md)\n\n[DeepWiki](https://deepwiki.com)\n\n[DeepWiki](.md)\n\n[qdrant/qdrant](https://github.com/qdrant/qdrant \"Open repository\")\n\n[Index your code with](private-repo.md)\n\n[Devin](private-repo.md)\n\nShare\n\nLast indexed: 4 October 2025 ([48203e](https://github.com/qdrant/qdrant/commits/48203e41))\n\n- [Introduction to Qdrant](qdrant/qdrant/1-introduction-to-qdrant.md)\n- [Key Concepts and Terminology](qdrant/qdrant/1.1-key-concepts-and-terminology.md)\n- [System Architecture](qdrant/qdrant/2-system-architecture.md)\n- [Application Initialization and Runtime](qdrant/qdrant/2.1-application-initialization-and-runtime.md)\n- [Collections and Table of Content](qdrant/qdrant/2.2-collections-and-table-of-content.md)\n- [Shards and Replica Sets](qdrant/qdrant/2.3-shards-and-replica-sets.md)\n- [Local Shard Architecture](qdrant/qdrant/2.4-local-shard-architecture.md)\n- [Segment Lifecycle and Construction](qdrant/qdrant/2.5-segment-lifecycle-and-construction.md)\n- [Vector Storage and Indexing](qdrant/qdrant/3-vector-storage-and-indexing.md)\n- [Vector Storage Formats](qdrant/qdrant/3.1-vector-storage-formats.md)\n- [HNSW Index Implementation](qdrant/qdrant/3.2-hnsw-index-implementation.md)\n- [Vector Quantization](qdrant/qdrant/3.3-vector-quantization.md)\n- [Sparse Vector Indexing](qdrant/qdrant/3.4-sparse-vector-indexing.md)\n- [Payload Indexing and Filtering](qdrant/qdrant/4-payload-indexing-and-filtering.md)\n- [Field Index Types](qdrant/qdrant/4.1-field-index-types.md)\n- [Index Selection and Storage Backends](qdrant/qdrant/4.2-index-selection-and-storage-backends.md)\n- [Search and Query Processing](qdrant/qdrant/5-search-and-query-processing.md)\n- [Query Request Flow](qdrant/qdrant/5.1-query-request-flow.md)\n- [Filtering and Scoring](qdrant/qdrant/5.2-filtering-and-scoring.md)\n- [Data Updates and Consistency](qdrant/qdrant/6-data-updates-and-consistency.md)\n- [Update Processing Pipeline](qdrant/qdrant/6.1-update-processing-pipeline.md)\n- [Write Consistency and Replication](qdrant/qdrant/6.2-write-consistency-and-replication.md)\n- [Distributed System Features](qdrant/qdrant/7-distributed-system-features.md)\n- [Raft Consensus Protocol](qdrant/qdrant/7.1-raft-consensus-protocol.md)\n- [Shard Transfers and Resharding](qdrant/qdrant/7.2-shard-transfers-and-resharding.md)\n- [Snapshots and Recovery](qdrant/qdrant/8-snapshots-and-recovery.md)\n- [API Reference](qdrant/qdrant/9-api-reference.md)\n- [REST API Endpoints](qdrant/qdrant/9.1-rest-api-endpoints.md)\n- [gRPC API Services](qdrant/qdrant/9.2-grpc-api-services.md)\n- [Data Types and Conversions](qdrant/qdrant/9.3-data-types-and-conversions.md)\n- [Configuration and Deployment](qdrant/qdrant/10-configuration-and-deployment.md)\n- [Configuration System](qdrant/qdrant/10.1-configuration-system.md)\n- [Docker Deployment](qdrant/qdrant/10.2-docker-deployment.md)\n- [Building and CI/CD](qdrant/qdrant/10.3-building-and-cicd.md)\n- [Development Guide](qdrant/qdrant/11-development-guide.md)\n\nMenu\n\n# Update Processing and Optimization\n\nRelevant source files",
    "metadata": {
      "chunk_id": 0,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\Qdrant\\qdrant_qdrant\\_qdrant_qdrant_6.1-update-processing-pipeline.md",
      "input_type": "qdrant",
      "chunking_strategy": "platform_documentation",
      "token_count": 951,
      "character_count": 3110,
      "created_at": "2025-10-16T17:42:31.834484",
      "parent_context": null,
      "semantic_type": "qdrant",
      "collection_name": "Qdrant",
      "subfolder_name": "qdrant_qdrant",
      "collection_strategy": "platform_documentation",
      "chunk_index_in_file": 0,
      "file_relative_path": "Qdrant\\qdrant_qdrant\\_qdrant_qdrant_6.1-update-processing-pipeline.md",
      "collection_context": "Qdrant/qdrant_qdrant"
    }
  },
  {
    "text": "- [lib/collection/src/collection\\_manager/collection\\_updater.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/collection_manager/collection_updater.rs)\n- [lib/collection/src/shards/local\\_shard/mod.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/local_shard/mod.rs)\n- [lib/collection/src/shards/local\\_shard/scroll.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/local_shard/scroll.rs)\n- [lib/collection/src/shards/local\\_shard/snapshot.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/local_shard/snapshot.rs)\n- [lib/collection/src/shards/local\\_shard/snapshot\\_tests.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/shards/local_shard/snapshot_tests.rs)\n- [lib/collection/src/update\\_handler.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/update_handler.rs)\n\nThis page covers Qdrant's update processing pipeline and segment optimization system. Update processing handles the ingestion and application of point operations (inserts, updates, deletes) to collection segments, while optimization manages background maintenance tasks that rebuild and consolidate segments for better performance.\n\nFor information about collection lifecycle management and configuration, see [Collection Management](qdrant/qdrant/5-search-and-query-processing.md). For details about snapshot creation and recovery mechanisms, see [Snapshots and Recovery](qdrant/qdrant/5.2-filtering-and-scoring.md).\n\n## Overview\n\nQdrant's update processing and optimization system operates through three main worker processes managed by the `UpdateHandler`:\n\n- **Update Worker**: Processes incoming point operations and applies them to segments\n- **Optimizer Worker**: Monitors segment conditions and launches optimization tasks\n- **Flush Worker**: Periodically flushes segment data to disk and manages WAL cleanup\n\nThe system uses a copy-on-write approach during optimization, allowing reads and writes to continue while segments are being rebuilt in the background.\n\n## Update Handler Architecture\n\nThe `UpdateHandler` serves as the central coordinator for all update and optimization operations within a collection shard.\n\n```\n```\n\nSources: [lib/collection/src/update\\_handler.rs87-129](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/update_handler.rs#L87-L129) [lib/collection/src/update\\_handler.rs172-205](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/update_handler.rs#L172-L205)\n\n## Update Processing Pipeline\n\n### Update Worker\n\nThe update worker processes incoming operations sequentially, ensuring consistency and proper ordering.\n\n```\n```\n\nThe update worker handles several operation types:\n\n| Signal Type | Purpose                    | Action                                  |\n| ----------- | -------------------------- | --------------------------------------- |\n| `Operation` | Point update/insert/delete | Apply to segments, trigger optimization |\n| `Stop`      | Shutdown signal            | Graceful worker termination             |\n| `Nop`       | Trigger optimization       | Signal optimizer without operation      |\n| `Plunger`   | Synchronization            | Ensure previous updates are applied     |\n\nSources: [lib/collection/src/update\\_handler.rs691-761](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/update_handler.rs#L691-L761) [lib/collection/src/update\\_handler.rs63-74](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/update_handler.rs#L63-L74)\n\n### Write-Ahead Log Integration\n\nUpdates are written to the WAL before being applied to segments, ensuring durability:\n\n```\n```\n\nSources: [lib/collection/src/update\\_handler.rs706-714](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/update_handler.rs#L706-L714) [lib/collection/src/update\\_handler.rs831-834](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/update_handler.rs#L831-L834)\n\n## Optimization System\n\n### Optimizer Types\n\nQdrant implements four main optimizers, each addressing specific segment maintenance needs:\n\n#### Indexing Optimizer\n\nCreates indexes for segments that exceed size thresholds but lack proper indexing:\n\n```\n```\n\nSources: [lib/collection/src/collection\\_manager/optimizers/indexing\\_optimizer.rs94-184](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/collection_manager/optimizers/indexing_optimizer.rs#L94-L184)\n\n#### Merge Optimizer",
    "metadata": {
      "chunk_id": 1,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\Qdrant\\qdrant_qdrant\\_qdrant_qdrant_6.1-update-processing-pipeline.md",
      "input_type": "qdrant",
      "chunking_strategy": "platform_documentation",
      "token_count": 1022,
      "character_count": 4489,
      "created_at": "2025-10-16T17:42:31.844390",
      "parent_context": null,
      "semantic_type": "qdrant",
      "collection_name": "Qdrant",
      "subfolder_name": "qdrant_qdrant",
      "collection_strategy": "platform_documentation",
      "chunk_index_in_file": 1,
      "file_relative_path": "Qdrant\\qdrant_qdrant\\_qdrant_qdrant_6.1-update-processing-pipeline.md",
      "collection_context": "Qdrant/qdrant_qdrant"
    }
  },
  {
    "text": "Consolidates small segments to maintain optimal segment count:\n\n```\n```\n\nSources: [lib/collection/src/collection\\_manager/optimizers/merge\\_optimizer.rs96-151](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/collection_manager/optimizers/merge_optimizer.rs#L96-L151)\n\n#### Vacuum Optimizer\n\nRemoves soft-deleted points and rebuilds fragmented indexes:\n\n```\n```\n\nSources: [lib/collection/src/collection\\_manager/optimizers/vacuum\\_optimizer.rs67-88](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/collection_manager/optimizers/vacuum_optimizer.rs#L67-L88)\n\n#### Config Mismatch Optimizer\n\nRebuilds segments when collection configuration changes require different segment parameters:\n\nSources: [lib/collection/src/collection\\_manager/optimizers/config\\_mismatch\\_optimizer.rs104-215](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/collection_manager/optimizers/config_mismatch_optimizer.rs#L104-L215)\n\n### Optimization Process\n\nThe optimization process uses proxy segments to maintain availability during rebuilding:\n\n```\n```\n\nSources: [lib/collection/src/collection\\_manager/optimizers/segment\\_optimizer.rs576-685](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/collection_manager/optimizers/segment_optimizer.rs#L576-L685)\n\n## Segment Builder\n\nThe `SegmentBuilder` constructs optimized segments by combining data from multiple source segments:\n\n```\n```\n\nKey building steps include:\n\n1. **Data Copying**: Transfer vectors and payloads from source segments\n2. **Index Building**: Create HNSW or other indexes based on configuration\n3. **Quantization**: Apply vector compression if configured\n4. **Defragmentation**: Reorganize data for better locality\n\nSources: [lib/segment/src/segment\\_constructor/segment\\_builder.rs459-685](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/segment_constructor/segment_builder.rs#L459-L685)\n\n## Resource Management\n\n### CPU and IO Budgeting\n\nOptimization tasks use resource permits to control concurrent operations:\n\n```\n```\n\nSources: [lib/collection/src/update\\_handler.rs270-326](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/update_handler.rs#L270-L326) [lib/collection/src/update\\_handler.rs521-526](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/update_handler.rs#L521-L526)\n\n### Optimization Limits\n\nThe system enforces several limits to prevent resource exhaustion:\n\n| Parameter                   | Purpose                               | Configuration    |\n| --------------------------- | ------------------------------------- | ---------------- |\n| `max_optimization_threads`  | Concurrent optimizations per shard    | Optimizer config |\n| `optimizer_resource_budget` | CPU/IO permits available              | Global budget    |\n| `max_segment_size_kb`       | Maximum segment size before splitting | Threshold config |\n\nSources: [lib/collection/src/update\\_handler.rs121-123](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/update_handler.rs#L121-L123) [lib/collection/src/collection\\_manager/optimizers/segment\\_optimizer.rs37-42](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/collection_manager/optimizers/segment_optimizer.rs#L37-L42)\n\n## Flush Operations\n\nThe flush worker manages periodic data persistence and WAL cleanup:\n\n```\n```\n\nThe flush interval is configurable through `flush_interval_sec`, with a default of 5 seconds in development mode.\n\nSources: [lib/collection/src/update\\_handler.rs769-835](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/update_handler.rs#L769-L835) [config/development.yaml28](https://github.com/qdrant/qdrant/blob/48203e41/config/development.yaml#L28-L28)\n\n## Error Handling and Recovery\n\n### Failed Operation Recovery\n\nThe system maintains tracking of failed operations and attempts recovery:\n\n```\n```\n\nSources: [lib/collection/src/update\\_handler.rs247-265](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/update_handler.rs#L247-L265)\n\n### Optimization Cancellation\n\nOptimizations can be cancelled gracefully, restoring original segments:",
    "metadata": {
      "chunk_id": 2,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\Qdrant\\qdrant_qdrant\\_qdrant_qdrant_6.1-update-processing-pipeline.md",
      "input_type": "qdrant",
      "chunking_strategy": "platform_documentation",
      "token_count": 965,
      "character_count": 4125,
      "created_at": "2025-10-16T17:42:31.854240",
      "parent_context": null,
      "semantic_type": "qdrant",
      "collection_name": "Qdrant",
      "subfolder_name": "qdrant_qdrant",
      "collection_strategy": "platform_documentation",
      "chunk_index_in_file": 2,
      "file_relative_path": "Qdrant\\qdrant_qdrant\\_qdrant_qdrant_6.1-update-processing-pipeline.md",
      "collection_context": "Qdrant/qdrant_qdrant"
    }
  },
  {
    "text": "Sources: [lib/collection/src/update\\_handler.rs381-396](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/update_handler.rs#L381-L396) [lib/collection/src/collection\\_manager/optimizers/segment\\_optimizer.rs341-396](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/collection_manager/optimizers/segment_optimizer.rs#L341-L396)\n\nDismiss\n\nRefresh this wiki\n\nEnter email to refresh\n\n### On this page\n\n- [Update Processing and Optimization](#update-processing-and-optimization.md)\n- [Overview](#overview.md)\n- [Update Handler Architecture](#update-handler-architecture.md)\n- [Update Processing Pipeline](#update-processing-pipeline.md)\n- [Update Worker](#update-worker.md)\n- [Write-Ahead Log Integration](#write-ahead-log-integration.md)\n- [Optimization System](#optimization-system.md)\n- [Optimizer Types](#optimizer-types.md)\n- [Indexing Optimizer](#indexing-optimizer.md)\n- [Merge Optimizer](#merge-optimizer.md)\n- [Vacuum Optimizer](#vacuum-optimizer.md)\n- [Config Mismatch Optimizer](#config-mismatch-optimizer.md)\n- [Optimization Process](#optimization-process.md)\n- [Segment Builder](#segment-builder.md)\n- [Resource Management](#resource-management.md)\n- [CPU and IO Budgeting](#cpu-and-io-budgeting.md)\n- [Optimization Limits](#optimization-limits.md)\n- [Flush Operations](#flush-operations.md)\n- [Error Handling and Recovery](#error-handling-and-recovery.md)\n- [Failed Operation Recovery](#failed-operation-recovery.md)\n- [Optimization Cancellation](#optimization-cancellation.md)",
    "metadata": {
      "chunk_id": 3,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\Qdrant\\qdrant_qdrant\\_qdrant_qdrant_6.1-update-processing-pipeline.md",
      "input_type": "qdrant",
      "chunking_strategy": "platform_documentation",
      "token_count": 386,
      "character_count": 1519,
      "created_at": "2025-10-16T17:42:31.854728",
      "parent_context": null,
      "semantic_type": "qdrant",
      "collection_name": "Qdrant",
      "subfolder_name": "qdrant_qdrant",
      "collection_strategy": "platform_documentation",
      "chunk_index_in_file": 3,
      "file_relative_path": "Qdrant\\qdrant_qdrant\\_qdrant_qdrant_6.1-update-processing-pipeline.md",
      "collection_context": "Qdrant/qdrant_qdrant"
    }
  }
]