[
  {
    "text": "Raft Consensus Protocol | qdrant/qdrant | DeepWiki\n\n[Index your code with Devin](private-repo.md)\n\n[DeepWiki](https://deepwiki.com)\n\n[DeepWiki](.md)\n\n[qdrant/qdrant](https://github.com/qdrant/qdrant \"Open repository\")\n\n[Index your code with](private-repo.md)\n\n[Devin](private-repo.md)\n\nShare\n\nLast indexed: 4 October 2025 ([48203e](https://github.com/qdrant/qdrant/commits/48203e41))\n\n- [Introduction to Qdrant](qdrant/qdrant/1-introduction-to-qdrant.md)\n- [Key Concepts and Terminology](qdrant/qdrant/1.1-key-concepts-and-terminology.md)\n- [System Architecture](qdrant/qdrant/2-system-architecture.md)\n- [Application Initialization and Runtime](qdrant/qdrant/2.1-application-initialization-and-runtime.md)\n- [Collections and Table of Content](qdrant/qdrant/2.2-collections-and-table-of-content.md)\n- [Shards and Replica Sets](qdrant/qdrant/2.3-shards-and-replica-sets.md)\n- [Local Shard Architecture](qdrant/qdrant/2.4-local-shard-architecture.md)\n- [Segment Lifecycle and Construction](qdrant/qdrant/2.5-segment-lifecycle-and-construction.md)\n- [Vector Storage and Indexing](qdrant/qdrant/3-vector-storage-and-indexing.md)\n- [Vector Storage Formats](qdrant/qdrant/3.1-vector-storage-formats.md)\n- [HNSW Index Implementation](qdrant/qdrant/3.2-hnsw-index-implementation.md)\n- [Vector Quantization](qdrant/qdrant/3.3-vector-quantization.md)\n- [Sparse Vector Indexing](qdrant/qdrant/3.4-sparse-vector-indexing.md)\n- [Payload Indexing and Filtering](qdrant/qdrant/4-payload-indexing-and-filtering.md)\n- [Field Index Types](qdrant/qdrant/4.1-field-index-types.md)\n- [Index Selection and Storage Backends](qdrant/qdrant/4.2-index-selection-and-storage-backends.md)\n- [Search and Query Processing](qdrant/qdrant/5-search-and-query-processing.md)\n- [Query Request Flow](qdrant/qdrant/5.1-query-request-flow.md)\n- [Filtering and Scoring](qdrant/qdrant/5.2-filtering-and-scoring.md)\n- [Data Updates and Consistency](qdrant/qdrant/6-data-updates-and-consistency.md)\n- [Update Processing Pipeline](qdrant/qdrant/6.1-update-processing-pipeline.md)\n- [Write Consistency and Replication](qdrant/qdrant/6.2-write-consistency-and-replication.md)\n- [Distributed System Features](qdrant/qdrant/7-distributed-system-features.md)\n- [Raft Consensus Protocol](qdrant/qdrant/7.1-raft-consensus-protocol.md)\n- [Shard Transfers and Resharding](qdrant/qdrant/7.2-shard-transfers-and-resharding.md)\n- [Snapshots and Recovery](qdrant/qdrant/8-snapshots-and-recovery.md)\n- [API Reference](qdrant/qdrant/9-api-reference.md)\n- [REST API Endpoints](qdrant/qdrant/9.1-rest-api-endpoints.md)\n- [gRPC API Services](qdrant/qdrant/9.2-grpc-api-services.md)\n- [Data Types and Conversions](qdrant/qdrant/9.3-data-types-and-conversions.md)\n- [Configuration and Deployment](qdrant/qdrant/10-configuration-and-deployment.md)\n- [Configuration System](qdrant/qdrant/10.1-configuration-system.md)\n- [Docker Deployment](qdrant/qdrant/10.2-docker-deployment.md)\n- [Building and CI/CD](qdrant/qdrant/10.3-building-and-cicd.md)\n- [Development Guide](qdrant/qdrant/11-development-guide.md)\n\nMenu\n\n# Raft Consensus Protocol\n\nRelevant source files",
    "metadata": {
      "chunk_id": 0,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\Qdrant\\qdrant_qdrant\\_qdrant_qdrant_7.1-raft-consensus-protocol.md",
      "input_type": "qdrant",
      "chunking_strategy": "platform_documentation",
      "token_count": 954,
      "character_count": 3096,
      "created_at": "2025-10-16T17:42:31.955851",
      "parent_context": null,
      "semantic_type": "qdrant",
      "collection_name": "Qdrant",
      "subfolder_name": "qdrant_qdrant",
      "collection_strategy": "platform_documentation",
      "chunk_index_in_file": 0,
      "file_relative_path": "Qdrant\\qdrant_qdrant\\_qdrant_qdrant_7.1-raft-consensus-protocol.md",
      "collection_context": "Qdrant/qdrant_qdrant"
    }
  },
  {
    "text": "- [config/config.yaml](https://github.com/qdrant/qdrant/blob/48203e41/config/config.yaml)\n- [lib/collection/src/common/snapshots\\_manager.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/common/snapshots_manager.rs)\n- [lib/collection/src/operations/shared\\_storage\\_config.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/collection/src/operations/shared_storage_config.rs)\n- [lib/storage/src/content\\_manager/mod.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/storage/src/content_manager/mod.rs)\n- [lib/storage/src/types.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/storage/src/types.rs)\n- [src/actix/api/cluster\\_api.rs](https://github.com/qdrant/qdrant/blob/48203e41/src/actix/api/cluster_api.rs)\n- [src/actix/api/mod.rs](https://github.com/qdrant/qdrant/blob/48203e41/src/actix/api/mod.rs)\n- [src/actix/certificate\\_helpers.rs](https://github.com/qdrant/qdrant/blob/48203e41/src/actix/certificate_helpers.rs)\n- [src/actix/mod.rs](https://github.com/qdrant/qdrant/blob/48203e41/src/actix/mod.rs)\n- [src/common/helpers.rs](https://github.com/qdrant/qdrant/blob/48203e41/src/common/helpers.rs)\n- [src/common/http\\_client.rs](https://github.com/qdrant/qdrant/blob/48203e41/src/common/http_client.rs)\n- [src/consensus.rs](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs)\n- [src/main.rs](https://github.com/qdrant/qdrant/blob/48203e41/src/main.rs)\n- [src/settings.rs](https://github.com/qdrant/qdrant/blob/48203e41/src/settings.rs)\n- [src/tonic/api/raft\\_api.rs](https://github.com/qdrant/qdrant/blob/48203e41/src/tonic/api/raft_api.rs)\n- [src/tonic/mod.rs](https://github.com/qdrant/qdrant/blob/48203e41/src/tonic/mod.rs)\n\nThis document describes the implementation of the Raft consensus protocol in Qdrant's distributed deployment mode. The Raft implementation coordinates metadata operations across cluster peers, ensuring that collection configurations, shard assignments, and peer membership changes are consistently applied across all nodes.\n\nFor information about data-level replication and shard transfers, see [Shard Transfers and Resharding](qdrant/qdrant/7.2-shard-transfers-and-resharding.md). For general distributed system concepts, see [Distributed System Features](qdrant/qdrant/7-distributed-system-features.md).\n\n---\n\n## Purpose and Scope\n\nThe Raft consensus protocol in Qdrant serves a specific role: **coordinating metadata operations** across the cluster. This includes:\n\n- Collection creation, deletion, and configuration changes\n- Shard assignment and replica placement\n- Peer membership (adding/removing nodes)\n- Shard transfer coordination\n- Cluster metadata key-value storage\n\n**What Raft does NOT handle:**\n\n- Individual point operations (upserts, deletes) - these use optimistic replication with logical clocks\n- Search queries - these are routed directly to appropriate shards\n- Shard-level data replication - handled by `ShardReplicaSet` with write consistency factors\n\nThe consensus layer operates independently from data operations, allowing high throughput for vector operations while maintaining strong consistency for cluster topology changes.\n\nSources: [src/consensus.rs1-150](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L1-L150) [lib/storage/src/content\\_manager/consensus\\_ops.rs20-207](https://github.com/qdrant/qdrant/blob/48203e41/lib/storage/src/content_manager/consensus_ops.rs#L20-L207)\n\n---\n\n## Architecture Overview\n\n```\n```\n\n**Key Components:**",
    "metadata": {
      "chunk_id": 1,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\Qdrant\\qdrant_qdrant\\_qdrant_qdrant_7.1-raft-consensus-protocol.md",
      "input_type": "qdrant",
      "chunking_strategy": "platform_documentation",
      "token_count": 905,
      "character_count": 3470,
      "created_at": "2025-10-16T17:42:31.961348",
      "parent_context": null,
      "semantic_type": "qdrant",
      "collection_name": "Qdrant",
      "subfolder_name": "qdrant_qdrant",
      "collection_strategy": "platform_documentation",
      "chunk_index_in_file": 1,
      "file_relative_path": "Qdrant\\qdrant_qdrant\\_qdrant_qdrant_7.1-raft-consensus-protocol.md",
      "collection_context": "Qdrant/qdrant_qdrant"
    }
  },
  {
    "text": "| Component           | Type             | Purpose                                          |\n| ------------------- | ---------------- | ------------------------------------------------ |\n| `Consensus`         | Thread Runner    | Main consensus loop processing Raft protocol     |\n| `RawNode`           | Raft Library     | `raft` crate's Raft node implementation          |\n| `ConsensusStateRef` | State Manager    | `Arc<ConsensusManager>` managing consensus state |\n| `Persistent`        | WAL Storage      | Persistent Raft log and hard state               |\n| `OperationSender`   | Proposal Channel | High-level API for proposing operations          |\n| `RaftService`       | gRPC Service     | Receives Raft messages from peers                |\n| `RaftMessageBroker` | Message Sender   | Sends Raft messages to peers                     |\n\nSources: [src/consensus.rs34-58](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L34-L58) [src/main.rs329-447](https://github.com/qdrant/qdrant/blob/48203e41/src/main.rs#L329-L447) [lib/storage/src/content\\_manager/consensus\\_manager.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/storage/src/content_manager/consensus_manager.rs)\n\n---\n\n## Consensus Thread Lifecycle\n\nThe consensus thread is spawned during service initialization and runs independently from the main application logic:\n\n```\n```\n\n**Thread Initialization Steps:**\n\n1. **Load Persistent State** [src/main.rs273-278](https://github.com/qdrant/qdrant/blob/48203e41/src/main.rs#L273-L278) - `Persistent::load_or_init()` loads existing Raft state or initializes new state with optional peer\\_id\n2. **Create Consensus Instance** [src/consensus.rs174-283](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L174-L283) - `Consensus::new()` sets up Raft config, channels, and determines if initialization or recovery is needed\n3. **Bootstrap or Recover** [src/consensus.rs286-463](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L286-L463) - New deployments bootstrap from a peer or self-initialize; existing deployments recover by notifying peers of address changes\n4. **Apply Uncommitted Entries** [src/consensus.rs249-251](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L249-L251) - Before starting the loop, apply any committed but unapplied entries from previous shutdown\n5. **Start Main Loop** [src/consensus.rs465-546](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L465-L546) - Enter infinite loop processing Raft protocol\n\nSources: [src/consensus.rs60-170](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L60-L170) [src/main.rs273-447](https://github.com/qdrant/qdrant/blob/48203e41/src/main.rs#L273-L447)\n\n---\n\n## Operation Types and Flow\n\nAll operations that require cluster-wide consensus are modeled as `ConsensusOperations`:\n\n```\n```\n\n**Operation Processing Flow:**\n\n```\n```\n\n**Helper Methods for Common Operations:**\n\nThe `ConsensusOperations` enum provides factory methods for common patterns:",
    "metadata": {
      "chunk_id": 2,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\Qdrant\\qdrant_qdrant\\_qdrant_qdrant_7.1-raft-consensus-protocol.md",
      "input_type": "qdrant",
      "chunking_strategy": "platform_documentation",
      "token_count": 755,
      "character_count": 3015,
      "created_at": "2025-10-16T17:42:31.966911",
      "parent_context": null,
      "semantic_type": "qdrant",
      "collection_name": "Qdrant",
      "subfolder_name": "qdrant_qdrant",
      "collection_strategy": "platform_documentation",
      "chunk_index_in_file": 2,
      "file_relative_path": "Qdrant\\qdrant_qdrant\\_qdrant_qdrant_7.1-raft-consensus-protocol.md",
      "collection_context": "Qdrant/qdrant_qdrant"
    }
  },
  {
    "text": "| Method                 | Purpose                   | Citation                                                                                                                                                               |\n| ---------------------- | ------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n| `abort_transfer()`     | Abort a shard transfer    | [lib/storage/src/content\\_manager/consensus\\_ops.rs70-82](https://github.com/qdrant/qdrant/blob/48203e41/lib/storage/src/content_manager/consensus_ops.rs#L70-L82)     |\n| `finish_transfer()`    | Complete a shard transfer | [lib/storage/src/content\\_manager/consensus\\_ops.rs84-89](https://github.com/qdrant/qdrant/blob/48203e41/lib/storage/src/content_manager/consensus_ops.rs#L84-L89)     |\n| `set_replica_state()`  | Change replica state      | [lib/storage/src/content\\_manager/consensus\\_ops.rs105-122](https://github.com/qdrant/qdrant/blob/48203e41/lib/storage/src/content_manager/consensus_ops.rs#L105-L122) |\n| `initialize_replica()` | Mark replica as Active    | [lib/storage/src/content\\_manager/consensus\\_ops.rs151-163](https://github.com/qdrant/qdrant/blob/48203e41/lib/storage/src/content_manager/consensus_ops.rs#L151-L163) |\n| `start_transfer()`     | Begin shard transfer      | [lib/storage/src/content\\_manager/consensus\\_ops.rs165-170](https://github.com/qdrant/qdrant/blob/48203e41/lib/storage/src/content_manager/consensus_ops.rs#L165-L170) |\n\nSources: [lib/storage/src/content\\_manager/consensus\\_ops.rs38-207](https://github.com/qdrant/qdrant/blob/48203e41/lib/storage/src/content_manager/consensus_ops.rs#L38-L207) [src/consensus.rs627-696](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L627-L696)\n\n---\n\n## Bootstrapping and Peer Management\n\n### First Peer (Origin Peer)\n\nThe first peer in a cluster starts without a bootstrap URI and self-initializes:\n\n```\n```\n\nThe origin peer goes through special handling in `try_add_origin()` [src/consensus.rs720-777](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L720-L777):\n\n- Only executes if peer count is 1 and commit index â‰¤ 1\n- Waits until the peer self-elects as Leader\n- Proposes itself as a voter (AddNode conf change)\n\n### Adding a New Peer\n\nWhen a new peer joins the cluster:\n\n```\n```\n\n**Learner Promotion Logic** [src/consensus.rs784-832](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L784-L832):\n\n- Only the leader promotes learners\n- Promotion only happens when there are no uncommitted changes (commit == last\\_log\\_entry)\n- A learner is promoted when its `matched` index equals the current `commit` index\n- Learners are promoted one at a time to ensure safety\n\n**Recovery After Restart** [src/consensus.rs358-418](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L358-L418): If a peer restarts with a different URI, it notifies other peers:\n\n- Tries to contact any known peer via `add_peer_to_known` with new URI\n- Uses exponential backoff with up to 3 retries\n- Other peers update their `peer_address_by_id` mapping\n\nSources: [src/consensus.rs286-323](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L286-L323) [src/consensus.rs420-463](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L420-L463) [src/tonic/api/raft\\_api.rs64-149](https://github.com/qdrant/qdrant/blob/48203e41/src/tonic/api/raft_api.rs#L64-L149)\n\n---\n\n## Message Processing and Raft Loop\n\nThe consensus thread runs a continuous loop processing two types of messages:\n\n### Message Types\n\n```\n```\n\n### Main Loop Structure\n\nThe consensus loop in `start()` [src/consensus.rs465-546](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L465-L546) operates as follows:\n\n```\n```\n\n**Key Loop Features:**",
    "metadata": {
      "chunk_id": 3,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\Qdrant\\qdrant_qdrant\\_qdrant_qdrant_7.1-raft-consensus-protocol.md",
      "input_type": "qdrant",
      "chunking_strategy": "platform_documentation",
      "token_count": 990,
      "character_count": 3861,
      "created_at": "2025-10-16T17:42:31.977275",
      "parent_context": null,
      "semantic_type": "qdrant",
      "collection_name": "Qdrant",
      "subfolder_name": "qdrant_qdrant",
      "collection_strategy": "platform_documentation",
      "chunk_index_in_file": 3,
      "file_relative_path": "Qdrant\\qdrant_qdrant\\_qdrant_qdrant_7.1-raft-consensus-protocol.md",
      "collection_context": "Qdrant/qdrant_qdrant"
    }
  },
  {
    "text": "1. **Batching**: Processes up to 128 messages per iteration for efficiency [src/consensus.rs559](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L559-L559)\n2. **Tick Capping**: If Raft messages were received, caps reported ticks to prevent spurious elections [src/consensus.rs488-513](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L488-L513)\n3. **Early Break on Conf-Change**: Only one conf-change can be pending at a time [src/consensus.rs587-611](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L587-L611)\n4. **Idle Detection**: After 3 idle cycles with activity, syncs local state changes [src/consensus.rs541-544](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L541-L544)\n\nSources: [src/consensus.rs465-546](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L465-L546) [src/consensus.rs548-625](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L548-L625)\n\n---\n\n## Processing Ready State\n\nWhen the Raft node has updates to process, the `on_ready()` method handles the work:\n\n```\n```\n\n**Ready State Components** [src/consensus.rs834-979](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L834-L979):\n\n| Component           | Purpose                                          |\n| ------------------- | ------------------------------------------------ |\n| `snapshot`          | Full state snapshot to apply (for lagging peers) |\n| `hs` (HardState)    | Persistent Raft state: term, vote, commit        |\n| `entries`           | Log entries to persist                           |\n| `committed_entries` | Entries to apply to state machine                |\n| `messages`          | Raft messages to send to peers                   |\n| `conf_state`        | Updated cluster configuration                    |\n\n**Entry Application** [lib/storage/src/content\\_manager/consensus/state.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/storage/src/content_manager/consensus/state.rs):\n\n- Decodes each entry's data as `ConsensusOperations` (CBOR format)\n- Routes `CollectionMeta` operations to `TableOfContent`\n- Updates `peer_address_by_id` for peer management operations\n- Updates `cluster_metadata` for metadata operations\n- Tracks `last_applied_entry` to avoid re-application\n\nSources: [src/consensus.rs834-979](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L834-L979) [src/consensus.rs981-1133](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L981-L1133)\n\n---\n\n## Sending Messages to Peers\n\nThe `RaftMessageBroker` handles sending Raft protocol messages to other peers:\n\n```\n```\n\n**Message Sending Process** [src/consensus.rs1135-1308](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L1135-L1308):\n\n1. **Batch Messages**: Groups messages by destination peer ID\n2. **Spawn Async Tasks**: Uses tokio runtime to send messages concurrently\n3. **Get gRPC Channel**: Retrieves connection from `TransportChannelPool`\n4. **Encode and Send**: Encodes Raft message as protobuf and sends via `RaftClient::send()`\n5. **Error Tracking**: Records failures in `message_send_failures` for monitoring\n\n**Message Batching Strategy**:\n\n- Messages are batched per peer to reduce task overhead\n- Each batch is sent in a single async task\n- Failures are logged but don't block the consensus loop\n\n**Special Handling for Snapshots** [src/consensus.rs1225-1261](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L1225-L1261):\n\n- Snapshot messages trigger `ConsensusOperations::RequestSnapshot` to be sent to self\n- This ensures snapshots are created in the consensus thread context\n- After creation, `report_snapshot()` notifies Raft of success/failure\n\nSources: [src/consensus.rs1135-1308](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L1135-L1308)\n\n---\n\n## WAL and State Persistence\n\n### Persistent Storage Structure",
    "metadata": {
      "chunk_id": 4,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\Qdrant\\qdrant_qdrant\\_qdrant_qdrant_7.1-raft-consensus-protocol.md",
      "input_type": "qdrant",
      "chunking_strategy": "platform_documentation",
      "token_count": 1020,
      "character_count": 3885,
      "created_at": "2025-10-16T17:42:31.986221",
      "parent_context": null,
      "semantic_type": "qdrant",
      "collection_name": "Qdrant",
      "subfolder_name": "qdrant_qdrant",
      "collection_strategy": "platform_documentation",
      "chunk_index_in_file": 4,
      "file_relative_path": "Qdrant\\qdrant_qdrant\\_qdrant_qdrant_7.1-raft-consensus-protocol.md",
      "collection_context": "Qdrant/qdrant_qdrant"
    }
  },
  {
    "text": "The `Persistent` struct manages Raft's durable state:\n\n```\n```\n\n**State Files**:\n\n| File              | Content                             | Purpose                               |\n| ----------------- | ----------------------------------- | ------------------------------------- |\n| `meta.json`       | `{this_peer_id, is_new_deployment}` | Peer identity and cluster init status |\n| `hard_state.json` | `{term, vote, commit}`              | Raft's persistent hard state          |\n| `conf_state.json` | `{voters, learners, ...}`           | Current cluster configuration         |\n| `raft_log_*.dat`  | CBOR-encoded log entries            | Write-ahead log of operations         |\n| `snapshot_*.dat`  | Consensus state snapshot            | Full state for recovering peers       |\n\n**WAL Compaction** [src/consensus.rs253-258](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L253-L258):\n\n- Compacts WAL when it exceeds `compact_wal_entries` applied operations (default: 128)\n- Creates a snapshot of current state\n- Truncates old log entries before the snapshot\n- Allows faster bootstrap for new peers (transfer snapshot instead of replaying full log)\n\nSources: [lib/storage/src/content\\_manager/consensus/persistent.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/storage/src/content_manager/consensus/persistent.rs) [config/config.yaml314-326](https://github.com/qdrant/qdrant/blob/48203e41/config/config.yaml#L314-L326)\n\n---\n\n## Configuration\n\nThe consensus configuration is specified in `ConsensusConfig`:\n\n```\n```\n\n**Configuration Parameters**:\n\n| Parameter                | Default | Description                                                                         |\n| ------------------------ | ------- | ----------------------------------------------------------------------------------- |\n| `tick_period_ms`         | 100     | How often Raft ticks (in ms). Lower = faster election/heartbeat, higher CPU/network |\n| `bootstrap_timeout_sec`  | 15      | Timeout for initial peer bootstrap requests                                         |\n| `max_message_queue_size` | 100     | Backpressure limit for consensus operation channel                                  |\n| `message_timeout_ticks`  | 10      | (Unused in current implementation)                                                  |\n| `compact_wal_entries`    | 128     | Compact WAL after this many applied entries                                         |\n\n**Derived Timeouts**:\n\n- **Election Timeout**: `tick_period_ms * max_election_tick` (typically \\~2 seconds with default config)\n- **Heartbeat Interval**: `tick_period_ms * heartbeat_tick` (typically \\~1 second)\n- **Leader Established**: `tick_period_ms * max_election_tick` (\\~2 seconds)\n\n**Important Tuning Notes** [config/config.yaml314-326](https://github.com/qdrant/qdrant/blob/48203e41/config/config.yaml#L314-L326):\n\n> \"Setting this parameter to lower value will allow consensus to detect disconnected nodes earlier, but too frequent tick period may create significant network and CPU overhead. We encourage you NOT to change this parameter unless you know what you are doing.\"\n\nSources: [src/settings.rs111-139](https://github.com/qdrant/qdrant/blob/48203e41/src/settings.rs#L111-L139) [config/config.yaml314-326](https://github.com/qdrant/qdrant/blob/48203e41/config/config.yaml#L314-L326) [src/consensus.rs203-209](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L203-L209)\n\n---\n\n## Internal gRPC API\n\nThe `RaftService` provides the gRPC API for inter-peer Raft communication:\n\n```\n```\n\n**RPC Methods**:\n\n| Method                    | Request                 | Response   | Purpose                                   |\n| ------------------------- | ----------------------- | ---------- | ----------------------------------------- |\n| `send`                    | `RaftMessage` (encoded) | `()`       | Receive Raft protocol messages from peers |\n| `who_is`                  | `PeerId`                | `UriStr`   | Resolve peer ID to URI                    |\n| `add_peer_to_known`       | `{id, uri?, port?}`     | `AllPeers` | Bootstrap a new peer into cluster         |\n| `add_peer_as_participant` | `PeerId`                | `()`       | Deprecated, no-op for compatibility       |\n\n**Bootstrap Peer Sequence** [src/tonic/api/raft\\_api.rs64-149](https://github.com/qdrant/qdrant/blob/48203e41/src/tonic/api/raft_api.rs#L64-L149):",
    "metadata": {
      "chunk_id": 5,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\Qdrant\\qdrant_qdrant\\_qdrant_qdrant_7.1-raft-consensus-protocol.md",
      "input_type": "qdrant",
      "chunking_strategy": "platform_documentation",
      "token_count": 979,
      "character_count": 4405,
      "created_at": "2025-10-16T17:42:31.993003",
      "parent_context": null,
      "semantic_type": "qdrant",
      "collection_name": "Qdrant",
      "subfolder_name": "qdrant_qdrant",
      "collection_strategy": "platform_documentation",
      "chunk_index_in_file": 5,
      "file_relative_path": "Qdrant\\qdrant_qdrant\\_qdrant_qdrant_7.1-raft-consensus-protocol.md",
      "collection_context": "Qdrant/qdrant_qdrant"
    }
  },
  {
    "text": "1. New peer calls `add_peer_to_known` on bootstrap peer\n2. Bootstrap peer proposes `ConsensusOperations::AddPeer` with `AddLearnerNode`\n3. Operation replicates and commits via Raft\n4. Bootstrap peer returns `AllPeers` with all current peer addresses plus `first_peer_id`\n5. New peer stores peer addresses and sets initial conf state with `first_voter_id`\n\nSources: [src/tonic/api/raft\\_api.rs1-150](https://github.com/qdrant/qdrant/blob/48203e41/src/tonic/api/raft_api.rs#L1-L150) [src/tonic/mod.rs256-360](https://github.com/qdrant/qdrant/blob/48203e41/src/tonic/mod.rs#L256-L360)\n\n---\n\n## Cluster Metadata Storage\n\nQdrant supports arbitrary key-value metadata storage in consensus:\n\n```\n```\n\n**API Endpoints**:\n\n| Endpoint                       | Method | Description                |\n| ------------------------------ | ------ | -------------------------- |\n| `/cluster/metadata/keys`       | GET    | List all metadata keys     |\n| `/cluster/metadata/keys/{key}` | GET    | Get value for specific key |\n| `/cluster/metadata/keys/{key}` | PUT    | Set value (JSON) for key   |\n| `/cluster/metadata/keys/{key}` | DELETE | Remove key (sets to null)  |\n\n**Use Cases**:\n\n- Storing cluster-wide configuration\n- Coordination flags between nodes\n- Custom metadata for tooling/monitoring\n\nSources: [src/actix/api/cluster\\_api.rs98-178](https://github.com/qdrant/qdrant/blob/48203e41/src/actix/api/cluster_api.rs#L98-L178) [lib/storage/src/content\\_manager/consensus\\_ops.rs50-53](https://github.com/qdrant/qdrant/blob/48203e41/lib/storage/src/content_manager/consensus_ops.rs#L50-L53)\n\n---\n\n## High Priority Thread\n\nThe consensus thread attempts to run with high priority on Linux systems:\n\n```\n```\n\nThis is a best-effort optimization - it will likely fail without elevated permissions but gracefully continues. The reasoning is that consensus timing is critical for cluster stability:\n\n- Election timeouts depend on timely message processing\n- Heartbeat delays can trigger unnecessary leader elections\n- Higher priority reduces latency variance\n\nSources: [src/consensus.rs99-106](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L99-L106) [src/consensus.rs121-128](https://github.com/qdrant/qdrant/blob/48203e41/src/consensus.rs#L121-L128)\n\n---\n\n## Monitoring and Health\n\n### Cluster Status API\n\nThe `/cluster` endpoint returns consensus health information:\n\n```\n```\n\n**Key Metrics**:\n\n- `term`: Current Raft term (increases with elections)\n- `commit`: Index of last committed operation\n- `pending_operations`: Uncommitted entries count\n- `role`: Follower, Candidate, Leader, or PreCandidate\n- `consensus_thread_status`: Working, Stopped, or StoppedWithErr\n\n### Health Tracking\n\nThe `ConsensusManager` tracks consensus health:\n\n- `record_consensus_working()`: Called on each `on_ready()` cycle\n- `on_consensus_thread_err()`: Called if consensus thread panics\n- `on_consensus_stopped()`: Called on clean shutdown\n\nSources: [lib/storage/src/types.rs148-246](https://github.com/qdrant/qdrant/blob/48203e41/lib/storage/src/types.rs#L148-L246) [src/actix/api/cluster\\_api.rs32-41](https://github.com/qdrant/qdrant/blob/48203e41/src/actix/api/cluster_api.rs#L32-L41)\n\nDismiss\n\nRefresh this wiki\n\nEnter email to refresh\n\n### On this page",
    "metadata": {
      "chunk_id": 6,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\Qdrant\\qdrant_qdrant\\_qdrant_qdrant_7.1-raft-consensus-protocol.md",
      "input_type": "qdrant",
      "chunking_strategy": "platform_documentation",
      "token_count": 844,
      "character_count": 3240,
      "created_at": "2025-10-16T17:42:31.999769",
      "parent_context": null,
      "semantic_type": "qdrant",
      "collection_name": "Qdrant",
      "subfolder_name": "qdrant_qdrant",
      "collection_strategy": "platform_documentation",
      "chunk_index_in_file": 6,
      "file_relative_path": "Qdrant\\qdrant_qdrant\\_qdrant_qdrant_7.1-raft-consensus-protocol.md",
      "collection_context": "Qdrant/qdrant_qdrant"
    }
  },
  {
    "text": "- [Raft Consensus Protocol](#raft-consensus-protocol.md)\n- [Purpose and Scope](#purpose-and-scope.md)\n- [Architecture Overview](#architecture-overview.md)\n- [Consensus Thread Lifecycle](#consensus-thread-lifecycle.md)\n- [Operation Types and Flow](#operation-types-and-flow.md)\n- [Bootstrapping and Peer Management](#bootstrapping-and-peer-management.md)\n- [First Peer (Origin Peer)](#first-peer-origin-peer.md)\n- [Adding a New Peer](#adding-a-new-peer.md)\n- [Message Processing and Raft Loop](#message-processing-and-raft-loop.md)\n- [Message Types](#message-types.md)\n- [Main Loop Structure](#main-loop-structure.md)\n- [Processing Ready State](#processing-ready-state.md)\n- [Sending Messages to Peers](#sending-messages-to-peers.md)\n- [WAL and State Persistence](#wal-and-state-persistence.md)\n- [Persistent Storage Structure](#persistent-storage-structure.md)\n- [Configuration](#configuration.md)\n- [Internal gRPC API](#internal-grpc-api.md)\n- [Cluster Metadata Storage](#cluster-metadata-storage.md)\n- [High Priority Thread](#high-priority-thread.md)\n- [Monitoring and Health](#monitoring-and-health.md)\n- [Cluster Status API](#cluster-status-api.md)\n- [Health Tracking](#health-tracking.md)",
    "metadata": {
      "chunk_id": 7,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\Qdrant\\qdrant_qdrant\\_qdrant_qdrant_7.1-raft-consensus-protocol.md",
      "input_type": "qdrant",
      "chunking_strategy": "platform_documentation",
      "token_count": 296,
      "character_count": 1193,
      "created_at": "2025-10-16T17:42:31.999882",
      "parent_context": null,
      "semantic_type": "qdrant",
      "collection_name": "Qdrant",
      "subfolder_name": "qdrant_qdrant",
      "collection_strategy": "platform_documentation",
      "chunk_index_in_file": 7,
      "file_relative_path": "Qdrant\\qdrant_qdrant\\_qdrant_qdrant_7.1-raft-consensus-protocol.md",
      "collection_context": "Qdrant/qdrant_qdrant"
    }
  }
]