[
  {
    "text": "Index Selection and Storage Backends | qdrant/qdrant | DeepWiki\n\n[Index your code with Devin](private-repo.md)\n\n[DeepWiki](https://deepwiki.com)\n\n[DeepWiki](.md)\n\n[qdrant/qdrant](https://github.com/qdrant/qdrant \"Open repository\")\n\n[Index your code with](private-repo.md)\n\n[Devin](private-repo.md)\n\nShare\n\nLast indexed: 4 October 2025 ([48203e](https://github.com/qdrant/qdrant/commits/48203e41))\n\n- [Introduction to Qdrant](qdrant/qdrant/1-introduction-to-qdrant.md)\n- [Key Concepts and Terminology](qdrant/qdrant/1.1-key-concepts-and-terminology.md)\n- [System Architecture](qdrant/qdrant/2-system-architecture.md)\n- [Application Initialization and Runtime](qdrant/qdrant/2.1-application-initialization-and-runtime.md)\n- [Collections and Table of Content](qdrant/qdrant/2.2-collections-and-table-of-content.md)\n- [Shards and Replica Sets](qdrant/qdrant/2.3-shards-and-replica-sets.md)\n- [Local Shard Architecture](qdrant/qdrant/2.4-local-shard-architecture.md)\n- [Segment Lifecycle and Construction](qdrant/qdrant/2.5-segment-lifecycle-and-construction.md)\n- [Vector Storage and Indexing](qdrant/qdrant/3-vector-storage-and-indexing.md)\n- [Vector Storage Formats](qdrant/qdrant/3.1-vector-storage-formats.md)\n- [HNSW Index Implementation](qdrant/qdrant/3.2-hnsw-index-implementation.md)\n- [Vector Quantization](qdrant/qdrant/3.3-vector-quantization.md)\n- [Sparse Vector Indexing](qdrant/qdrant/3.4-sparse-vector-indexing.md)\n- [Payload Indexing and Filtering](qdrant/qdrant/4-payload-indexing-and-filtering.md)\n- [Field Index Types](qdrant/qdrant/4.1-field-index-types.md)\n- [Index Selection and Storage Backends](qdrant/qdrant/4.2-index-selection-and-storage-backends.md)\n- [Search and Query Processing](qdrant/qdrant/5-search-and-query-processing.md)\n- [Query Request Flow](qdrant/qdrant/5.1-query-request-flow.md)\n- [Filtering and Scoring](qdrant/qdrant/5.2-filtering-and-scoring.md)\n- [Data Updates and Consistency](qdrant/qdrant/6-data-updates-and-consistency.md)\n- [Update Processing Pipeline](qdrant/qdrant/6.1-update-processing-pipeline.md)\n- [Write Consistency and Replication](qdrant/qdrant/6.2-write-consistency-and-replication.md)\n- [Distributed System Features](qdrant/qdrant/7-distributed-system-features.md)\n- [Raft Consensus Protocol](qdrant/qdrant/7.1-raft-consensus-protocol.md)\n- [Shard Transfers and Resharding](qdrant/qdrant/7.2-shard-transfers-and-resharding.md)\n- [Snapshots and Recovery](qdrant/qdrant/8-snapshots-and-recovery.md)\n- [API Reference](qdrant/qdrant/9-api-reference.md)\n- [REST API Endpoints](qdrant/qdrant/9.1-rest-api-endpoints.md)\n- [gRPC API Services](qdrant/qdrant/9.2-grpc-api-services.md)\n- [Data Types and Conversions](qdrant/qdrant/9.3-data-types-and-conversions.md)\n- [Configuration and Deployment](qdrant/qdrant/10-configuration-and-deployment.md)\n- [Configuration System](qdrant/qdrant/10.1-configuration-system.md)\n- [Docker Deployment](qdrant/qdrant/10.2-docker-deployment.md)\n- [Building and CI/CD](qdrant/qdrant/10.3-building-and-cicd.md)\n- [Development Guide](qdrant/qdrant/11-development-guide.md)\n\nMenu\n\n# Index Selection and Storage Backends\n\nRelevant source files",
    "metadata": {
      "chunk_id": 0,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\Qdrant\\qdrant_qdrant\\_qdrant_qdrant_4.2-index-selection-and-storage-backends.md",
      "input_type": "qdrant",
      "chunking_strategy": "platform_documentation",
      "token_count": 956,
      "character_count": 3122,
      "created_at": "2025-10-16T17:42:31.665442",
      "parent_context": null,
      "semantic_type": "qdrant",
      "collection_name": "Qdrant",
      "subfolder_name": "qdrant_qdrant",
      "collection_strategy": "platform_documentation",
      "chunk_index_in_file": 0,
      "file_relative_path": "Qdrant\\qdrant_qdrant\\_qdrant_qdrant_4.2-index-selection-and-storage-backends.md",
      "collection_context": "Qdrant/qdrant_qdrant"
    }
  },
  {
    "text": "- [lib/segment/src/index/field\\_index/field\\_index\\_base.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/field_index/field_index_base.rs)\n- [lib/segment/src/index/field\\_index/full\\_text\\_index/text\\_index.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/field_index/full_text_index/text_index.rs)\n- [lib/segment/src/index/field\\_index/index\\_selector.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/field_index/index_selector.rs)\n- [lib/segment/src/index/plain\\_payload\\_index.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/plain_payload_index.rs)\n- [lib/segment/src/index/struct\\_payload\\_index.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.rs)\n- [lib/segment/src/index/vector\\_index\\_base.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/vector_index_base.rs)\n\n## Purpose and Scope\n\nThis document describes how Qdrant selects appropriate storage backends for payload indices and manages the lifecycle of these indices across different storage types. It covers the `IndexSelector` abstraction, storage backend determination logic, and the migration path from legacy RocksDB indices to newer storage implementations.\n\nFor information about the specific types of payload indices (numeric, keyword, full-text, etc.), see [Field Index Types](qdrant/qdrant/4.1-field-index-types.md). For details on how indices are used during query processing, see [Filtering and Scoring](qdrant/qdrant/5.2-filtering-and-scoring.md).\n\n---\n\n## Storage Backend Overview\n\nQdrant supports three storage backends for payload indices, each optimized for different use cases:\n\n| Backend       | Mutability              | Storage Location                     | Best For                                      |\n| ------------- | ----------------------- | ------------------------------------ | --------------------------------------------- |\n| **RocksDB**   | Appendable or Immutable | Disk with in-memory cache            | Legacy segments, being phased out             |\n| **Mmap**      | Immutable               | Memory-mapped files                  | Non-appendable segments, low memory footprint |\n| **Gridstore** | Appendable              | Gridstore files with in-memory index | New appendable segments, active development   |\n\nThe choice of backend is determined by the segment's mutability requirements and configuration flags. The system is actively migrating away from RocksDB towards Gridstore for appendable segments and Mmap for non-appendable segments.\n\n**Sources:** [lib/segment/src/index/struct\\_payload\\_index.rs46-75](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.rs#L46-L75) [lib/segment/src/index/field\\_index/index\\_selector.rs30-58](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/field_index/index_selector.rs#L30-L58)\n\n---\n\n## StorageType Enum and Selection Logic\n\n### StorageType Variants\n\nThe `StorageType` enum in `StructPayloadIndex` determines which backend to use:\n\n```\n```\n\n**Sources:** [lib/segment/src/index/struct\\_payload\\_index.rs46-75](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.rs#L46-L75) [lib/segment/src/index/struct\\_payload\\_index.rs335-373](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.rs#L335-L373)\n\n### Storage Selection in StructPayloadIndex::open\n\nThe storage backend is selected when opening a `StructPayloadIndex`:\n\n```\n```\n\n**Sources:** [lib/segment/src/index/struct\\_payload\\_index.rs300-445](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.rs#L300-L445)\n\n---\n\n## IndexSelector Abstraction\n\nThe `IndexSelector` enum provides a unified interface for creating different index types across different storage backends. It acts as a factory that produces the appropriate index or builder based on the storage type.\n\n### IndexSelector Variants\n\n```\n```\n\n**Sources:** [lib/segment/src/index/field\\_index/index\\_selector.rs30-58](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/field_index/index_selector.rs#L30-L58)\n\n### Selector Method in StructPayloadIndex",
    "metadata": {
      "chunk_id": 1,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\Qdrant\\qdrant_qdrant\\_qdrant_qdrant_4.2-index-selection-and-storage-backends.md",
      "input_type": "qdrant",
      "chunking_strategy": "platform_documentation",
      "token_count": 1016,
      "character_count": 4268,
      "created_at": "2025-10-16T17:42:31.673940",
      "parent_context": null,
      "semantic_type": "qdrant",
      "collection_name": "Qdrant",
      "subfolder_name": "qdrant_qdrant",
      "collection_strategy": "platform_documentation",
      "chunk_index_in_file": 1,
      "file_relative_path": "Qdrant\\qdrant_qdrant\\_qdrant_qdrant_4.2-index-selection-and-storage-backends.md",
      "collection_context": "Qdrant/qdrant_qdrant"
    }
  },
  {
    "text": "The `selector()` method maps `StorageType` to `IndexSelector`:\n\n```\n```\n\n**Sources:** [lib/segment/src/index/struct\\_payload\\_index.rs682-715](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.rs#L682-L715)\n\n---\n\n## Index Creation and Loading Flow\n\n### Creating New Indices\n\nWhen creating a new index, the flow goes through `build_field_indexes()` which uses the selector to get builders:\n\n```\n```\n\n**Sources:** [lib/segment/src/index/struct\\_payload\\_index.rs447-481](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.rs#L447-L481) [lib/segment/src/index/field\\_index/index\\_selector.rs207-298](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/field_index/index_selector.rs#L207-L298)\n\n### Loading Existing Indices\n\nLoading persisted indices uses `new_index_with_type()` to reconstruct the exact index type:\n\n```\n```\n\n**Sources:** [lib/segment/src/index/struct\\_payload\\_index.rs174-298](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.rs#L174-L298) [lib/segment/src/index/field\\_index/index\\_selector.rs61-148](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/field_index/index_selector.rs#L61-L148)\n\n---\n\n## Backend-Specific Index Implementation\n\nEach index type supports multiple backends through variant enums and builders. Here's how this works for numeric indices as an example:\n\n### FieldIndexBuilder Variants\n\n```\n```\n\n### IndexSelector Backend Routing\n\nThe `IndexSelector` methods route to the appropriate builder based on the selector variant:\n\n```\n```\n\n**Sources:** [lib/segment/src/index/field\\_index/field\\_index\\_base.rs566-603](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/field_index/field_index_base.rs#L566-L603) [lib/segment/src/index/field\\_index/index\\_selector.rs381-411](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/field_index/index_selector.rs#L381-L411)\n\n### Full-Text Index Example\n\nThe `FullTextIndex` enum demonstrates backend support:\n\n```\n```\n\n**Sources:** [lib/segment/src/index/field\\_index/full\\_text\\_index/text\\_index.rs37-93](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/field_index/full_text_index/text_index.rs#L37-L93)\n\n---\n\n## Storage Migration: RocksDB to Gridstore\n\nQdrant is actively migrating from RocksDB to Gridstore/Mmap backends. The migration happens automatically during index loading.\n\n### Migration Trigger and Process\n\n```\n```\n\n**Sources:** [lib/segment/src/index/struct\\_payload\\_index.rs248-281](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.rs#L248-L281)\n\n### Migration Logic Details\n\nThe migration is controlled by feature flags and happens in `load_from_db()`:\n\n1. **Detection**: Check if any loaded indices use RocksDB via `index.is_rocksdb()`\n2. **Flag Check**: Verify `migrate_rocksdb_payload_indices` feature flag is enabled\n3. **Storage Type Update**: Convert `RocksDbAppendable` → `GridstoreAppendable` or `RocksDbNonAppendable` → `GridstoreNonAppendable`\n4. **Config Update**: Set `skip_rocksdb = true` in the persisted config\n5. **Cleanup**: Delete old RocksDB-backed indices\n6. **Rebuild**: Trigger full index rebuild with new storage backend\n7. **Persist**: Save new index types to config\n\n**Sources:** [lib/segment/src/index/struct\\_payload\\_index.rs248-281](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.rs#L248-L281)\n\n### RocksDB Cleanup\n\nAfter migration, if no indices use RocksDB anymore, the database is destroyed:\n\n```\n```\n\n**Sources:** [lib/segment/src/index/struct\\_payload\\_index.rs407-442](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.rs#L407-L442)\n\n---\n\n## File Layout and Directory Structure\n\nEach index type uses a consistent directory naming scheme based on the field name and index type:",
    "metadata": {
      "chunk_id": 2,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\Qdrant\\qdrant_qdrant\\_qdrant_qdrant_4.2-index-selection-and-storage-backends.md",
      "input_type": "qdrant",
      "chunking_strategy": "platform_documentation",
      "token_count": 1024,
      "character_count": 3940,
      "created_at": "2025-10-16T17:42:31.684376",
      "parent_context": null,
      "semantic_type": "qdrant",
      "collection_name": "Qdrant",
      "subfolder_name": "qdrant_qdrant",
      "collection_strategy": "platform_documentation",
      "chunk_index_in_file": 2,
      "file_relative_path": "Qdrant\\qdrant_qdrant\\_qdrant_qdrant_4.2-index-selection-and-storage-backends.md",
      "collection_context": "Qdrant/qdrant_qdrant"
    }
  },
  {
    "text": "### Directory Naming Conventions\n\n| Index Type    | Directory Pattern | Example               |\n| ------------- | ----------------- | --------------------- |\n| Map Index     | `{field}-map`     | `country-map`         |\n| Numeric Index | `{field}-numeric` | `price-numeric`       |\n| Text Index    | `{field}-text`    | `description-text`    |\n| Boolean Index | `{field}-bool`    | `is_active-bool`      |\n| Null Index    | `{field}-null`    | `optional_field-null` |\n\n**Sources:** [lib/segment/src/index/field\\_index/index\\_selector.rs590-608](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/field_index/index_selector.rs#L590-L608)\n\n### FullPayloadIndexType Persistence\n\nThe exact backend and mutability of each index is persisted in `PayloadConfig`:\n\n```\n```\n\n**Sources:** [lib/segment/src/index/field\\_index/field\\_index\\_base.rs481-533](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/field_index/field_index_base.rs#L481-L533) [lib/segment/src/index/payload\\_config.rs](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/payload_config.rs) (implied)\n\n---\n\n## Configuration and Feature Flags\n\n### PayloadConfig Fields\n\nThe `PayloadConfig` persisted at `{segment_path}/payload_index/config.json` contains:\n\n- **`indices`**: Map of field name → `PayloadFieldSchemaWithIndexType`\n  - Includes the field schema and exact index types (with storage backend)\n- **`skip_rocksdb`**: Optional flag to prevent RocksDB usage\n\n### Feature Flags Controlling Backend Selection\n\n| Flag                                 | Purpose                                  | Default                    |\n| ------------------------------------ | ---------------------------------------- | -------------------------- |\n| `payload_index_skip_mutable_rocksdb` | Skip RocksDB for appendable segments     | Determined by build config |\n| `payload_index_skip_rocksdb`         | Skip RocksDB for non-appendable segments | Determined by build config |\n| `migrate_rocksdb_payload_indices`    | Enable automatic migration               | Determined by build config |\n\n**Sources:** [lib/segment/src/index/struct\\_payload\\_index.rs313-331](https://github.com/qdrant/qdrant/blob/48203e41/lib/segment/src/index/struct_payload_index.rs#L313-L331)\n\n---\n\n## Summary\n\nThe index selection and storage backend system in Qdrant provides:\n\n1. **Flexible Backend Selection**: Automatic choice between RocksDB, Mmap, and Gridstore based on segment mutability and configuration\n2. **Abstraction Layer**: `IndexSelector` pattern allows uniform index creation across backends\n3. **Type Persistence**: Full index type information (including backend) is saved in `PayloadConfig`\n4. **Migration Path**: Automatic migration from legacy RocksDB to modern backends\n5. **Per-Field Control**: Different fields can use different backends based on their storage requirements\n\nThe migration from RocksDB to Gridstore/Mmap is a key ongoing optimization, reducing storage overhead and improving performance for both mutable and immutable segments.\n\nDismiss\n\nRefresh this wiki\n\nEnter email to refresh\n\n### On this page",
    "metadata": {
      "chunk_id": 3,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\Qdrant\\qdrant_qdrant\\_qdrant_qdrant_4.2-index-selection-and-storage-backends.md",
      "input_type": "qdrant",
      "chunking_strategy": "platform_documentation",
      "token_count": 703,
      "character_count": 3113,
      "created_at": "2025-10-16T17:42:31.691227",
      "parent_context": null,
      "semantic_type": "qdrant",
      "collection_name": "Qdrant",
      "subfolder_name": "qdrant_qdrant",
      "collection_strategy": "platform_documentation",
      "chunk_index_in_file": 3,
      "file_relative_path": "Qdrant\\qdrant_qdrant\\_qdrant_qdrant_4.2-index-selection-and-storage-backends.md",
      "collection_context": "Qdrant/qdrant_qdrant"
    }
  },
  {
    "text": "- [Index Selection and Storage Backends](#index-selection-and-storage-backends.md)\n- [Purpose and Scope](#purpose-and-scope.md)\n- [Storage Backend Overview](#storage-backend-overview.md)\n- [StorageType Enum and Selection Logic](#storagetype-enum-and-selection-logic.md)\n- [StorageType Variants](#storagetype-variants.md)\n- [Storage Selection in StructPayloadIndex::open](#storage-selection-in-structpayloadindexopen.md)\n- [IndexSelector Abstraction](#indexselector-abstraction.md)\n- [IndexSelector Variants](#indexselector-variants.md)\n- [Selector Method in StructPayloadIndex](#selector-method-in-structpayloadindex.md)\n- [Index Creation and Loading Flow](#index-creation-and-loading-flow.md)\n- [Creating New Indices](#creating-new-indices.md)\n- [Loading Existing Indices](#loading-existing-indices.md)\n- [Backend-Specific Index Implementation](#backend-specific-index-implementation.md)\n- [FieldIndexBuilder Variants](#fieldindexbuilder-variants.md)\n- [IndexSelector Backend Routing](#indexselector-backend-routing.md)\n- [Full-Text Index Example](#full-text-index-example.md)\n- [Storage Migration: RocksDB to Gridstore](#storage-migration-rocksdb-to-gridstore.md)\n- [Migration Trigger and Process](#migration-trigger-and-process.md)\n- [Migration Logic Details](#migration-logic-details.md)\n- [RocksDB Cleanup](#rocksdb-cleanup.md)\n- [File Layout and Directory Structure](#file-layout-and-directory-structure.md)\n- [Directory Naming Conventions](#directory-naming-conventions.md)\n- [FullPayloadIndexType Persistence](#fullpayloadindextype-persistence.md)\n- [Configuration and Feature Flags](#configuration-and-feature-flags.md)\n- [PayloadConfig Fields](#payloadconfig-fields.md)\n- [Feature Flags Controlling Backend Selection](#feature-flags-controlling-backend-selection.md)\n- [Summary](#summary.md)",
    "metadata": {
      "chunk_id": 4,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\Qdrant\\qdrant_qdrant\\_qdrant_qdrant_4.2-index-selection-and-storage-backends.md",
      "input_type": "qdrant",
      "chunking_strategy": "platform_documentation",
      "token_count": 422,
      "character_count": 1801,
      "created_at": "2025-10-16T17:42:31.691464",
      "parent_context": null,
      "semantic_type": "qdrant",
      "collection_name": "Qdrant",
      "subfolder_name": "qdrant_qdrant",
      "collection_strategy": "platform_documentation",
      "chunk_index_in_file": 4,
      "file_relative_path": "Qdrant\\qdrant_qdrant\\_qdrant_qdrant_4.2-index-selection-and-storage-backends.md",
      "collection_context": "Qdrant/qdrant_qdrant"
    }
  }
]