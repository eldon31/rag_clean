[
  {
    "text": "Hybrid Search | qdrant/qdrant-client | DeepWiki\n\n[Index your code with Devin](private-repo.md)\n\n[DeepWiki](https://deepwiki.com)\n\n[DeepWiki](.md)\n\n[qdrant/qdrant-client](https://github.com/qdrant/qdrant-client \"Open repository\")\n\n[Index your code with](private-repo.md)\n\n[Devin](private-repo.md)\n\nShare\n\nLast indexed: 9 July 2025 ([ac6f6c](https://github.com/qdrant/qdrant-client/commits/ac6f6cd2))\n\n- [Overview](qdrant/qdrant-client/1-overview.md)\n- [Client Architecture](qdrant/qdrant-client/2-client-architecture.md)\n- [Client Interface](qdrant/qdrant-client/2.1-client-interface.md)\n- [Local Mode](qdrant/qdrant-client/2.2-local-mode.md)\n- [Remote Mode](qdrant/qdrant-client/2.3-remote-mode.md)\n- [Protocol Handling](qdrant/qdrant-client/2.4-protocol-handling.md)\n- [Core Operations](qdrant/qdrant-client/3-core-operations.md)\n- [Search Operations](qdrant/qdrant-client/3.1-search-operations.md)\n- [Collection Management](qdrant/qdrant-client/3.2-collection-management.md)\n- [Point Operations](qdrant/qdrant-client/3.3-point-operations.md)\n- [Advanced Features](qdrant/qdrant-client/4-advanced-features.md)\n- [FastEmbed Integration](qdrant/qdrant-client/4.1-fastembed-integration.md)\n- [Batch Operations](qdrant/qdrant-client/4.2-batch-operations.md)\n- [Hybrid Search](qdrant/qdrant-client/4.3-hybrid-search.md)\n- [Local Inference](qdrant/qdrant-client/4.4-local-inference.md)\n- [Implementation Details](qdrant/qdrant-client/5-implementation-details.md)\n- [Payload Filtering](qdrant/qdrant-client/5.1-payload-filtering.md)\n- [Type Inspector System](qdrant/qdrant-client/5.2-type-inspector-system.md)\n- [Expression Evaluation](qdrant/qdrant-client/5.3-expression-evaluation.md)\n- [Development & Testing](qdrant/qdrant-client/6-development-and-testing.md)\n- [Project Setup](qdrant/qdrant-client/6.1-project-setup.md)\n- [Testing Framework](qdrant/qdrant-client/6.2-testing-framework.md)\n- [Documentation System](qdrant/qdrant-client/6.3-documentation-system.md)\n\nMenu\n\n# Expression Evaluation\n\nRelevant source files\n\n- [qdrant\\_client/hybrid/\\_\\_init\\_\\_.py](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/__init__.py)\n- [qdrant\\_client/hybrid/fusion.py](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/fusion.py)\n- [qdrant\\_client/hybrid/test\\_reranking.py](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/test_reranking.py)\n\n## Purpose and Scope\n\nThis document details the expression evaluation system in the Qdrant client library. This system provides a powerful way to perform mathematical operations, create custom scoring functions, filter data, and transform values within queries. For information about batch operations, see [Batch Operations](qdrant/qdrant-client/4.2-batch-operations.md), and for local inference capabilities, see [Local Inference](qdrant/qdrant-client/4.4-local-inference.md).\n\n## Overview\n\nThe expression evaluation system allows users to create complex mathematical and logical expressions that can be used in various operations, particularly for custom relevance scoring in hybrid search. Expressions support access to vector similarity scores, payload fields, filtering conditions, and a wide range of mathematical operations.\n\n```\n```\n\nSources: [qdrant\\_client/hybrid/formula.py19-214](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L19-L214) [qdrant\\_client/embed/\\_inspection\\_cache.py1-244](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/embed/_inspection_cache.py#L1-L244)\n\n## Expression Types",
    "metadata": {
      "chunk_id": 0,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\Qdrant\\qdrant_qdrant-client\\_qdrant_qdrant-client_4.3-hybrid-search.md",
      "input_type": "qdrant",
      "chunking_strategy": "platform_documentation",
      "token_count": 1007,
      "character_count": 3573,
      "created_at": "2025-10-16T17:42:32.517156",
      "parent_context": null,
      "semantic_type": "qdrant",
      "collection_name": "Qdrant",
      "subfolder_name": "qdrant_qdrant-client",
      "collection_strategy": "platform_documentation",
      "chunk_index_in_file": 0,
      "file_relative_path": "Qdrant\\qdrant_qdrant-client\\_qdrant_qdrant-client_4.3-hybrid-search.md",
      "collection_context": "Qdrant/qdrant_qdrant-client"
    }
  },
  {
    "text": "The Qdrant client supports a rich set of expression types that can be combined to create complex scoring and filtering logic.\n\n### Basic Expression Types\n\n| Expression Type  | Description               | Example                                                                 |\n| ---------------- | ------------------------- | ----------------------------------------------------------------------- |\n| Constant         | Numeric literals          | `0.5`, `42`                                                             |\n| Variable         | Payload field or score    | `price`, `$score`                                                       |\n| Filter Condition | Boolean condition         | `FieldCondition(key=\"category\", match=MatchValue(value=\"electronics\"))` |\n| Mathematical     | Mathematical operations   | `MultExpression`, `SumExpression`, `DivExpression`                      |\n| Geo              | Geo-distance calculations | `GeoDistance`                                                           |\n| Datetime         | Date/time operations      | `DatetimeExpression`, `DatetimeKeyExpression`                           |\n| Decay            | Decay functions           | `LinDecayExpression`, `ExpDecayExpression`, `GaussDecayExpression`      |\n\n### Mathematical Operations\n\n```\n```\n\nSources: [qdrant\\_client/hybrid/formula.py35-150](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L35-L150) [qdrant\\_client/embed/\\_inspection\\_cache.py245-310](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/embed/_inspection_cache.py#L245-L310)\n\n### Decay Functions\n\nDecay functions are used to transform distances (numeric, geographic, temporal) into relevance scores that decrease with distance from a target value.\n\n```\n```\n\nSources: [qdrant\\_client/hybrid/formula.py186-211](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L186-L211) [qdrant\\_client/embed/\\_inspection\\_cache.py360-444](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/embed/_inspection_cache.py#L360-L444)\n\n## Expression Evaluation Process\n\nThe expression evaluation system recursively processes expressions to produce a final numeric value.\n\n```\n```\n\nSources: [qdrant\\_client/hybrid/formula.py19-214](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L19-L214) [qdrant\\_client/hybrid/formula.py266-298](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L266-L298)\n\n## Using Variables in Expressions\n\n### Payload Fields\n\nAny field from a point's payload can be referenced by its path:\n\n- Simple field: `\"price\"`\n- Nested field: `\"product.details.price\"`\n- Array element: `\"features[0]\"`\n- Array elements: `\"features[]\"`\n\n### Score Variables\n\nScore variables provide access to vector similarity scores:\n\n- `$score` or `$score[0]`: First vector similarity score\n- `$score[1]`: Second vector similarity score (in multi-vector queries)\n- `$score[n]`: Nth vector similarity score\n\n```\n```\n\nSources: [qdrant\\_client/hybrid/formula.py245-298](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L245-L298) [qdrant\\_client/local/payload\\_value\\_extractor.py1-92](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/local/payload_value_extractor.py#L1-L92)\n\n## Filter Expressions\n\nExpressions can include filter conditions that evaluate to 1.0 (true) or 0.0 (false). These conditions support the same rich filtering capabilities as Qdrant's regular filters.\n\n```\n```\n\nSources: [qdrant\\_client/local/payload\\_filters.py165-313](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/local/payload_filters.py#L165-L313) [qdrant\\_client/embed/\\_inspection\\_cache.py573-735](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/embed/_inspection_cache.py#L573-L735)\n\n## Practical Examples\n\n### Example 1: Combining Vector Search with Price Factor\n\n```\n```\n\n### Example 2: Distance-Based Decay Function\n\n```\n```\n\n## Expression Evaluation Implementation\n\nThe core expression evaluation logic resides in the `evaluate_expression` function. This function recursively processes expressions based on their type, handling constants, variables, conditions, and operations.\n\n### Key Components",
    "metadata": {
      "chunk_id": 1,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\Qdrant\\qdrant_qdrant-client\\_qdrant_qdrant-client_4.3-hybrid-search.md",
      "input_type": "qdrant",
      "chunking_strategy": "platform_documentation",
      "token_count": 1010,
      "character_count": 4311,
      "created_at": "2025-10-16T17:42:32.528828",
      "parent_context": null,
      "semantic_type": "qdrant",
      "collection_name": "Qdrant",
      "subfolder_name": "qdrant_qdrant-client",
      "collection_strategy": "platform_documentation",
      "chunk_index_in_file": 1,
      "file_relative_path": "Qdrant\\qdrant_qdrant-client\\_qdrant_qdrant-client_4.3-hybrid-search.md",
      "collection_context": "Qdrant/qdrant_qdrant-client"
    }
  },
  {
    "text": "- **Expression Parser**: Converts expression objects into calculations\n- **Variable Resolver**: Retrieves values from payloads or scores\n- **Condition Evaluator**: Processes filter conditions\n- **Mathematical Evaluator**: Performs mathematical operations\n- **Error Handling**: Handles edge cases like division by zero\n\nSources: [qdrant\\_client/hybrid/formula.py19-214](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L19-L214) [qdrant\\_client/hybrid/formula.py216-242](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L216-L242)\n\n## Expression Safety and Limitations\n\nThe expression evaluation system includes several safety measures:\n\n1. **Non-finite Value Detection**: Functions like `div`, `sqrt`, `pow`, `exp`, `log10`, and `ln` check for non-finite results and raise appropriate errors.\n\n2. **Division by Zero Handling**: The `DivExpression` allows specifying a `by_zero_default` value to handle division by zero gracefully.\n\n3. **Decay Function Validation**: Decay functions validate parameters like `midpoint` (must be between 0 and 1) and `scale` (must be positive).\n\n```\n```\n\nSources: [qdrant\\_client/hybrid/formula.py83-89](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L83-L89) [qdrant\\_client/hybrid/formula.py235-240](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L235-L240)\n\n## Integration with Search and Query Operations\n\nThe expression evaluation system integrates with Qdrant's search functionality through:\n\n1. **Formula Queries**: Apply a scoring formula to search results\n2. **Fusion Queries**: Combine multiple search strategies with custom weights\n\nThese operations leverage the expression evaluation system to compute final relevance scores for returned points.\n\nSources: [qdrant\\_client/hybrid/formula.py19-33](https://github.com/qdrant/qdrant-client/blob/ac6f6cd2/qdrant_client/hybrid/formula.py#L19-L33)\n\n## Conclusion\n\nQdrant's expression evaluation system provides a powerful and flexible way to customize search relevance, perform calculations, and create complex scoring functions. By combining vector similarity with other factors like numerical properties, text matches, and geo-distance, users can create highly tailored search experiences that balance multiple relevance signals.\n\nDismiss\n\nRefresh this wiki\n\nEnter email to refresh\n\n### On this page\n\n- [Expression Evaluation](#expression-evaluation.md)\n- [Purpose and Scope](#purpose-and-scope.md)\n- [Overview](#overview.md)\n- [Expression Types](#expression-types.md)\n- [Basic Expression Types](#basic-expression-types.md)\n- [Mathematical Operations](#mathematical-operations.md)\n- [Decay Functions](#decay-functions.md)\n- [Expression Evaluation Process](#expression-evaluation-process.md)\n- [Using Variables in Expressions](#using-variables-in-expressions.md)\n- [Payload Fields](#payload-fields.md)\n- [Score Variables](#score-variables.md)\n- [Filter Expressions](#filter-expressions.md)\n- [Practical Examples](#practical-examples.md)\n- [Example 1: Combining Vector Search with Price Factor](#example-1-combining-vector-search-with-price-factor.md)\n- [Example 2: Distance-Based Decay Function](#example-2-distance-based-decay-function.md)\n- [Expression Evaluation Implementation](#expression-evaluation-implementation.md)\n- [Key Components](#key-components.md)\n- [Expression Safety and Limitations](#expression-safety-and-limitations.md)\n- [Integration with Search and Query Operations](#integration-with-search-and-query-operations.md)\n- [Conclusion](#conclusion.md)",
    "metadata": {
      "chunk_id": 2,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\Qdrant\\qdrant_qdrant-client\\_qdrant_qdrant-client_4.3-hybrid-search.md",
      "input_type": "qdrant",
      "chunking_strategy": "platform_documentation",
      "token_count": 851,
      "character_count": 3608,
      "created_at": "2025-10-16T17:42:32.533099",
      "parent_context": null,
      "semantic_type": "qdrant",
      "collection_name": "Qdrant",
      "subfolder_name": "qdrant_qdrant-client",
      "collection_strategy": "platform_documentation",
      "chunk_index_in_file": 2,
      "file_relative_path": "Qdrant\\qdrant_qdrant-client\\_qdrant_qdrant-client_4.3-hybrid-search.md",
      "collection_context": "Qdrant/qdrant_qdrant-client"
    }
  }
]