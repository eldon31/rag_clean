[
  {
    "text": "Middleware System | jlowin/fastmcp | DeepWiki\n\n[Index your code with Devin](private-repo.md)\n\n[DeepWiki](https://deepwiki.com)\n\n[DeepWiki](.md)\n\n[jlowin/fastmcp](https://github.com/jlowin/fastmcp \"Open repository\")\n\n[Index your code with](private-repo.md)\n\n[Devin](private-repo.md)\n\nShare\n\nLast indexed: 30 September 2025 ([66221e](https://github.com/jlowin/fastmcp/commits/66221ed3))\n\n- [FastMCP Overview](jlowin/fastmcp/1-fastmcp-overview.md)\n- [Installation and Setup](jlowin/fastmcp/1.1-installation-and-setup.md)\n- [FastMCP Server Core](jlowin/fastmcp/2-fastmcp-server-core.md)\n- [Component System Architecture](jlowin/fastmcp/2.1-component-system-architecture.md)\n- [Context System and Dependencies](jlowin/fastmcp/2.2-context-system-and-dependencies.md)\n- [Server Composition and Proxying](jlowin/fastmcp/2.3-server-composition-and-proxying.md)\n- [FastMCP Client System](jlowin/fastmcp/3-fastmcp-client-system.md)\n- [Transport Mechanisms](jlowin/fastmcp/3.1-transport-mechanisms.md)\n- [Client Authentication](jlowin/fastmcp/3.2-client-authentication.md)\n- [HTTP Server and Deployment](jlowin/fastmcp/4-http-server-and-deployment.md)\n- [Authentication and Security](jlowin/fastmcp/4.1-authentication-and-security.md)\n- [Middleware System](jlowin/fastmcp/4.2-middleware-system.md)\n- [Command Line Interface](jlowin/fastmcp/5-command-line-interface.md)\n- [OpenAPI Integration](jlowin/fastmcp/6-openapi-integration.md)\n- [Configuration Management](jlowin/fastmcp/7-configuration-management.md)\n- [Testing and Development Framework](jlowin/fastmcp/8-testing-and-development-framework.md)\n- [Project Infrastructure](jlowin/fastmcp/9-project-infrastructure.md)\n- [Documentation and Updates](jlowin/fastmcp/10-documentation-and-updates.md)\n\nMenu\n\n# Middleware System\n\nRelevant source files\n\n- [src/fastmcp/cli/install/gemini\\_cli.py](https://github.com/jlowin/fastmcp/blob/66221ed3/src/fastmcp/cli/install/gemini_cli.py)\n- [src/fastmcp/server/middleware/error\\_handling.py](https://github.com/jlowin/fastmcp/blob/66221ed3/src/fastmcp/server/middleware/error_handling.py)\n- [src/fastmcp/server/middleware/logging.py](https://github.com/jlowin/fastmcp/blob/66221ed3/src/fastmcp/server/middleware/logging.py)\n- [src/fastmcp/server/middleware/rate\\_limiting.py](https://github.com/jlowin/fastmcp/blob/66221ed3/src/fastmcp/server/middleware/rate_limiting.py)\n- [src/fastmcp/server/middleware/timing.py](https://github.com/jlowin/fastmcp/blob/66221ed3/src/fastmcp/server/middleware/timing.py)\n- [src/fastmcp/utilities/logging.py](https://github.com/jlowin/fastmcp/blob/66221ed3/src/fastmcp/utilities/logging.py)\n- [tests/server/middleware/test\\_error\\_handling.py](https://github.com/jlowin/fastmcp/blob/66221ed3/tests/server/middleware/test_error_handling.py)\n- [tests/server/middleware/test\\_logging.py](https://github.com/jlowin/fastmcp/blob/66221ed3/tests/server/middleware/test_logging.py)\n- [tests/server/middleware/test\\_timing.py](https://github.com/jlowin/fastmcp/blob/66221ed3/tests/server/middleware/test_timing.py)\n- [tests/utilities/test\\_logging.py](https://github.com/jlowin/fastmcp/blob/66221ed3/tests/utilities/test_logging.py)\n\nThe FastMCP middleware system provides a flexible framework for intercepting, monitoring, and modifying MCP message processing. This system allows developers to add cross-cutting concerns like logging, timing, error handling, and rate limiting without modifying core server logic.\n\nThis document covers the middleware architecture, built-in middleware implementations, and patterns for creating custom middleware. For authentication-specific middleware functionality, see [Authentication and Security](jlowin/fastmcp/4.1-authentication-and-security.md). For HTTP server deployment patterns, see [HTTP Server and Deployment](jlowin/fastmcp/4-http-server-and-deployment.md).",
    "metadata": {
      "chunk_id": 0,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\FAST_DOCS\\jlowin_fastmcp\\_jlowin_fastmcp_4.2-middleware-system.md",
      "input_type": "fast_docs",
      "chunking_strategy": "api_documentation",
      "token_count": 1022,
      "character_count": 3811,
      "created_at": "2025-10-16T17:42:18.993946",
      "parent_context": null,
      "semantic_type": "fast_docs",
      "collection_name": "FAST_DOCS",
      "subfolder_name": "jlowin_fastmcp",
      "collection_strategy": "api_documentation",
      "chunk_index_in_file": 0,
      "file_relative_path": "FAST_DOCS\\jlowin_fastmcp\\_jlowin_fastmcp_4.2-middleware-system.md",
      "collection_context": "FAST_DOCS/jlowin_fastmcp"
    }
  },
  {
    "text": "## Core Middleware Architecture\n\nThe middleware system is built around a pipeline pattern where each middleware can inspect, modify, or handle MCP messages before passing control to the next middleware in the chain.\n\n### Middleware Pipeline Flow\n\n```\n```\n\nSources: [src/fastmcp/server/middleware/middleware.py1-200](https://github.com/jlowin/fastmcp/blob/66221ed3/src/fastmcp/server/middleware/middleware.py#L1-L200) [tests/server/middleware/test\\_logging.py506-775](https://github.com/jlowin/fastmcp/blob/66221ed3/tests/server/middleware/test_logging.py#L506-L775)\n\n### Core Middleware Components\n\n```\n```\n\nSources: [src/fastmcp/server/middleware/middleware.py11-50](https://github.com/jlowin/fastmcp/blob/66221ed3/src/fastmcp/server/middleware/middleware.py#L11-L50)\n\nThe `Middleware` base class provides hook methods for different MCP operations. The `MiddlewareContext[T]` carries message data and metadata through the pipeline, while `CallNext[T, R]` represents the continuation of the middleware chain.\n\n## Built-in Middleware Types\n\nFastMCP includes several production-ready middleware implementations for common server needs.\n\n### Logging Middleware\n\nThe logging system provides two complementary approaches for request monitoring and debugging.\n\n```\n```\n\nSources: [src/fastmcp/server/middleware/logging.py143-196](https://github.com/jlowin/fastmcp/blob/66221ed3/src/fastmcp/server/middleware/logging.py#L143-L196) [src/fastmcp/server/middleware/logging.py198-246](https://github.com/jlowin/fastmcp/blob/66221ed3/src/fastmcp/server/middleware/logging.py#L198-L246)\n\n| Middleware                    | Logger Name          | Output Format   | Use Case                     |\n| ----------------------------- | -------------------- | --------------- | ---------------------------- |\n| `LoggingMiddleware`           | `fastmcp.requests`   | Key-value pairs | Development, human debugging |\n| `StructuredLoggingMiddleware` | `fastmcp.structured` | JSON objects    | Production, log aggregation  |\n\nKey features include payload serialization via `default_serializer()` using `pydantic_core.to_json()`, token estimation at approximately 4 characters per token, and configurable payload truncation via `max_payload_length`.\n\n### Timing and Performance Middleware\n\nPerformance monitoring middleware provides request timing and operation-specific measurements.\n\n```\n```\n\nSources: [src/fastmcp/server/middleware/timing.py10-58](https://github.com/jlowin/fastmcp/blob/66221ed3/src/fastmcp/server/middleware/timing.py#L10-L58) [src/fastmcp/server/middleware/timing.py60-157](https://github.com/jlowin/fastmcp/blob/66221ed3/src/fastmcp/server/middleware/timing.py#L60-L157)\n\nBoth middleware use `time.perf_counter()` for high-precision timing measurements and log results in milliseconds with 2 decimal precision.\n\n### Error Handling and Retry Middleware\n\nError management middleware provides consistent error transformation and automatic retry capabilities.\n\n```\n```\n\nSources: [src/fastmcp/server/middleware/error\\_handling.py15-124](https://github.com/jlowin/fastmcp/blob/66221ed3/src/fastmcp/server/middleware/error_handling.py#L15-L124) [src/fastmcp/server/middleware/error\\_handling.py126-207](https://github.com/jlowin/fastmcp/blob/66221ed3/src/fastmcp/server/middleware/error_handling.py#L126-L207)\n\nThe `ErrorHandlingMiddleware` transforms Python exceptions into MCP-compliant `McpError` instances with appropriate error codes, while `RetryMiddleware` implements exponential backoff retry logic for transient failures.\n\n### Rate Limiting Middleware\n\nRate limiting middleware protects servers from abuse using token bucket and sliding window algorithms.\n\n```\n```\n\nSources: [src/fastmcp/server/middleware/rate\\_limiting.py92-168](https://github.com/jlowin/fastmcp/blob/66221ed3/src/fastmcp/server/middleware/rate_limiting.py#L92-L168) [src/fastmcp/server/middleware/rate\\_limiting.py170-232](https://github.com/jlowin/fastmcp/blob/66221ed3/src/fastmcp/server/middleware/rate_limiting.py#L170-L232)\n\nBoth implementations support per-client rate limiting via `get_client_id` functions and use `asyncio.Lock()` for thread-safe operation.\n\n## Custom Middleware Development\n\nCreating custom middleware involves extending the `Middleware` base class and implementing the appropriate hook methods.\n\n### Middleware Hook Methods",
    "metadata": {
      "chunk_id": 1,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\FAST_DOCS\\jlowin_fastmcp\\_jlowin_fastmcp_4.2-middleware-system.md",
      "input_type": "fast_docs",
      "chunking_strategy": "api_documentation",
      "token_count": 980,
      "character_count": 4317,
      "created_at": "2025-10-16T17:42:19.001271",
      "parent_context": null,
      "semantic_type": "fast_docs",
      "collection_name": "FAST_DOCS",
      "subfolder_name": "jlowin_fastmcp",
      "collection_strategy": "api_documentation",
      "chunk_index_in_file": 1,
      "file_relative_path": "FAST_DOCS\\jlowin_fastmcp\\_jlowin_fastmcp_4.2-middleware-system.md",
      "collection_context": "FAST_DOCS/jlowin_fastmcp"
    }
  },
  {
    "text": "| Hook Method          | Trigger               | Context Type          | Use Case                          |\n| -------------------- | --------------------- | --------------------- | --------------------------------- |\n| `on_message()`       | All messages          | Generic               | Universal logging, authentication |\n| `on_request()`       | Request messages      | Generic               | Timing, rate limiting             |\n| `on_notification()`  | Notification messages | Generic               | Event tracking                    |\n| `on_call_tool()`     | Tool execution        | `CallToolRequest`     | Tool-specific logic               |\n| `on_read_resource()` | Resource access       | `ReadResourceRequest` | Resource security                 |\n| `on_get_prompt()`    | Prompt retrieval      | `GetPromptRequest`    | Prompt customization              |\n\nSources: [src/fastmcp/server/middleware/middleware.py11-200](https://github.com/jlowin/fastmcp/blob/66221ed3/src/fastmcp/server/middleware/middleware.py#L11-L200)\n\n### Custom Middleware Example Pattern\n\n```\n```\n\nSources: [tests/server/middleware/test\\_logging.py110-141](https://github.com/jlowin/fastmcp/blob/66221ed3/tests/server/middleware/test_logging.py#L110-L141) [tests/server/middleware/test\\_timing.py47-70](https://github.com/jlowin/fastmcp/blob/66221ed3/tests/server/middleware/test_timing.py#L47-L70)\n\nCustom middleware should call `await call_next(context)` to continue the pipeline and can modify the context or result before/after the call.\n\n## Integration with FastMCP Server\n\nMiddleware integration occurs through the `FastMCP.add_middleware()` method, which builds the middleware pipeline in registration order.\n\n### Middleware Registration and Execution\n\n```\n```\n\nSources: [tests/server/middleware/test\\_logging.py543-575](https://github.com/jlowin/fastmcp/blob/66221ed3/tests/server/middleware/test_logging.py#L543-L575) [tests/server/middleware/test\\_timing.py192-224](https://github.com/jlowin/fastmcp/blob/66221ed3/tests/server/middleware/test_timing.py#L192-L224)\n\nMiddleware executes in the order registered, forming a chain where each middleware can inspect, modify, or terminate request processing. The system supports both synchronous and asynchronous middleware operations through the `CallNext` continuation pattern.\n\n## Middleware Configuration Patterns\n\nProduction deployments typically combine multiple middleware types for comprehensive server monitoring and protection.\n\n### Common Middleware Stack Configuration\n\n```\n```\n\nSources: [tests/server/middleware/test\\_error\\_handling.py589-624](https://github.com/jlowin/fastmcp/blob/66221ed3/tests/server/middleware/test_error_handling.py#L589-L624) [tests/server/middleware/test\\_logging.py710-744](https://github.com/jlowin/fastmcp/blob/66221ed3/tests/server/middleware/test_logging.py#L710-L744)\n\nThis ordering ensures that rate limiting occurs first to protect server resources, followed by comprehensive monitoring and error handling capabilities. The middleware system's flexibility allows for custom combinations based on specific deployment requirements.\n\nDismiss\n\nRefresh this wiki\n\nEnter email to refresh\n\n### On this page\n\n- [Middleware System](#middleware-system.md)\n- [Core Middleware Architecture](#core-middleware-architecture.md)\n- [Middleware Pipeline Flow](#middleware-pipeline-flow.md)\n- [Core Middleware Components](#core-middleware-components.md)\n- [Built-in Middleware Types](#built-in-middleware-types.md)\n- [Logging Middleware](#logging-middleware.md)\n- [Timing and Performance Middleware](#timing-and-performance-middleware.md)\n- [Error Handling and Retry Middleware](#error-handling-and-retry-middleware.md)\n- [Rate Limiting Middleware](#rate-limiting-middleware.md)\n- [Custom Middleware Development](#custom-middleware-development.md)\n- [Middleware Hook Methods](#middleware-hook-methods.md)\n- [Custom Middleware Example Pattern](#custom-middleware-example-pattern.md)\n- [Integration with FastMCP Server](#integration-with-fastmcp-server.md)\n- [Middleware Registration and Execution](#middleware-registration-and-execution.md)\n- [Middleware Configuration Patterns](#middleware-configuration-patterns.md)\n- [Common Middleware Stack Configuration](#common-middleware-stack-configuration.md)",
    "metadata": {
      "chunk_id": 2,
      "source_file": "C:\\Users\\raze0\\Documents\\LLM_KNOWLEDGE_CREATOR\\RAG\\RAG_CLEAN\\Docs\\FAST_DOCS\\jlowin_fastmcp\\_jlowin_fastmcp_4.2-middleware-system.md",
      "input_type": "fast_docs",
      "chunking_strategy": "api_documentation",
      "token_count": 893,
      "character_count": 4269,
      "created_at": "2025-10-16T17:42:19.006133",
      "parent_context": null,
      "semantic_type": "fast_docs",
      "collection_name": "FAST_DOCS",
      "subfolder_name": "jlowin_fastmcp",
      "collection_strategy": "api_documentation",
      "chunk_index_in_file": 2,
      "file_relative_path": "FAST_DOCS\\jlowin_fastmcp\\_jlowin_fastmcp_4.2-middleware-system.md",
      "collection_context": "FAST_DOCS/jlowin_fastmcp"
    }
  }
]