# Requirements Traceability Matrix

## Story: 1.4 - Finalize Default-On Performance & Observability Baselines

### Coverage Summary

- Total Requirements: 5
- Fully Covered: 3 (60%)
- Partially Covered: 2 (40%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: Capture default-on staging baselines with latency and VRAM evidence recorded in docs/qa/assessments/1.4-baselines-20251025.md and referenced from docs/architecture/observability.md

Coverage: FULL

Given-When-Then Mappings:

- **Manual Evidence**: `docs/qa/assessments/1.4-baselines-20251025.md`

  - Given: the default-on pipeline executed 50 staging runs with metrics emission enabled
  - When: baseline results are archived (latency tables, GPU VRAM summary, Grafana ASCII exports at `docs/qa/assets/`)
  - Then: P50/P95 latency, VRAM peaks, and alert validation thresholds are documented and referenced from `docs/architecture/observability.md`
  - Coverage: manual evidence

- **Unit Test**: `tests/test_processing_summary.py::test_processing_summary_includes_performance_baseline`

  - Given: telemetry-enabled processing summaries with GPU snapshots
  - When: `build_processing_summary` constructs the `performance_baseline`
  - Then: the serialized data matches the evidence schema consumed by the assessment file
  - Coverage: unit

- **Unit Test**: `tests/test_processing_summary.py::test_performance_baseline_flags_soft_limit_exceedance`
  - Given: telemetry inputs that cross the soft limit
  - When: baseline calculations run
  - Then: soft-limit exceedances are surfaced for QA follow-up, matching WARN/CRIT documentation
  - Coverage: unit

#### AC2: Deliver GPU peak alerting end to end with Prometheus rules, routed documentation, and regression coverage asserting WARN/CRIT thresholds

Coverage: PARTIAL

Given-When-Then Mappings:

- **Manual Evidence (planned)**: `docs/qa/assessments/1.4-baselines-20251025.md` (Alert Validation Results)

  - Given: Alert thresholds and routing are defined with target values
  - When: CPU fallback runs execute, telemetry confirms rules are wired but not exercised on GPU
  - Then: Documentation outlines WARN/CRIT scenarios awaiting staging replay
  - Coverage: documentation

- **Manual Evidence**: `docs/telemetry/rerank_sparse_signals.md` (GPU Alert Configuration & Routing)

  - Given: runbook captures rule definitions, routing targets, and response procedures
  - When: operators reference the runbook post-alert
  - Then: alerting becomes actionable with governance controls
  - Coverage: documentation

- **Outstanding Evidence**: Staging GPU runs that exercise WARN/CRIT thresholds are still pending; Prometheus validator currently operates in mock mode with TLS verification disabled.

  - Action: Capture staging metrics snapshots and validator JSON with verification enabled to transition this AC to FULL coverage.

- **Unit Test**: `tests/test_telemetry_smoke.py::TestGpuAlertThresholds::test_gpu_alert_warning_threshold_detection`

  - Given: GPU peaks above 11.5 GB
  - When: `check_gpu_alert_threshold` executes
  - Then: warning level detection returns correctly
  - Coverage: unit

- **Unit Test**: `tests/test_telemetry_smoke.py::TestGpuAlertThresholds::test_gpu_alert_critical_threshold_detection`

  - Given: GPU peaks above 12 GB
  - When: alert threshold helper runs
  - Then: critical threshold detection is triggered
  - Coverage: unit

- **Unit Test**: `tests/test_telemetry_smoke.py::TestPrometheusMetricsEmitter::test_emitter_emits_gpu_peak_metric`
  - Given: metrics emitter enabled with stage labels
  - When: GPU peak metric recorded
  - Then: payload populates Prometheus rule inputs
  - Coverage: unit

#### AC3: Expand sparse fallback regression coverage for degraded inputs and document CLI flag synonyms in scripts/embed_collections_v6.py and docs/telemetry/rerank_sparse_signals.md

Coverage: FULL

Given-When-Then Mappings:

- **Unit Test**: `tests/test_sparse_generator.py::TestSparseFallbackCoverage::test_sparse_fallback_degraded_inputs` (and related cases)

  - Given: degraded chunk scenarios (empty, ultra-short, special characters)
  - When: sparse fallback logic executes
  - Then: coverage ratios, fallback reasons, and telemetry outputs match documentation
  - Coverage: unit

- **Unit Test**: `tests/test_embed_collections_cli.py::test_parse_arguments_enable_sparse_flag`

  - Given: CLI defaults disable sparse
  - When: `--enable-sparse` flag provided
  - Then: CLI provenance marks the enable source as `cli`, satisfying synonym acceptance criteria
  - Coverage: unit

- **Unit Test**: `tests/test_embed_collections_cli.py::test_parse_arguments_enable_and_disable_conflict_precedence`

  - Given: operator passes both enable and disable flags
  - When: arguments parsed
  - Then: disable precedence ensures safe rollback behavior and provenance tracked
  - Coverage: unit

- **Documentation Evidence**: `docs/telemetry/rerank_sparse_signals.md` (CLI Toggle Flags section)
  - Given: operators consult runbook
  - When: toggles need to be enabled/disabled or synonyms referenced
  - Then: documentation mirrors CLI help text, keeping operational guidance aligned
  - Coverage: documentation

#### AC4: Execute CLI plus telemetry smoke matrix across rerank/sparse combinations and archive artifacts in docs/qa/assessments/1.4-telemetry-smoke-20251025.md

Coverage: FULL

Given-When-Then Mappings:

- **Manual Evidence**: `docs/qa/assessments/1.4-telemetry-smoke-20251025.md`

  - Given: five CLI executions (defaults, disable rerank, disable sparse, disable both, explicit enable)
  - When: outputs archived under `docs/qa/assessments/1.4-telemetry-smoke-evidence/`
  - Then: CLI logs and five processing summaries verify spans, metrics, and toggle provenance for every combination
  - Coverage: manual evidence

- **Unit Test**: `tests/test_telemetry_smoke.py::TestProcessingSummaryWithMetrics::test_summary_includes_rerank_and_sparse_metrics_when_enabled`

  - Given: both stages enabled with metrics emitted
  - When: processing summary built
  - Then: rerank/sparse telemetry entries align with archived JSON evidence
  - Coverage: unit

- **Unit Test**: `tests/test_telemetry_smoke.py::TestProcessingSummaryWithMetrics::test_summary_omits_rerank_and_sparse_sections_when_disabled`
  - Given: both stages disabled via toggles
  - When: summary generated
  - Then: skip reasons recorded consistent with CLI disable scenarios
  - Coverage: unit

#### AC5: Fulfill Sprint Change Proposal checkpoints and update QA gates 1.1–1.3 to PASS with linked evidence

Coverage: PARTIAL

Given-When-Then Mappings:

- **Manual Evidence (documentation)**: `docs/qa/gates/1.1-default-on-configuration-wiring.yml` through `1.3-telemetry-monitoring-baseline-updates.yml`

  - Given: Epic 1 gates were reopened pending Story 1.4 consolidation
  - When: Story 1.4 delivered telemetry artifacts and documentation updates
  - Then: gate files reference evidence locations and remain at PASS subject to outstanding staging deliverables
  - Coverage: documentation (pending validation refresh)

- **Manual Evidence**: `docs/qa/reports/2025-10-25-sprint-change-proposal.md`

  - Given: change proposal enumerates gates to update post Story 1.4
  - When: evidence delivered in CPU fallback mode
  - Then: proposal checklist links to assessments; security/TLS staging validation tracked as follow-up actions
  - Coverage: documentation

- **Outstanding Evidence**: QA gate 1.4 remains at CONCERNS while staging TLS and GPU baselines are pending; once evidence is produced, gates 1.1–1.3 should be revalidated to confirm references remain accurate.

### Critical Gaps

1. Staging validation for Prometheus authentication/TLS remains pending (tracked as NFR follow-up).
2. GPU latency and VRAM baselines require staging runs to confirm alert thresholds under load.
3. Telemetry smoke evidence is still manually generated; automation would further reduce drift risk.

### Test Design Recommendations

1. Add CI automation that executes the CLI toggle matrix and publishes fresh processing summaries into `docs/qa/assessments/1.4-telemetry-smoke-evidence/`.
2. Integrate contract-style tests (or replay fixtures) that assert Prometheus alert rules fire at 11.5 GB/12 GB thresholds without relying solely on manual staging runs.
3. Add a lint step ensuring QA gate files reference existing artifact paths to prevent future governance drift.

### Risk Assessment

- **Medium Risk:** Deferred staging validation for security controls; mitigation plan documented in `1.4-security-controls-20251025.md`.
- **Low Risk:** Evidence freshness (telemetry smoke) depends on manual regeneration; automation recommended.
- **Low Risk:** Documentation/test alignment currently strong; continue monitoring as new toggles are added.
