# Requirements Traceability Matrix

## Story: 3.1 – Build CrossEncoder Executor

### Coverage Summary

- Total Requirements: 3
- Fully Covered: 1 (33%)
- Partially Covered: 0 (0%)
- Not Covered: 2 (67%)

### Requirement Mappings

#### AC1: Executor dynamically sizes batches to avoid 12 GB OOM and logs leasing events

- **Coverage:** NONE
- **Given:** Executor integrated into `search_with_reranking`.
- **When:** A query returns candidate chunk IDs such as `[512, 87, 4, …]`.
- **Then:** `search_with_reranking` should emit reranked results and lease telemetry without raising.
  - **Bug:** `processor/ultimate_embedder/core.py` line ~1244 indexes `candidate_indices[int(cand_id)]`, which raises `IndexError` for any chunk id ≥ number of initial candidates (typical in production). The executor path therefore crashes before telemetry can log, so AC1 behaviour is unreachable.
  - No automated test exercises this integration path; unit tests stub candidate ids as sequential strings so the defect remains undetected.

#### AC2: Unit tests simulate multi-GPU leases and OOM recovery paths

- **Coverage:** FULL
- **Given:** CrossEncoder `predict` raises `OutOfMemoryError`.
- **When:** `_execute_rerank_with_retry` invoked.
- **Then:** Batch halves and retries up to limit.
  - `tests/test_cross_encoder_executor.py::test_oom_recovery_halves_batch_size`
  - `tests/test_cross_encoder_executor.py::test_oom_recovery_max_retries_raises_exception`

#### AC3: Executor returns ranked results plus telemetry payload for downstream use

- **Coverage:** NONE
- **Bug:** Because the executor path throws prior to building results, downstream telemetry/export never observes `CrossEncoderRerankRun`. No integration or summary test asserts payload propagation.

### Critical Gaps

1. **AC1 wiring to pipeline**
   - Gap: No integration test verifying lease telemetry on real pipeline run.
   - Severity: High
   - Suggested Test: `tests/test_batch_runner.py::test_rerank_executor_integration` to assert telemetry events.
2. **AC3 telemetry/export**
   - Gap: No trace that summary/export receives executor payload.
   - Severity: High
   - Suggested Test: Integration with `summary.build_rerank_stage_summary` verifying `CrossEncoderRerankRun` fields.

### Test Design Alignment

- Refer to `docs/qa/assessments/3.1-test-design-20251029.md` for planned scenarios.

Trace matrix: docs/qa/assessments/3.1-trace-20251029.md
