# Requirements Traceability Matrix

## Story: 1.1 - Default-On Configuration Wiring

### Coverage Summary
- Total Requirements: 5
- Fully Covered: 0 (0%)
- Partially Covered: 0 (0%)
- Not Covered: 5 (100%)

### Requirement Mappings

#### AC1: Configuration defaults enable rerank and sparse while honoring override switches
**Coverage: NONE**

Given-When-Then Mappings:
- *Gap:* No automated test exercises `load_feature_toggles` defaults.
  - **Given** a clean environment with no override files
  - **When** `load_feature_toggles()` resolves feature toggles
  - **Then** `enable_rerank` and `enable_sparse` return `True` and `sparse_models` seeds with the default list
- *Gap:* No test asserts environment/config overrides remain authoritative.
  - **Given** overrides for `EMBEDDER_ENABLE_RERANK=false` and `EMBEDDER_ENABLE_SPARSE=false`
  - **When** toggles load from layered env plus config
  - **Then** rerank and sparse deactivate while provenance reports `env` as the winning source

#### AC2: Unit tests cover default-on behavior and explicit opt-out paths
**Coverage: NONE**

Given-When-Then Mappings:
- *Gap:* No unit suite validates CLI argument hydration.
  - **Given** CLI parsing with no explicit `--disable` flags
  - **When** `parse_arguments()` runs
  - **Then** the returned namespace surfaces `enable_rerank=True` and `enable_sparse=True`
- *Gap:* No unit scenario flips opt-out switches.
  - **Given** CLI execution with `--disable-rerank` / `--disable-sparse`
  - **When** arguments hydrate `UltimateKaggleEmbedderV4`
  - **Then** rerank and sparse stages skip initialization paths without raising

#### AC3: Documentation highlights default settings and disable instructions
**Coverage: NONE**

Given-When-Then Mappings:
- *Gap:* No documentation check or content test exists.
  - **Given** docs build or lint pipeline
  - **When** validating configuration reference pages
  - **Then** default-on behavior and rollback toggles appear in generated output

#### Telemetry: Default-on runs emit rerank and sparse telemetry including `processing_summary.json`
**Coverage: NONE**

Given-When-Then Mappings:
- *Gap:* No integration or snapshot test inspects telemetry payloads.
  - **Given** an end-to-end embed run with defaults
  - **When** the pipeline completes
  - **Then** `processing_summary.json` and telemetry streams contain `rerank_run` and `sparse_run` blocks with non-empty metrics

#### CLI Visibility: Runtime summaries surface rerank/sparse activation and opt-out guidance
**Coverage: NONE**

Given-When-Then Mappings:
- *Gap:* No functional test inspects CLI summary output.
  - **Given** default-on execution of `embed_collections_v6.py`
  - **When** the script logs its run summary
  - **Then** the console and JSON output document rerank/sparse activation status and flag usage cues

### Critical Gaps
1. **Feature toggle defaults lack regression tests** — High risk of silent regressions when refactoring configuration layers.
2. **Opt-out rollback paths unverified** — High risk that emergency disablement fails under real deployments.
3. **Telemetry contract untested** — Medium risk that downstream analytics miss rerank/sparse signals.
4. **Documentation drift** — Medium risk operators receive stale guidance about defaults and toggles.

### Test Design Recommendations
1. Add focused unit tests for `load_feature_toggles` covering default, env-file, and live `os.environ` precedence.
2. Extend CLI parser tests asserting rerank/sparse flag hydration and opt-out behavior, including provenance reporting.
3. Create an integration smoke test running `UltimateKaggleEmbedderV4` against fixture chunks to snapshot `processing_summary.json` telemetry blocks.
4. Introduce a docs CI check (or markdown doctest) verifying configuration sections reference default-on behavior and disable procedures.

### Risk Assessment
- **High Risk:** AC1, AC2 due to absence of safeguards around critical configuration paths.
- **Medium Risk:** Telemetry, CLI visibility, and documentation drift affecting observability and operator guidance.
- **Low Risk:** None identified until foundational coverage exists.

Trace matrix: docs/qa/assessments/1.1-trace-20251023.md
