# Risk Profile: Story 3.1

Date: 2025-10-29
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 3
- Critical Risks: 1
- High Risks: 1
- Risk Score: 65/100 (100 - 20×critical - 10×high - 5×medium)
- Key Driver: `search_with_reranking` now calls the executor, but result mapping indexes chunk IDs as list positions so any non-sequential candidate (e.g., id 512) crashes the pipeline before telemetry or scoring completes.

## Critical Risks Requiring Immediate Attention

### 1. TECH-002: Executor result mapping crashes search

**Score:** 9 (Critical)

- **Probability (High / 3):** Candidate ids reflect real chunk positions (0…N); most queries produce ids larger than the number of initial candidates, immediately triggering `IndexError` at `core.py:1244`.
- **Impact (High / 3):** Rerank path fails hard, so AC1/AC3 behaviour plus OOM safeguards never execute. Search regresses versus prior build.
- **Mitigation:**
  - Treat candidate ids as chunk identifiers, not list offsets; map via dictionary or direct int conversion.
  - Add regression covering mixed-order candidate ids to prevent recurrence.
- **Testing Focus:** Integration test exercising `search_with_reranking` where the best chunk id is ≥100 to verify results and telemetry.
- **Owner:** dev
- **Timeline:** Must fix before acceptance.

## Risk Distribution

### By Category

- Technical: 1 (1 critical)
- Performance: 1 (0 critical)
- Operational: 1 (0 critical)

### By Component

- Pipeline orchestration: 1
- Batch sizing heuristic: 1
- Test infrastructure: 1

## Detailed Risk Register

| Risk ID  | Category    | Description                                                                                            | Probability | Impact     | Score | Priority | Mitigation & Actions                                                                                                                                                  | Testing Requirements                                                                                                     | Owner | Timeline        |
| -------- | ----------- | ------------------------------------------------------------------------------------------------------ | ----------- | ---------- | ----- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------ | ----- | --------------- |
| TECH-002 | technical   | `search_with_reranking` indexes `candidate_indices[int(cand_id)]`, exploding for chunk id ≥ len(list). | High (3)    | High (3)   | 9     | Critical | Map candidate ids directly to chunk indices (e.g., `int(cand_id)` or dict lookup) and assert against non-numeric ids; add regression with sparse candidate numbering. | End-to-end rerank test covering candidate ids [512, 87, 4] to ensure executor outputs feed downstream telemetry/export.  | dev   | Before sign-off |
| OPS-001  | operational | No integration test covering GPU lease lifecycle with executor + telemetry.                            | Medium (2)  | High (3)   | 6     | High     | Add integration suite that spins executor with mocked lease + telemetry and asserts emitters fire; hook test into CI.                                                 | Integration test verifying telemetry hooks, lease acquire/release, and export payload alignment with story requirements. | dev   | Before release  |
| PERF-001 | performance | Memory-per-pair heuristic fixed at 50 MB; may over/under allocate on other models.                     | Medium (2)  | Medium (2) | 4     | Medium   | Calibrate heuristic using model metadata (hidden size / dtype); expose override in config; capture telemetry to tune values per model once pipeline is stable.        | Parameterized unit test using representative configs; perf regression capturing VRAM vs batch size vs latency.           | dev   | Next sprint     |

## Risk-Based Testing Strategy

1. **Priority 1 (Critical / High Risks)**
   - Execute end-to-end rerank workflow exercising executor wiring with non-sequential candidate ids.
   - Validate telemetry stream includes lease acquire/release events and `CrossEncoderRerankRun` payloads.
2. **Priority 2 (Medium Risks)**
   - Parameterize `_calculate_optimal_batch_size` against multiple models and GPU configs.
   - Measure VRAM usage vs heuristic to tune safety factors.
3. **Priority 3 (Residual Risks)**
   - Regression test CPU-only deployments to confirm fallback continues working.

## Risk Acceptance Criteria

- All critical (score 9) risks must be resolved prior to hand-off.
- High (score 6) operational risk requires mitigation plan plus automated test coverage before deployment.
- Medium risks can ship with monitoring if product owner signs off.

## Monitoring Requirements

- Capture lease telemetry in production and alert when executor lease events are missing while rerank is enabled.
- Track VRAM utilization vs batch size to detect heuristic drift.
- Monitor rerank latency histogram to ensure CPU fallback is not silently engaged in GPU environments.

## Risk Review Triggers

- Executor integration fixes merged.
- Updates to rerank model catalog (new CrossEncoder variants) affecting memory footprint.
- Telemetry gaps detected or GPU leasing errors spiking in logs.

Risk profile: docs/qa/assessments/3.1-risk-20251029.md
