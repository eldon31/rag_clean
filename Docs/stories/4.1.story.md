<!-- Powered by BMAD™ Core -->

# Story 4.1: Document Current Ensemble Flow

## Status

Done

## Story

**As a** future maintainer,
**I want** a canonical document describing the actual ensemble execution path,
**so that** upcoming modifications reference real behavior rather than assumptions.

## Acceptance Criteria

1. Documentation outlines end-to-end flow (CLI → embedder → leasing → adaptive control → fusion) with diagrams mirroring code.
2. Cross-references include `batch_runner.py`, `gpu_lease.py`, and related controllers.
3. Document lives in repo docs (e.g., `docs/architecture/ensemble-flow.md`) and links from PRD or runbooks.

## Tasks / Subtasks

- [x] Audit ensemble orchestration to map stage sequencing, data handoffs, and control flow (AC: 1) [Source: architecture/component-architecture.md#component-interaction-diagram]
  - [x] Trace CLI entry through embedder setup, runtime configuration, and toggle precedence to anchor the narrative (AC: 1) [Source: architecture/enhancement-scope-and-integration-strategy.md#integration-approach]
  - [x] Validate dense, sparse, fusion, rerank, and export stage ordering plus telemetry capture so diagrams mirror actual behavior (AC: 1) [Source: architecture/component-architecture.md#updated-components]
  - [x] Highlight adaptive control and GPU leasing touch points that gate rerank execution for later documentation callouts (AC: 1) [Source: architecture/infrastructure-and-deployment.md#gpu-and-cpu-usage-modes]
- [x] Gather authoritative references for `batch_runner.py`, `gpu_lease.py`, and controller modules to satisfy cross-link requirements (AC: 2) [Source: architecture/source-tree.md#existing-project-structure-relevant-extract]
  - [x] Summarize GPU leasing lifecycle and VRAM safeguards that keep rerank within limits for inclusion in the doc (AC: 2) [Source: architecture/operational-safeguards.md#core-dependency-matrix]
  - [x] Capture controller responsibilities (ModelManager, BatchRunner, telemetry helpers) for inline citations (AC: 2) [Source: architecture/component-architecture.md#updated-components]
  - [x] Collect evidence snippets (CLI summaries, processing summaries) demonstrating telemetry fields the doc should reference (AC: 2) [Source: architecture/observability.md#cli-summary-output]
- [x] Author `docs/architecture/ensemble-flow.md` with diagrams and link integrations (AC: 1, 3) [Source: architecture/infrastructure-and-deployment.md#runtime-outputs-and-storage-order]
  - [x] Produce a mermaid diagram (or equivalent) showing CLI → embedder → leasing → adaptive control → fusion → rerank → export aligned with implementation (AC: 1) [Source: architecture/component-architecture.md#component-interaction-diagram]
  - [x] Document cross references to `batch_runner.py`, `gpu_lease.py`, `model_manager.py`, and telemetry helpers in context (AC: 2) [Source: architecture/source-tree.md#existing-project-structure-relevant-extract]
  - [x] Register the new document in `docs/architecture/index.md` (and other navigation surfaces if applicable) so maintainers can find it easily (AC: 3) [Source: architecture/index.md]
  - [x] Link the new document from `docs/prd/epic-4-export-schema-regression-hardening-and-ensemble-documentation.md` and the telemetry runbook to meet documentation surfacing expectations (AC: 3) [Source: docs/prd/epic-4-export-schema-regression-hardening-and-ensemble-documentation.md#story-4-1-document-current-ensemble-flow]
  - [x] Attach supporting evidence or references in `docs/qa/` if diagrams include derived metrics or log excerpts, using a folder such as `docs/qa/assessments/4.1-ensemble-flow/` with timestamped filenames for consistency (AC: 3) [Source: architecture/observability.md#telemetry-smoke-validation]

## Dev Notes

### Previous Story Insights

- Rerank telemetry, Prometheus metrics, and CLI surfaces already expose latency, GPU peak, fallback counters, and toggle provenance that the documentation can quote directly. [Source: docs/stories/3.3.story.md#dev-notes]
- Stage integration from CLI through rerank and exports is confirmed with regression coverage; reuse those insights when describing execution order. [Source: docs/stories/3.2.story.md#dev-notes]

### Documentation Scope

- Epic 4 calls for a canonical ensemble-flow document so future changes align with real execution rather than assumptions; this story delivers that artifact. [Source: docs/prd/epic-4-export-schema-regression-hardening-and-ensemble-documentation.md#story-4-1-document-current-ensemble-flow]

### Data Flow Outline

- The pipeline flows from `embed_collections_v6.py` into `UltimateKaggleEmbedderV4`, stages dense inference, sparse generation, result fusion, CrossEncoder rerank, and export runtime while emitting telemetry at each stage. [Source: architecture/component-architecture.md#component-interaction-diagram]
- Execution order and responsibilities across BatchRunner, CrossEncoderBatchExecutor, SparseVectorGenerator, and ExportRuntime should be summarized in the new document. [Source: architecture/component-architecture.md#updated-components]

### GPU Leasing and Adaptive Control

- GPU leasing ensures rerank batches respect the 12 GB ceiling by hydrating models on demand and adjusting batch sizes; the documentation should emphasize these safeguards. [Source: architecture/enhancement-scope-and-integration-strategy.md#integration-approach]
- Operational safeguards outline environment variables and toggle-first rollback procedures that the doc should reference for completeness. [Source: architecture/operational-safeguards.md#brownfield-rollback-and-contingency-plan]

### Runtime Configuration and Toggles

- Default-on behavior for rerank and sparse stages with CLI/env overrides must be described so maintainers understand control points. [Source: docs/stories/1.2.story.md#dev-notes; architecture/operational-safeguards.md#brownfield-rollback-and-contingency-plan]

### Data Models

- `CrossEncoderRerankRun` captures rerank telemetry, GPU usage, and ranked outputs; documenting how this payload surfaces across processing summaries and exports prevents gaps. [Source: architecture/data-models-and-schema-changes.md#crossencoderrerankrun]
- `SparseInferenceRun` metadata explains sparse coverage signals that should be touched when outlining the ensemble flow. [Source: architecture/data-models-and-schema-changes.md#sparseinferencerun]

### Observability Signals

- OpenTelemetry spans, Prometheus metrics, and CLI summary expectations provide concrete data the doc can cite while illustrating stage health. [Source: architecture/observability.md#opentelemetry-spans]
- The telemetry runbook already lists metric definitions and alert thresholds; link or summarize the rerank/sparse metrics for context. [Source: docs/telemetry/rerank_sparse_signals.md#metric-definitions]

### File Locations

- Core orchestration modules live under `processor/ultimate_embedder/` (batch runner, core, gpu_lease, model_manager, telemetry), while the CLI entry sits in `scripts/embed_collections_v6.py`; use these paths when embedding references. [Source: architecture/source-tree.md#existing-project-structure-relevant-extract]

### Testing Requirements

- Integration tests and telemetry smoke suites provide evidence for sequence accuracy; consider pointing to them when validating the documentation. [Source: architecture/testing-and-validation.md#integration-tests]

### Technical Constraints

- Maintain awareness of the 12 GB VRAM ceiling and performance baselines when describing adaptive control and leasing behavior so expectations remain clear. [Source: architecture/operational-safeguards.md#core-dependency-matrix]
- Include latency and GPU baselines that operators monitor for rerank and sparse stages. [Source: architecture/observability.md#performance-baselines]

### Security / Privacy

- Telemetry and exports truncate or anonymize sensitive query data; reiterate these safeguards when describing observability outputs. [Source: architecture/security-considerations.md#security-considerations]

### Project Structure Notes

- Place new documentation inside `docs/architecture/` and align file naming with existing guidance to keep the knowledge base organized. [Source: architecture/source-tree.md#existing-project-structure-relevant-extract]

### Edge Cases / Fallbacks

- Highlight fallback scenarios (feature toggles, OOM, runtime failures) so maintainers understand how the flow degrades gracefully. [Source: architecture/operational-safeguards.md#brownfield-rollback-and-contingency-plan]

### Testing

- Follow repository pytest standards (`pytest` runner, fixtures in `tests/conftest.py`) and keep new assertions in existing telemetry suites such as `tests/test_processing_summary.py` and `tests/test_telemetry_smoke.py`. [Source: architecture/testing-and-validation.md#testing-and-validation]
- Capture operator-facing evidence from CLI runs under `docs/qa/assessments/4.1-ensemble-flow/` with timestamped filenames for traceability. [Source: architecture/observability.md#telemetry-smoke-validation]
- `poetry run python scripts/embed_collections_v6.py --collections <sample> --limit 25` to capture live CLI summaries that back the documentation narrative. [Source: architecture/infrastructure-and-deployment.md#kaggle-notebook-workflow]
- `poetry run pytest tests/test_processing_summary.py -k rerank` to confirm telemetry payloads referenced in the doc remain accurate. [Source: architecture/testing-and-validation.md#integration-tests]
- `poetry run pytest tests/test_telemetry_smoke.py::TestTelemetrySpansWithMetrics::test_rerank_span_active_includes_metrics_status` to gather evidence of span coverage for illustrative examples. [Source: architecture/testing-and-validation.md#integration-tests]

## Change Log

| Date       | Version | Description                                         | Author |
| ---------- | ------- | --------------------------------------------------- | ------ |
| 2025-10-30 | 0.1     | Initial draft prepared for ensemble doc work        | Bob    |
| 2025-10-30 | 0.2     | Ensemble flow documentation authored & tests        | James  |
| 2025-10-30 | 1.1     | Status updated to Ready for Done after QA gate PASS | James  |

## Dev Agent Record

### Agent Model Used

GitHub Copilot (GPT-5-Codex)

### Debug Log References

- 2025-10-30 08:06 UTC: `python -m pytest tests/test_processing_summary.py -k
rerank` → 3 passed (14 deselected)
- 2025-10-30 08:16 UTC: `python -m pytest
tests/test_telemetry_smoke.py::TestTelemetrySpansWithMetrics::test_rerank_span_active_includes_metrics_status`
  → 1 passed

### Completion Notes List

- Authored `docs/architecture/ensemble-flow.md` with a mermaid diagram walking
  CLI entry through leasing, adaptive batching, sparse, rerank, export, and
  telemetry touchpoints.
- Linked the ensemble-flow document from the architecture index, Story 4.1 PRD,
  and the rerank/sparse telemetry runbook to satisfy surfacing requirements.
- Captured QA evidence in
  `docs/qa/assessments/4.1-ensemble-flow/validation-20251030.md` documenting
  documentation scope and rerank telemetry test runs.

### File List

- docs/architecture/ensemble-flow.md (new canonical ensemble flow documentation
  with diagram and references)
- docs/architecture/index.md (add navigation link to ensemble flow doc)
- docs/prd/epic-4-export-schema-regression-hardening-and-ensemble-documentation.md
  (reference new document in Story 4.1 deliverables)
- docs/telemetry/rerank_sparse_signals.md (link runbook to ensemble flow
  document)
- docs/qa/assessments/4.1-ensemble-flow/validation-20251030.md (QA evidence and
  test results)
- docs/stories/4.1.story.md (status, tasks, records, and change log updates)

## QA Results

- **Gate**: PASS — Canonical ensemble flow documentation aligns with implementation and satisfies AC1-AC3.
- **Evidence**: `docs/architecture/ensemble-flow.md`, cross-links in PRD/runbook, and QA package `docs/qa/assessments/4.1-ensemble-flow/validation-20251030.md` with passing telemetry tests.
- **Risks**: None identified; monitor for future pipeline changes that alter stage ordering or telemetry contracts.
- **Gate Record**: `docs/qa/gates/4.1-document-current-ensemble-flow.yml` (expires 2025-11-13).
