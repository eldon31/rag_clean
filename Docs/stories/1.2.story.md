# Story 1.2: CLI and Runtime Toggle Integration

## Status

Done

## Story

**As a** CLI operator,
**I want** the command-line interface and runtime logging to reflect the default-on rerank/sparse behavior,
**so that** executions surface clear status and allow opt-outs for exceptional runs.

## Acceptance Criteria

1. `embed_collections_v6.py` exposes parameters that document default-on behavior and allow disabling rerank/sparse.
2. Run summaries/logs show rerank and sparse activation states and devices used.
3. Telemetry control-plane entries confirm defaults were applied, with regression tests verifying dense-only parity when disabled.

## Tasks / Subtasks

- [x] Add/verify CLI flags in `scripts/embed_collections_v6.py` for enabling/disabling rerank & sparse (`--disable-rerank`, `--disable-sparse`, plus any explicit enable flags if required for parity) and ensure help text clarifies defaults (AC: 1) [Source: architecture/component-architecture.md#updated-components]
  - [x] Ensure environment variable overrides (`EMBEDDER_ENABLE_RERANK`, `EMBEDDER_ENABLE_SPARSE`) are surfaced in CLI help or runtime provenance logs (AC: 1) [Source: architecture/operational-safeguards.md#brownfield-rollback-and-contingency-plan]
  - [x] Confirm feature toggle resolution order (env vars -> CLI flags -> config) is logged at run start (AC: 2) [Source: architecture/enhancement-scope-and-integration-strategy.md#compatibility-requirements]
- [x] Enhance runtime summary output to list: rerank enabled state, sparse enabled state, models used, device allocation (GPU indices) (AC: 2) [Source: architecture/component-architecture.md#component-interaction-diagram]
  - [x] Include GPU peak usage per stage if already instrumented, otherwise placeholder with note (AC: 2) [Source: architecture/observability.md#observability]
  - [x] Show fallback indicators when sparse inference reverts to metadata (AC: 2) [Source: architecture/component-architecture.md#updated-components]
- [x] Integrate/log telemetry span IDs or stage presence confirmations (`rag.rerank`, `rag.sparse`) in run summary footer (AC: 3) [Source: architecture/observability.md#observability]
  - [x] Emit Prometheus counters/histograms for rerank & sparse latency if metrics layer initialized; log whether metrics emission succeeded (AC: 3) [Source: architecture/observability.md#observability]
  - [x] Add regression tests asserting dense-only parity when flags disable stages (AC: 3) [Source: architecture/testing-and-validation.md#integration-tests]
- [x] Update processing summary exporter to include activation provenance lines referencing defaults vs overrides (AC: 3) [Source: architecture/data-models-and-schema-changes.md#schema-integration-strategy]
  - [x] Test manifest `v4.1` includes `rerank_run`/`sparse_run` when active and omits them when disabled (AC: 3) [Source: architecture/data-models-and-schema-changes.md#schema-integration-strategy]
- [x] Unit tests for CLI parser covering: default-on state, disable flags, precedence with env vars (AC: 1,3) [Source: architecture/testing-and-validation.md#unit-tests]
  - [x] Performance test stub ensures enabling toggles does not exceed 12 GB VRAM; if absent add TODO marker (AC: 2 indirectly) [Source: architecture/enhancement-scope-and-integration-strategy.md#performance-impact]

## Dev Notes

### Previous Story Insights

- Story 1.1 established default-on toggle plumbing and validated opt-out overrides with tests ensuring `EMBEDDER_ENABLE_RERANK` and `EMBEDDER_ENABLE_SPARSE` drive rollback without dense regressions. This story must surface those toggles clearly in CLI UX and summaries. [Source: docs/stories/1.1.story.md]

### Data Models

- `CrossEncoderRerankRun` provides batch rerank telemetry fields (`batch_size`, `scores`, `gpu_peak_gb`, `latency_ms`) that should appear in summaries when rerank active. [Source: architecture/data-models-and-schema-changes.md#crossencoderrerankrun]
- `SparseInferenceRun` indicates `fallback_used` and latency; CLI runtime summary should reflect these states. [Source: architecture/data-models-and-schema-changes.md#sparseinferencerun]
- Manifest version `v4.1` adds optional `rerank_run` and `sparse_run`; dense-only parity confirmed by absence when disabled. [Source: architecture/data-models-and-schema-changes.md#schema-integration-strategy]

### API Specifications

- CLI interface (`embed_collections_v6.py`) includes flags for rerank/sparse activation and should display per-stage latency, batch sizes, GPU peak usage. [Source: architecture/component-architecture.md#updated-components]
- Telemetry spans names: `rag.rerank`, `rag.sparse`; presence implies defaults applied. [Source: architecture/observability.md#observability]

### Component Specifications

- `UltimateKaggleEmbedderV4` loads CrossEncoder & sparse models when enabled; CLI must indicate loaded model identifiers and device placement. [Source: architecture/component-architecture.md#updated-components]
- `BatchRunner` executes sparse before export and rerank after fusion; summary should reflect ordering and statuses. [Source: architecture/component-architecture.md#updated-components]
- `ExportRuntime` writes `rerank_run`/`sparse_run` sections; integration tests validate conditional emission. [Source: architecture/component-architecture.md#updated-components]
- `CrossEncoderBatchExecutor` handles dynamic batch sizing; summary can surface chosen batch size for transparency. [Source: architecture/component-architecture.md#new-components]

### File Locations

- Primary CLI file: `scripts/embed_collections_v6.py` for parser & summary logic. [Source: architecture/source-tree.md#existing-project-structure-relevant-extract]
- Telemetry spans module: `processor/ultimate_embedder/telemetry.py` for span IDs and metrics emission. [Source: architecture/source-tree.md#existing-project-structure-relevant-extract]
- Rerank pipeline modules: `processor/ultimate_embedder/rerank_pipeline.py`, `cross_encoder_executor.py` (if added). [Source: architecture/source-tree.md#new-file-organization-additions-only]
- Sparse pipeline modules: `processor/ultimate_embedder/sparse_pipeline.py`, `sparse_generator.py`. [Source: architecture/source-tree.md#new-file-organization-additions-only]

### Testing Requirements

- Unit tests: CLI parser covering enable/disable precedence, telemetry logging triggers. [Source: architecture/testing-and-validation.md#unit-tests]
- Integration tests: End-to-end run verifying manifest conditional sections and summary content for enabled vs disabled states. [Source: architecture/testing-and-validation.md#integration-tests]
- Performance tests: Validate rerank latency & sparse throughput remain under resource limits; at minimum assert VRAM metrics captured. [Source: architecture/testing-and-validation.md#performance-tests]

### Technical Constraints

- Must respect 12 GB GPU ceiling; no batch sizing changes that violate memory limits. [Source: architecture/enhancement-scope-and-integration-strategy.md#performance-impact]
- CLI UX changes must remain additive preserving previous output ordering format. [Source: architecture/enhancement-scope-and-integration-strategy.md#compatibility-requirements]
- Opt-out flags required for rollback safety. [Source: architecture/operational-safeguards.md#brownfield-rollback-and-contingency-plan]

### Security / Privacy

- Rerank `query` field must remain truncated/anonymized in displayed summaries; avoid exposing raw query text if privacy policy restricts. [Source: architecture/data-models-and-schema-changes.md#crossencoderrerankrun]

### Observability Integration

- Spans: `rag.rerank`, `rag.sparse`; metrics: `rag_rerank_latency_seconds`, `rag_sparse_latency_seconds`, `rag_gpu_peak_bytes{stage="rerank"}`. Summaries should confirm emission or provide reason if skipped. [Source: architecture/observability.md#observability]

### Project Structure Notes

- Story adds only CLI and summary enhancements; no new modules unless existing separation insufficient for summary logic (favor existing `embed_collections_v6.py`). Structure alignment consistent with source tree plan. [Source: architecture/source-tree.md#existing-project-structure-relevant-extract]

### Edge Cases / Fallbacks

- Disabled flags with defaults on: ensure summary explicitly states "rerank: disabled via flag" even if env var enabled earlier in precedence chain.
- Sparse fallback scenario: if `fallback_used=true`, summary should mark sparse inference as "fallback (metadata)" rather than "live".
- Single-GPU vs multi-GPU: device list may differ; ensure summary gracefully handles single device case.

### Testing

- Apply unit, integration, and performance coverage for CLI toggle visibility & parity checks. [Source: architecture/testing-and-validation.md#testing-and-validation]

## Change Log

| Date       | Version | Description                                                                                                      | Author             |
| ---------- | ------- | ---------------------------------------------------------------------------------------------------------------- | ------------------ |
| 2025-10-24 | 0.1     | Initial draft for CLI and runtime toggle integration story                                                       | Bob                |
| 2025-10-24 | 0.2     | Added GPU soft-limit alert telemetry guard and regression coverage                                               | James              |
| 2025-10-26 | 1.0     | Status updated to Ready for Review - Story 1.4 consolidation verified complete with gate PASS (quality score 98) | James (dev-claude) |
| 2025-10-31 | 1.1     | QA fix: aligned CLI help sparse default with runtime config and added regression guard                           | James              |
| 2025-10-31 | 1.2     | Addressed sparse provenance, refreshed runbook default, added doc guard regression                               | James              |
| 2025-10-31 | 1.3     | QA gate PASS recorded; story closed after provenance/doc fixes                                                   | James              |

## Dev Agent Record

### Agent Model Used

- GitHub Copilot (GPT-5-Codex)
- James (dev-claude) – Claude Sonnet 4.5

### Debug Log References

- 2025-10-31: `python -m pytest tests/test_embed_collections_cli.py` → 16 passed
- 2025-10-31: `python -m pytest tests/test_processing_summary.py` → 25 passed
- `py -3 -m pytest`
- `C:/Python313/python.exe -m pytest`
- 2025-10-26: `python -m pytest --tb=short -q` → 85 passed

### Completion Notes

- Patched disable-sparse to mark sparse_models provenance as cli:disable-sparse-trim.
- Added runbook guard enforcing the splade default and refreshed the help excerpt.
- Updated CLI help epilog to surface FeatureToggleConfig sparse defaults and added regression locking help output.
- CLI toggle help now documents default-on behavior and env overrides.
- Added startup logging for toggle resolution chain including CLI overrides.
- Collection completion summary now surfaces rerank/sparse device allocation, fallback reasoning, and provenance placeholders.
- Telemetry spans and metrics emission status now populate processing summaries and CLI summaries with reason-coded fallbacks.
- Added regression coverage ensuring disabled rerank/sparse runs omit stage sections from processing summaries.
- Processing stats exporter now mirrors activation provenance lines so downstream consumers see default vs override context.
- Added regression asserting processing stats export serializes activation provenance metadata when stages disabled.
- Added GPU soft-limit alert telemetry guard plus regression coverage enforcing alert emission.
- Story 1.4 Consolidation (2025-10-26): Verified completion of delegated observability artifacts. QA gate updated to PASS with quality score 98. All evidence artifacts validated and archived. Status updated to Ready for Review.

### File List

- scripts/embed_collections_v6.py
- docs/telemetry/rerank_sparse_signals.md
- processor/ultimate_embedder/core.py
- processor/ultimate_embedder/model_manager.py
- processor/ultimate_embedder/summary.py
- processor/ultimate_embedder/telemetry.py
- processor/ultimate_embedder/export_runtime.py
- tests/test_processing_summary.py
- tests/test_embed_collections_cli.py

## QA Results

| Category                             | Status | Issues                                               |
| ------------------------------------ | ------ | ---------------------------------------------------- |
| 1. Goal & Context Clarity            | PASS   | Clear role/action/benefit; ACs map to tasks          |
| 2. Technical Implementation Guidance | PASS   | Key files & components cited with sources            |
| 3. Reference Effectiveness           | PASS   | Source references granular; previous story leveraged |
| 4. Self-Containment Assessment       | PASS   | Core details embedded; edge cases enumerated         |
| 5. Testing Guidance                  | PASS   | Unit/integration/performance scopes defined          |

Final Assessment: READY

Summary: Story provides sufficient, source-cited guidance for a dev agent to implement CLI & runtime toggle integration without further doc traversal. No blocking gaps identified. GPU soft-limit guardrails now verified through targeted telemetry tests, clearing the prior performance concern.

### Risk Profile (Story 1.2)

| Risk                                                                   | Prob | Impact | Exposure | Mitigations (Preventive & Detective)                                                                          | Residual Risk | Test Coverage                                                                             | Owner                |
| ---------------------------------------------------------------------- | ---- | ------ | -------- | ------------------------------------------------------------------------------------------------------------- | ------------- | ----------------------------------------------------------------------------------------- | -------------------- |
| Toggle precedence misresolution (env vs CLI vs config)                 | M    | H      | High     | Log resolved order at start; unit tests for precedence matrix; doc help text clarifies defaults               | Low-M         | Unit (parser), Integration (start log)                                                    | CLI/Embed Maintainer |
| GPU memory overrun (>12GB) with default-on rerank+sparse               | M    | H      | High     | Batch sizing guard; telemetry GPU peak capture; soft-limit exceedance regression test                         | Low           | `tests/test_processing_summary.py::test_performance_baseline_flags_soft_limit_exceedance` | Perf/Infra           |
| Dense-only parity regression when features disabled                    | L-M  | M-H    | Med-High | Regression test comparing doc ordering & scores; manifest absence checks                                      | Low           | Integration regression suite                                                              | QA/Test              |
| Telemetry emission silent failure (spans/metrics missing)              | M    | M      | Med      | Detect: summary lists emission status; fallback reason logging; counters presence checks                      | Low-M         | Integration (run summary), Observability checks                                           | Observability        |
| Sparse fallback misreported as live inference                          | M    | M      | Med      | Check `fallback_used` flag; summary conditional wording; integration scenario forcing fallback                | Low           | Integration (forced fallback)                                                             | Pipeline             |
| Rerank query privacy leak (untruncated text)                           | L    | H      | Med      | Enforce truncation/anonymization function; unit test for length/pattern; summary uses sanitized field         | Low           | Unit (sanitizer), Spot audit                                                              | Security             |
| Multi-GPU device reporting mismatch (indexes wrong)                    | L-M  | M      | Med      | Validate device enumeration against torch.cuda.device_count; summary lists mapping; unit mock test            | Low           | Unit (device mapping), Integration multi-GPU                                              | Infra                |
| Manifest conditional section mis-emission (`rerank_run` when disabled) | M    | H      | High     | Conditional write guarded by feature flags; integration parity tests (enabled/disabled); schema validation    | Low-M         | Integration (manifest diff), Schema validation                                            | Data Export          |
| Flag naming confusion (`--disable-*` unclear)                          | M    | M      | Med      | Help text explicit: defaults on; maybe add `--enable-*` synonyms for clarity & deprecation note; CLI examples | Low           | Unit (help output), Docs lint                                                             | CLI                  |
| Latency metrics skew due to ordering issues (fallback alters sequence) | L-M  | L-M    | Low-Med  | Capture per-stage timestamps before fallback substitution; assert ordering in tests                           | Low           | Unit (timing capture), Integration (latency ordering)                                     | Observability        |

Risk Scoring Notes:

- Exposure is qualitative combining Probability × Impact; High triggers mandatory logging + test coverage before release.
- Residual risk reflects post-mitigation estimation; any Medium residual requires monitoring item.

Detection Signals & Monitoring:

- Startup log must include: precedence resolution chain, features final states.
- Summary footer: spans presence lines `rag.rerank`, `rag.sparse`; metrics emission status.
- GPU peak usage: ensure non-null when features active; alert if >11.5GB (warning) or >12GB (error).
- Privacy: automated scan (regex) in CI to ensure no raw queries longer than threshold (e.g., 120 chars) appear in summary snapshots.

Open Follow-Ups (Non-Blocking):

- Implement real performance test (replace stub) capturing rerank batch size scaling curve.
- Add enable synonyms if user feedback indicates confusion.
- CI manifest schema validator should assert absence/presence of conditional sections across matrix of flag/env combinations.

Risk Gate Decision: PASS WITH MONITORING (no blocker; require adding GPU peak threshold alert & privacy regex in CI before Story 1.3 close).

### Requirements Traceability (Story 1.2)

| Req ID | Description                                                     | Scenario IDs | Test Types                 | Coverage Status | Notes                                   |
| ------ | --------------------------------------------------------------- | ------------ | -------------------------- | --------------- | --------------------------------------- |
| AC1    | CLI exposes disable flags & documents default-on rerank/sparse  | S1,S2,S3,S4  | Unit, Integration          | Planned         | Help text & precedence clarity          |
| AC2    | Runtime summary shows feature states & devices                  | S5,S6,S7,S8  | Integration, Perf          | Planned         | Includes GPU peak usage placeholder     |
| AC3    | Telemetry confirms defaults; dense-only parity when disabled    | S9,S10,S11   | Integration, Observability | Planned         | Manifest conditional sections validated |
| R1     | Precedence resolution (env vars -> CLI -> config) logged        | S3,S4        | Unit, Integration          | Planned         | Order must match spec                   |
| R2     | Sparse fallback indicator displayed when metadata path used     | S7           | Integration                | Planned         | Uses `fallback_used` field              |
| R3     | GPU memory ceiling (<12GB) respected                            | S8           | Perf                       | Planned         | Threshold warn >11.5GB, error >12GB     |
| R4     | Telemetry spans & metrics emission status reported              | S9,S10       | Observability              | Planned         | Spans: rag.rerank, rag.sparse           |
| R5     | Privacy: rerank query truncated/anonymized                      | S12          | Unit, Security             | Planned         | Regex check length/pattern              |
| R6     | Multi-GPU device allocation reported accurately                 | S13          | Integration                | Planned         | Device list matches actual count        |
| R7     | Manifest conditional presence/absence for rerank_run/sparse_run | S11          | Integration                | Planned         | Absence when disabled                   |
| R8     | Latency ordering preserved (sparse before export, rerank after) | S14          | Integration                | Planned         | Stage sequence assertion                |
| R9     | Help flag naming clarity (disable vs enable synonyms if added)  | S2           | Unit                       | Planned         | Possibly add enable synonyms later      |
| R10    | Batch sizing transparency for rerank stage                      | S15          | Integration                | Planned         | Capture chosen batch size               |

#### Scenario Definitions (GWT)

S1 CLI Flags Default-On Help
Given the CLI operator invokes `embed_collections_v6.py --help`
When the help text is rendered
Then it lists rerank and sparse as default-on and shows `--disable-rerank` and `--disable-sparse` flags
And the description clarifies rollback safety via flags.

S2 Flag Naming Clarity Synonyms (Optional)
Given enable synonym flags are present (if implemented)
When help is shown
Then both disable and enable forms clearly indicate defaults (enable marked as synonym) without ambiguity.

S3 Env Var Overrides Precedence
Given environment variables `EMBEDDER_ENABLE_RERANK=0` and `EMBEDDER_ENABLE_SPARSE=1`
And CLI passes no explicit disable flags
When a run starts
Then the startup log records precedence resolution chain env->CLI->config
And rerank disabled, sparse enabled states match env vars.

S4 CLI Flag Overrides Env Var
Given environment variables `EMBEDDER_ENABLE_RERANK=1`
And CLI passes `--disable-rerank`
When a run starts
Then rerank is disabled via flag
And startup log annotates that CLI flag overrode env var.

S5 Summary Shows Feature States
Given rerank and sparse are enabled by default
When run summary is produced
Then it includes lines: `rerank: enabled`, `sparse: enabled`.

S6 Summary Shows Device Allocation
Given models loaded on GPU indices (e.g., 0,1)
When summary is produced
Then it lists device map and model identifiers for rerank and sparse components.

S7 Sparse Fallback Indicator
Given sparse inference triggers fallback (metadata path)
When summary is produced
Then sparse line shows `sparse: fallback (metadata)` and latency is recorded.

S8 GPU Peak Usage Within Limit
Given a run with typical batch sizes
When telemetry captures GPU peak usage
Then peak usage per stage is <12GB
And if >11.5GB a warning is logged.

S9 Telemetry Spans Presence
Given rerank and sparse are enabled
When run completes
Then summary footer lists spans `rag.rerank` and `rag.sparse` with IDs.

S10 Metrics Emission Status
Given metrics layer initialized
When run completes
Then summary indicates counters/histograms emitted for latency; if not initialized notes skipped emission.

S11 Manifest Conditional Sections
Given rerank disabled and sparse enabled
When manifest v4.1 is written
Then `sparse_run` section exists
And `rerank_run` section is absent.

S12 Rerank Query Privacy
Given queries longer than 200 chars are processed
When summary displays rerank metadata
Then queries are truncated/anonymized below threshold without raw sensitive content.

S13 Multi-GPU Device Reporting Accuracy
Given system has N GPUs
When run summary logs device allocation
Then each stage lists valid GPU indices within [0,N-1] and no duplicates unless intentional sharing noted.

S14 Stage Latency Ordering
Given pipeline executes sparse before export and rerank after fusion
When latencies recorded
Then sparse stage timestamp precedes export
And rerank stage timestamp follows fusion.

S15 Rerank Batch Size Transparency
Given rerank executor adjusts batch size dynamically
When summary is produced
Then rerank section lists `batch_size=<value>` used and any adjustment rationale if applied.

Coverage Plan Notes:

- Unit tests: S1,S3,S4,S12 (parser, resolution, sanitizer)
- Integration tests: S5,S6,S7,S8,S9,S10,S11,S13,S14,S15
- Performance stub: S8 baseline; full test later story 1.3
- Observability checks: S9,S10 integrated with spans/metrics harness.

### NFR Assessment (Story 1.2)

| NFR Domain                | Current Consideration                                                           | Risk Level            | Targets / SLOs                                                                                      | Recommended Actions                                                         | Verification Approach                                                          |
| ------------------------- | ------------------------------------------------------------------------------- | --------------------- | --------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | ------------------------------------------------------------------------------ |
| Performance               | Added rerank + sparse default-on may increase GPU & latency; batch size dynamic | Low                   | Rerank P95 batch latency <500ms; Sparse P95 inference latency <300ms; GPU peak <12GB (warn >11.5GB) | Maintain telemetry capture; backlog alerting once metrics emitter live      | Regression test (`tests/test_processing_summary.py`), telemetry metrics review |
| Reliability               | Deterministic toggle resolution and manifest conditional sections               | Med                   | 99% runs include feature state summary lines; 0 silent feature misactivations                       | Centralize toggle resolver; add negative test (conflict flags/env)          | Unit precedence tests (S3,S4); integration manifest diff (S11)                 |
| Security / Privacy        | Query text must be truncated; no raw sensitive content logged                   | Low-Med (impact high) | 0 privacy violations in CI scans                                                                    | Add sanitizer function test & regex CI check                                | Unit sanitizer test (S12); automated log scan                                  |
| Observability             | Spans & metrics for rerank/sparse; reason-coded absence                         | Med                   | 100% enabled runs produce spans; metrics emission success rate tracked                              | Wrap metrics emission with status logging; device label cardinality control | Integration summary inspection (S9,S10)                                        |
| Usability (CLI UX)        | Clear help & summary readability                                                | Low                   | Help renders defaults & disable flags; summary features within <=25 lines                           | Possibly group summary sections; optionally add column alignment            | Unit help output test (S1); snapshot test of summary (S5,S6)                   |
| Maintainability           | Growth risk in toggle logic                                                     | Low-Med               | Toggle logic <150 LOC; cyclomatic complexity <10                                                    | Refactor into `toggle_resolver.py` if complexity increases                  | Lint complexity check; code review                                             |
| Scalability               | Multi-GPU present; future distributed scaling                                   | Low                   | Accurate device listing across N GPUs; ready for extension                                          | Keep device reporting abstracted; store per-stage device list               | Multi-GPU integration test (S13)                                               |
| Availability / Resilience | CLI run should degrade gracefully if telemetry fails                            | Low-Med               | 0 hard failures due to telemetry absence; fallback messages present                                 | Add try/catch around telemetry emission paths                               | Fault injection test (metrics layer disabled)                                  |

Key NFR Gaps (Non-blocking):

- Lack of concrete latency baseline numbers until instrumentation complete (address in Story 1.3).
- No current automatic GPU threshold alert (planned monitoring addition from Risk Profile).
- Missing fault injection test for telemetry absence (add test harness scenario).

NFR Gate Decision: PASS (alerting backlog tracked separately; telemetry fault injection remains scheduled for follow-up).

### Review Date: 2025-10-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- CLI toggle parsing exposes default-on behavior and logs precedence resolution; covered by `tests/test_embed_collections_cli.py`.
- Processing summaries surface rerank/sparse states, device maps, fallback reasons, and telemetry spans as required by AC2/AC3.
- Feature toggle provenance lines persist in JSON output, maintaining control-plane traceability (`tests/test_processing_summary.py`).
- Full suite (`& C:/Python313/python.exe -m pytest`) passes (13 tests), validating regression coverage.

### Refactoring Performed

- None.

### Compliance Check

- Coding Standards: ✓ – CLI/log updates follow documented conventions without introducing lint issues.
- Project Structure: ✓ – Enhancements stay within existing processor CLI modules.
- Testing Strategy: ✓ – Unit/integration tests aligned to acceptance criteria and run locally.
- All ACs Met: ✓ – AC1-AC3 satisfied via code inspection and test evidence.

### Improvements Checklist

- [ ] Promote GPU peak telemetry into automated alerting once metrics pipeline lands.
- [ ] Expand integration coverage for sparse fallback paths when metadata substitution occurs.
- [ ] Document `--enable-*` flag synonyms in CLI usage docs for operator clarity.

### Security Review

Runtime summaries expose toggle states only; no new sensitive data surfaced. Existing truncation of user content remains unchanged.

### Performance Considerations

Telemetry now captures and asserts GPU soft-limit exceedance detection; automated alerting remains a backlog task tied to the metrics pipeline.

### Files Modified During Review

- None.

### Gate Status

Gate: PASS → docs/qa/gates/1.2-cli-and-runtime-toggle-integration.yml
Risk profile: generated this review (see Risk Profile section)
NFR assessment: generated this review (see NFR Assessment section)

### Recommended Status

[✓ Ready for Done] (Story owner decides final status)

### Review Date: 2025-10-24 (Cycle 2)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Reviewed CLI toggle precedence handling and runtime summary logging in `scripts/embed_collections_v6.py` alongside telemetry assembly in `processor/ultimate_embedder/core.py` and `processor/ultimate_embedder/summary.py`.
- Confirmed manifest/sparse sections and provenance behaviour through `tests/test_processing_summary.py` and CLI precedence coverage in `tests/test_embed_collections_cli.py`.
- Re-ran `& C:/Python313/python.exe -m pytest` (15 passed) to validate the suite remains green.

### Refactoring Performed

- None (QA review only).

### Compliance Check

- Coding Standards: ✓ – Logging and CLI UX updates match documented conventions and naming.
- Project Structure: ✓ – Enhancements stay within existing CLI/processor modules; no structural drift noted.
- Testing Strategy: ✓ – Unit and integration suites exercise defaults-on, opt-out, and provenance paths.
- All ACs Met: ✓ – AC1–AC3 satisfied via inspection plus automated coverage.

### Improvements Checklist

- [ ] Integrate rerank/sparse metrics emission with dashboards and guard against skipped metrics (`docs/qa/assessments/1.2-risk-20251024.md`).
- [ ] Automate GPU soft-limit alerting once telemetry exposes peak usage to Prometheus (`docs/qa/assessments/1.2-nfr-20251024.md`).
- [ ] Add a CLI help snapshot test to preserve the documented default-on messaging.

### Security Review

Runtime summaries continue to redact/anonymise query payloads; no new sensitive fields observed.

### Performance Considerations

GPU peak usage logging is in place, but alerting is still manual—treat as a monitoring follow-up until metrics wiring lands.

### Files Modified During Review

- None.

### Gate Status

Gate: PASS → docs/qa/gates/1.2-cli-and-runtime-toggle-integration.yml  
Risk profile: docs/qa/assessments/1.2-risk-20251024.md  
NFR assessment: docs/qa/assessments/1.2-nfr-20251024.md

### Recommended Status

[Done] – Monitor observability backlog items above.

- 2025-10-25 Quinn (Reopen Assessment):

  **Review Date:** 2025-10-25

  **Reviewed By:** Quinn (Test Architect)

  **Gate Rationale:** Story reopened because downstream observability gaps remain unresolved; we still lack automated GPU peak alerting, sparse fallback regression breadth, and operator documentation for flag synonyms.

  **Improvements Checklist**

  - [ ] Deliver automated GPU peak alerting with regression test coverage.
  - [ ] Expand sparse fallback coverage beyond current happy-path assertions.
  - [ ] Ship CLI docs updates (including flag synonyms) so operators understand the reopened toggles.

  **Gate Status:** Gate set to CHANGES REQUIRED → docs/qa/gates/1.2-cli-and-runtime-toggle-integration.yml

  **Recommended Status:** [✗ Changes Required – observability and documentation follow-ups tracked under Story 1.4]

- 2025-10-26 Quinn (Story 1.4 Consolidation Complete):

  ### Review Date: 2025-10-26

  ### Reviewed By: Quinn (Test Architect)

  ### Consolidation Status

  Story 1.4 completed successfully on 2025-10-25 with all observability artifacts delivered. QA gate `docs/qa/gates/1.2-cli-and-runtime-toggle-integration.yml` updated to PASS with quality score 98. All delegated tasks (automated GPU alerting, expanded sparse fallback coverage, CLI docs with flag synonyms, telemetry smoke matrix) have been verified and archived.

  ### Code Implementation Status

  All Story 1.2 implementation tasks remain complete with tests passing. No code regressions detected. CLI and runtime toggle integration functionality fully operational.

  ### Evidence Verification

  - Automated GPU alerting: Prometheus rules (WARN 11.5GB, CRIT 12GB) documented in `docs/telemetry/rerank_sparse_signals.md`
  - Sparse fallback regression: Comprehensive degraded-input scenarios covered in `tests/test_telemetry_smoke.py`
  - CLI documentation: Flag synonyms (`--enable-rerank`, `--enable-sparse`, `--disable-rerank`, `--disable-sparse`) documented in help text and `docs/telemetry/rerank_sparse_signals.md`
  - Telemetry smoke matrix: 10 artifacts (5 CLI logs + 5 JSON summaries) archived at `docs/qa/assessments/1.4-telemetry-smoke-evidence/`
  - Performance baselines: ASCII charts at `docs/qa/assets/` with staging metrics

  ### Gate Status

  Gate: PASS → docs/qa/gates/1.2-cli-and-runtime-toggle-integration.yml

  Quality Score: 98/100

  All acceptance criteria met with verifiable evidence.

  ### Recommended Status

  [✓ Ready for Review – Story 1.2 code complete, Story 1.4 consolidation verified]

### Review Date: 2025-10-31

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Toggle provenance logging, processing summaries, and telemetry entries remain comprehensive; targeted pytest run (`python -m pytest tests/test_embed_collections_cli.py tests/test_processing_summary.py tests/test_runtime_config.py`) passed locally.
- Identified documentation drift: `scripts/embed_collections_v6.py` still advertises `--sparse-models` default as `qdrant-bm25`, but runtime defaults now resolve to `splade` via `FeatureToggleConfig`. This violates AC1’s requirement that CLI help accurately describe default-on behaviour and can mislead operators about rollback values.

### Refactoring Performed

- None.

### Compliance Check

- Coding Standards: ✓ – Logging and telemetry additions follow existing conventions.
- Project Structure: ✓ – Changes remain scoped to CLI/runtime modules; no structural violations observed.
- Testing Strategy: ✓ – Regression suite continues to cover toggle precedence and summary manifests.
- All ACs Met: ✗ – Update CLI help text to reflect the current sparse default roster.

### Improvements Checklist

- [ ] Update CLI epilog/help in `scripts/embed_collections_v6.py` so the documented sparse default matches `FeatureToggleConfig` (currently `splade`).
- [ ] Add a lightweight unit or snapshot assertion ensuring CLI help strings stay aligned with toggle defaults to prevent future drift.

### Security Review

- No new sensitive data surfaced; rerank query strings remain synthetic and truncated. No additional concerns observed.

### Performance Considerations

- GPU soft-limit telemetry and latency metrics emit as expected; no performance regressions detected.

### Files Modified During Review

- None (QA review only).

### Gate Status

Gate: CONCERNS → docs/qa/gates/1.2-cli-and-runtime-toggle-integration.yml
Risk profile: docs/qa/assessments/1.2-risk-20251031.md
NFR assessment: docs/qa/assessments/1.2-nfr-20251031.md

### Recommended Status

[✗ Changes Required - See unchecked items above]

### Review Date: 2025-10-31 (Provenance Closure)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Verified `--disable-sparse` parsing now records `toggle_sources['sparse_models'] = 'cli:disable-sparse-trim'`, keeping processing summary provenance aligned with CLI overrides.
- Confirmed telemetry runbook help excerpt reflects the live `splade` sparse default and is guarded by regression tests (`test_help_mentions_sparse_default`, `test_runbook_sparse_default_matches_feature_toggle`).
- Executed targeted pytest suite (`python -m pytest tests/test_embed_collections_cli.py tests/test_processing_summary.py tests/test_runtime_config.py`) — 45 tests passed, 1 warning (importlib metadata deprecation).

### Refactoring Performed

- None (QA verification only).

### Compliance Check

- Coding Standards: ✓ – CLI provenance updates and docs remain within style guidelines.
- Project Structure: ✓ – Fixes limited to existing CLI/runtime/doc modules; no structural drift.
- Testing Strategy: ✓ – Regression guards cover disable-sparse provenance and documentation alignment.
- All ACs Met: ✓ – AC1–AC3 satisfied with accurate defaults, provenance, and telemetry evidence.

### Improvements Checklist

- [ ] Continue telemetry dashboard wiring for rerank/sparse metrics (tracked under Story 1.4 follow-ups).

### Security Review

No new sensitive data surfaced; rerank query truncation safeguards unchanged.

### Performance Considerations

Targeted regression run showed stable GPU telemetry and latency metrics; no performance regressions observed.

### Files Modified During Review

- None (QA review only).

### Gate Status

Gate: PASS → docs/qa/gates/1.2-cli-and-runtime-toggle-integration.yml
Risk profile: docs/qa/assessments/1.2-risk-20251031c.md
NFR assessment: docs/qa/assessments/1.2-nfr-20251031c.md

### Recommended Status

[✓ Ready for Done]

### Review Date: 2025-10-31 (Revalidation)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- CLI help epilog now derives the sparse default label from `load_feature_toggles`, so operators see the actual `splade` roster resolved at runtime.
- Added guard test `test_help_mentions_sparse_default` fails if the help output drifts, keeping documentation and defaults aligned.
- Targeted pytest run (`python -m pytest tests/test_embed_collections_cli.py tests/test_processing_summary.py tests/test_runtime_config.py`) passed: 42 tests, 0 failures.

### Refactoring Performed

- None (verification only).

### Compliance Check

- Coding Standards: ✓ – Help text formatting and logging follow CLI conventions.
- Project Structure: ✓ – Updates confined to existing CLI/runtime modules.
- Testing Strategy: ✓ – New unit guard plus regression suites cover the documented defaults.
- All ACs Met: ✓ – AC1 messaging aligns with runtime behaviour; AC2–AC3 remain satisfied via existing evidence.

### Improvements Checklist

- [x] Update CLI epilog/help so the documented sparse default matches runtime resolution (`scripts/embed_collections_v6.py`).
- [x] Add a regression guard ensuring CLI help strings stay aligned with toggle defaults (`tests/test_embed_collections_cli.py::test_help_mentions_sparse_default`).
- [ ] Continue telemetry dashboard wiring to surface rerank/sparse metrics in production (tracked with Story 1.4 follow-ups).

### Security Review

- No new data emitted; help text remains descriptive only. Existing query truncation safeguards unchanged.

### Performance Considerations

- No performance code changes. Prior GPU/latency telemetry remains intact and green in regression results.

### Files Modified During Review

- None (QA verification only).

### Gate Status

Gate: PASS → docs/qa/gates/1.2-cli-and-runtime-toggle-integration.yml
Risk profile: docs/qa/assessments/1.2-risk-20251031.md
NFR assessment: docs/qa/assessments/1.2-nfr-20251031.md

### Recommended Status

[✓ Ready for Done]

### Review Date: 2025-10-31 (Gate Refresh)

### Reviewed By: Quinn (Test Architect)

- Revalidated CLI help defaults against `FeatureToggleConfig` and confirmed processing summary parity artefacts remain current.
- Ran `python -m pytest tests/test_embed_collections_cli.py`, `python -m pytest tests/test_processing_summary.py`, and `python -m pytest tests/test_runtime_config.py` — 42 tests passed, 0 failures.
- No new risks identified; existing telemetry dashboard follow-up stays in future recommendations.

### Gate Status

Gate: PASS → docs/qa/gates/1.2-cli-and-runtime-toggle-integration.yml

### Review Date: 2025-10-31 (Observability QA Sweep)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Toggle logging, processing summary emission, and Prometheus instrumentation remain stable; targeted pytest suite (`python -m pytest tests/test_embed_collections_cli.py tests/test_processing_summary.py tests/test_runtime_config.py`) passed (43 tests).
- Found a provenance gap: when operators launch with `--disable-sparse` (without overriding models) the CLI trims `sparse_models` to `[]` but leaves `toggle_sources['sparse_models'] = 'default'`. Processing summaries therefore mis-report the source as "default" instead of "cli:disable-sparse-trim", obscuring rollback provenance.
- Telemetry runbook snippet in `docs/telemetry/rerank_sparse_signals.md` still advertises `--sparse-models ... (default: qdrant-bm25)`, which no longer matches the runtime `splade` default. AC1 requires documentation to mirror actual defaults.

### Refactoring Performed

- None (read-only QA review).

### Compliance Check

- Coding Standards: ✓ – Logging/tests continue to respect project conventions.
- Project Structure: ✓ – No drift detected; workflow remains within CLI + embedder modules.
- Testing Strategy: ✓ – Regression and unit suites cover toggle precedence, manifest payloads, and runtime config parsing.
- All ACs Met: ✗ – CLI provenance misreport and runbook drift leave AC1/AC3 partially unmet.

### Improvements Checklist

- [ ] Update `scripts/embed_collections_v6.py` so `toggle_sources['sparse_models']` reflects CLI disablement (and add a guard test for `--disable-sparse`).
- [ ] Refresh `docs/telemetry/rerank_sparse_signals.md` help excerpt (and any downstream docs) to show the `splade` default and add CI lint to prevent regression.
- [ ] Consider surfacing provenance source directly in CLI summary output to aid operators during toggled runs.

### Security Review

- No new data exposure; rerank query truncation remains enforced.

### Performance Considerations

- GPU telemetry and latency metrics remain healthy; no additional performance risks identified in this pass.

### Files Modified During Review

- None.

### Gate Status

Gate: CONCERNS → docs/qa/gates/1.2-cli-and-runtime-toggle-integration.yml
Risk profile: docs/qa/assessments/1.2-risk-20251031b.md
NFR assessment: docs/qa/assessments/1.2-nfr-20251031b.md

### Recommended Status

[✗ Changes Required - See unchecked items above]
